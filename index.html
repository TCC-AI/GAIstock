
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAIã€å®¢æˆ¶è¨—æ”¶è¨—é‹ã€‘æš¨ã€åº«å­˜æ°´å¹³ã€‘æ•¸æ“šç®¡ç†ç³»çµ±</title>
    <style>
/* âœ… ä¿®æ”¹å¾Œï¼šæ”¯æ´ä¸Šæ’ 4 å€‹ + ä¸‹æ’ 2 å€‹ */
.dashboard-grid {
    display: grid;
    gap: 20px;
    margin-bottom: 30px;
}

/* ä¸Šæ’ï¼š3 å€‹ KPI + 1 å¼µåœ–ç‰‡ */
.dashboard-grid.top-row {
    grid-template-columns: repeat(4, 1fr);
}

/* ä¸‹æ’ï¼š2 å€‹è­¦å ±å¡ */
.dashboard-grid.bottom-row {
    grid-template-columns: repeat(2, 1fr);
}

/* åœ–ç‰‡å¡ç‰‡æ¨£å¼ */
.image-card {
    background: white;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease;
}

.image-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

.image-card img {
    max-width: 100%;
    width: 220px;
    height: 220px;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.image-card .card-title {
    margin-bottom: 10px;
    text-align: center;
    font-size: 0.95em;
    color: #667eea;
    line-height: 1.4;
}

/* è¶¨å‹¢æ¨™ç±¤æ¨£å¼ */
.trend-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.85em;
    font-weight: 600;
    margin-top: 8px;
}

.trend-up {
    background: #fee;
    color: #c33;
}

.trend-down {
    background: #efe;
    color: #3c3;
}

.trend-neutral {
    background: #f5f5f5;
    color: #666;
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆï¼šå°è¢å¹•æ™‚æ”¹ç‚ºå–®æ¬„ */
@media (max-width: 768px) {
    .dashboard-grid.top-row {
        grid-template-columns: 1fr;
    }
    
    .dashboard-grid.bottom-row {
        grid-template-columns: 1fr;
    }
    
    .image-card img {
        width: 180px;
        height: 180px;
    }
}

/* å¹³æ¿å°ºå¯¸å„ªåŒ– */
@media (min-width: 769px) and (max-width: 1024px) {
    .dashboard-grid.top-row {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .dashboard-grid.bottom-row {
        grid-template-columns: 1fr;
    }
}


        /* è£œå–®ç®¡ç†è¡¨æ ¼æ¨£å¼ */
#replenishmentTable {
    font-size: 0.85em;
    width: 100%;
}

#replenishmentTable th,
#replenishmentTable td {
    padding: 8px 5px;
    white-space: nowrap;
}

#replenishmentTable th {
    position: sticky;
    top: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    z-index: 10;
}

        /* è‡ªè¨‚æ—¥æœŸç¯„åœæ¨£å¼ */
#customDateRange {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
        padding: 0 15px;
    }
    to {
        opacity: 1;
        max-height: 200px;
        padding: 15px;
    }
}

/* æ—¥æœŸè¼¸å…¥æ¡†æ¨£å¼ */
input[type="date"] {
    cursor: pointer;
}

input[type="date"]::-webkit-calendar-picker-indicator {
    cursor: pointer;
    filter: invert(0.5);
}

input[type="date"]:hover::-webkit-calendar-picker-indicator {
    filter: invert(0.3);
}

/* æ—¥æœŸç¯©é¸è³‡è¨Šæ¨£å¼ */
#dateFilterInfo {
    font-weight: 600;
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

        /* ç¯©é¸å™¨æ¨™ç±¤æ¨£å¼ */
.form-group label {
    font-size: 0.9em;
    font-weight: 600;
    color: #374151;
    margin-bottom: 5px;
}

/* ä¸‹æ‹‰é¸å–®æ¨£å¼ */
.form-control {
    transition: all 0.3s ease;
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-control:hover {
    border-color: #9ca3af;
}

/* ç¯©é¸çµ±è¨ˆæ¨£å¼ */
#filteredCount {
    color: #667eea;
    font-weight: bold;
}

#totalCount {
    color: #333;
    font-weight: bold;
}

       #inventoryTable {
    font-size: 0.85em; /* ç¸®å°å­—é«” */
    width: 100%;
    overflow-x: auto; /* æ©«å‘æ»¾å‹• */
}

#inventoryTable th,
#inventoryTable td {
    padding: 8px 5px; /* ç¸®å°å…§è· */
    white-space: nowrap; /* ä¸æ›è¡Œ */
}

.table-container {
    overflow-x: auto; /* ç¢ºä¿å¯ä»¥æ©«å‘æ»¾å‹• */
    max-width: 100%;
}


        /* ä¸»ç³»çµ± Logo æ¨£å¼ */
.header {
    background: linear-gradient(135deg, #7cf2af 0%, #20caf5 100%);
    color: white;
    padding: 20px 30px;
    text-align: center;
    flex-shrink: 0;
    position: relative; /* æ–°å¢é€™è¡Œ */
}
.header-logo {
    position: absolute;
    left: 25px; /* å¾ 30px æ”¹ç‚º 15pxï¼Œè®“å®ƒæ›´é å·¦ */
    top: 50%;
    transform: translateY(-50%);
    width: 80px;
    height: 80px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}


        /* ç™»å…¥ä»‹é¢æ¨£å¼ */
.login-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
}

.login-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    padding: 0;
    width: 560px;
    max-width: 90vw;
    overflow: hidden;
    animation: slideIn 0.5s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.login-header {
    background: linear-gradient(135deg, #7cf2af 0%, #20caf5 100%);
    color: white;
    text-align: center;
    padding: 30px 20px;
    position: relative;
}

.login-logo {
    max-width: 380px;             /* è¨­å®šæœ€å¤§å¯¬åº¦ */
    height: auto;                 /* è‡ªå‹•èª¿æ•´é«˜åº¦ä¿æŒæ¯”ä¾‹ */
    margin-bottom: 5px;
    border-radius: 20px;             /* å®Œå…¨ç§»é™¤åœ“è§’ */
    padding: 0;                   /* ç§»é™¤å…§é‚Šè· */
}



.login-header h2 {
    margin: 0 0 5px 0;
    font-size: 1.5em;
    font-weight: bold;
    text-align: center;
}

.login-body h2 {
    margin: 0 0 20px 0;
    font-size: 1.5em;
    font-weight: bold;
    text-align: center;
    color: #333;
}


.login-header p {
    margin: 0;
    font-size: 0.9em;
    opacity: 0.9;
}

.login-body {
    padding: 40px 30px 30px;
}

.login-body h3 {
    text-align: center;
    color: #333;
    margin-bottom: 30px;
    font-size: 1.3em;
}

.login-btn {
    width: 100%;
    padding: 15px;
    font-size: 1.1em;
    border-radius: 10px;
    margin-top: 20px;
    background: linear-gradient(135deg, #00bcd4 0%, #26c6da 100%);
    border: none;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.login-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(0, 188, 212, 0.3);
}
        .login-btn:active {
    transform: translateY(0);
    background: linear-gradient(135deg, #0097a7 0%, #00acc1 100%); /* æŒ‰ä¸‹æ™‚è®Šæˆæ›´æ·±çš„è—ç¶ è‰² */
    box-shadow: 0 5px 10px rgba(0, 188, 212, 0.2);
    transition: all 0.1s ease; /* æŒ‰ä¸‹æ™‚çš„éæ¸¡æ•ˆæœæ›´å¿« */
}



.login-footer {
    background: #f8f9fa;
    padding: 15px 30px;
    text-align: center;
}

.connection-status {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 0.9em;
    color: #666;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #4caf50;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* æ¬Šé™ç›¸é—œæ¨£å¼ */
.nav-tab.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
    background: #f5f5f5 !important;
}

.btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
    background: #ccc !important;
}

.user-info {
    position: absolute;
    top: 20px;
    right: 30px;
    color: white;
    font-size: 0.9em;
}

.logout-btn {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 5px 15px;
    border-radius: 15px;
    cursor: pointer;
    margin-left: 10px;
    transition: all 0.3s ease;
}

.logout-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* æ¬Šé™è¨Šæ¯æ¨£å¼ */
.permission-message {
    text-align: center;
    padding: 40px 20px;
    color: #666;
    background: #f8f9fa;
    border-radius: 10px;
    margin: 20px;
}

.permission-message h3 {
    color: #ff6b6b;
    margin-bottom: 15px;
}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }
        
        .container {
            max-width: 100vw;
            width: 100%;
            height: 100vh;
            margin: 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        
                
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .status-indicator {
            display: inline-block;
            padding: 5px 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            margin-top: 10px;
        }
        
        .status-indicator.connected {
            background: #4caf50;
        }
        
        .status-indicator.error {
            background: #f44336;
        }
         .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #667eea;
            overflow-x: auto;
            flex-shrink: 0;
        }

        
        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1em;
            transition: all 0.3s ease;
            white-space: nowrap;
            color: #333;
        }
        
        .nav-tab:hover:not(.disabled) {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .nav-tab.active {
            background: white;
            color: #667eea;
            font-weight: bold;
            border-bottom: 3px solid #667eea;
            margin-bottom: -3px;
        }
        
        .content {
            padding: 20px 30px;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .card-title {
            font-size: 1.3em;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .kpi-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        
        .kpi-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .alert-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color: white;
        }
        
        .alert-card .card-title {
            color: white;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(.disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .status-normal {
            background: #d4edda;
            color: #155724;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading.active {
            display: flex;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5em;
            color: #333;
        }
        
        .close-modal {
            float: right;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }
        
        .close-modal:hover {
            color: #333;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .input-group .form-control {
            flex: 1;
        }
        
        .editable-cell {
            cursor: pointer;
            position: relative;
        }
        
        .editable-cell:hover {
            background: #f0f0f0;
        }
        
        .editable-cell input {
            width: 100%;
            border: 1px solid #667eea;
            padding: 5px;
        }
    </style>
</head>
<body>
    <!-- ç™»å…¥ä»‹é¢ -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <img src="R0.png" alt="Logo" class="login-logo">
        
            </div>
            <div class="login-body">
                <h2>ğŸ­<br>å®¢æˆ¶è¨—æ”¶è¨—é‹GAIæ•¸æ“šç®¡ç†ç³»çµ±</h2>
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>å¸³è™Ÿ</label>
                        <input type="text" id="loginAccount" class="form-control" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" required>
                    </div>
                    <div class="form-group">
                        <label>å¯†ç¢¼</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required>
                    </div>
                    <button type="submit" class="btn btn-primary login-btn">ç™»å…¥</button>
                </form>
            </div>
            <div class="login-footer">
                <div class="connection-status" id="loginConnectionStatus">
                    <span class="status-dot"></span>
                    å·²é€£ç·š
                </div>
            </div>
        </div>
    </div>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    
    <div class="container" id="mainSystem">
        <div class="header">
             <img src="R1.png" alt="Company Logo" class="header-logo">
            <h1>ğŸ­ GAIã€å®¢æˆ¶è¨—æ”¶è¨—é‹ã€‘æš¨ã€åº«å­˜æ°´å¹³ã€‘æ•¸æ“šç®¡ç†ç³»çµ±</h1>
            <p>æ™ºæ…§åŒ–å†·éˆå€‰å„²ç®¡ç†å¹³å° |3åº§å†·å‡åº« Â· 7åº§å†·è—åº«</p>
            <div class="status-indicator" id="connectionStatus">
                é€£æ¥ç‹€æ…‹: æª¢æŸ¥ä¸­...
            </div>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')" data-permission="s1">ğŸ“Š ä¸»æ§å°</button>
            <button class="nav-tab" onclick="switchTab('inventory')" data-permission="s2">ğŸ“¦ å³æ™‚åº«å­˜</button>
            <button class="nav-tab" onclick="switchTab('demand')" data-permission="s3">ğŸ“ˆ éœ€æ±‚è¨­å®š</button>
            <button class="nav-tab" onclick="switchTab('prediction')" data-permission="s3">ğŸ¤– AIé æ¸¬åˆ†æ</button>
            <button class="nav-tab" onclick="switchTab('replenishment')" data-permission="s3">ğŸ“ è£œå–®ç®¡ç†</button>
            <button class="nav-tab" onclick="switchTab('capacity')" data-permission="s3">ğŸ¢ å€‰å®¹ç›£æ§</button>
            <button class="nav-tab" onclick="switchTab('settings')" data-permission="s4">âš™ï¸ ç³»çµ±è¨­å®š</button>
        </div>
        
        <div class="content">
<!-- ä¸»æ§å° -->
<div id="dashboard" class="tab-content active">
    <h2>å³æ™‚ç‡Ÿé‹ç¸½è¦½</h2>
    <div style="text-align: right; margin-bottom: 20px;">
        <button class="btn btn-primary" onclick="refreshAllData()" data-permission="s2">
            ğŸ”„ é‡æ–°æ•´ç†æ‰€æœ‰è³‡æ–™
        </button>
        <button class="btn btn-warning" onclick="refreshDashboard()" data-permission="s2">
            ğŸ”„ é‡æ–°æ•´ç†ä¸»æ§å°
        </button>
        <span style="margin-left: 10px; color: #666;" id="lastUpdate">æœ€å¾Œæ›´æ–°: --</span>
    </div>
    
    <!-- âœ… ä¸Šæ’ï¼š3 å€‹ KPI å¡ç‰‡ + 1 å¼µåœ–ç‰‡ -->
    <div class="dashboard-grid top-row" id="dashboardKPIsTop">
        <!-- KPI å¡ç‰‡å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>
    
    <!-- âœ… ä¸‹æ’ï¼š2 å€‹è­¦å ±å¡ -->
    <div class="dashboard-grid bottom-row" id="dashboardKPIsBottom">
        <!-- è­¦å ±å¡ç‰‡å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>
    
    <div id="dashboardActions" data-permission="s2">
        <h3>ç³»çµ±å¿«é€Ÿæ“ä½œ</h3>
        <div style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="runFullAnalysis()" data-permission="s3">ğŸš€ åŸ·è¡Œå®Œæ•´åˆ†ææµç¨‹</button>
            <button class="btn btn-success" onclick="generateAllSuggestions()" data-permission="s3">ğŸ“‹ ç”¢ç”Ÿæ‰€æœ‰å»ºè­°</button>
            <button class="btn btn-secondary" onclick="exportDashboard()" data-permission="s2">ğŸ“¥ åŒ¯å‡ºå„€è¡¨æ¿</button>
        </div>
    </div>
    
    <h3 style="margin-top: 30px;">ç³»çµ±è­¦å ±èˆ‡é€šçŸ¥</h3>
    <div id="alertsContainer">
        <!-- è­¦å ±å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>
</div>


            
            <!-- å³æ™‚åº«å­˜ -->
            <div id="inventory" class="tab-content">
                <div class="permission-message" id="inventoryPermissionMessage" style="display: none;">
                    <h3>ğŸ”’ æ¬Šé™ä¸è¶³</h3>
                    <p>æ‚¨ç›®å‰çš„æ¬Šé™ç­‰ç´šç„¡æ³•è¨ªå•æ­¤åŠŸèƒ½</p>
                    <p>å¦‚éœ€ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡æå‡æ¬Šé™</p>
                </div>
                
                <div id="inventoryContent">
                    <h2>å³æ™‚åº«å­˜ç®¡ç†</h2>
                    
                    <!-- âœ… æ–°ç‰ˆï¼šå¢åŠ å» å•†å’Œç‹€æ…‹ç¯©é¸ -->
<!-- âœ… æ–°ç‰ˆï¼šå¢åŠ å» å•†ã€ç‹€æ…‹ã€å‡ºè²¨æ—¥æœŸç¯©é¸ -->
<div class="form-group">
    <div class="input-group" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto auto; gap: 10px; align-items: end;">
        <!-- æœå°‹æ¡† -->
        <div>
            <label>ğŸ” å¿«é€Ÿæœå°‹</label>
            <input type="text" class="form-control" id="inventorySearch" placeholder="è¼¸å…¥SKUæˆ–å“å..." onkeyup="searchInventory()">
        </div>
        
        <!-- æº«å±¤ç¯©é¸ -->
        <div>
            <label>ğŸŒ¡ï¸ æº«å±¤</label>
            <select class="form-control" id="tempFilter" onchange="filterInventory()">
                <option value="">å…¨éƒ¨æº«å±¤</option>
                <option value="å†·å‡">â„ï¸ å†·å‡</option>
                <option value="å†·è—">ğŸ§Š å†·è—</option>
            </select>
        </div>
        
        <!-- å» å•†ç¯©é¸ -->
        <div>
            <label>ğŸ­ å» å•†</label>
            <select class="form-control" id="supplierFilter" onchange="filterInventory()">
                <option value="">å…¨éƒ¨å» å•†</option>
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </select>
        </div>
        
        <!-- ç‹€æ…‹ç¯©é¸ -->
        <div>
            <label>ğŸš¦ ç‹€æ…‹</label>
            <select class="form-control" id="statusFilter" onchange="filterInventory()">
                <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                <option value="danger">ğŸ”´ ä½æ–¼å®‰å…¨åº«å­˜</option>
                <option value="warning">ğŸŸ¡ ä½æ–¼ä¸­ä½é»</option>
                <option value="normal">âœ… æ­£å¸¸</option>
            </select>
        </div>
        
        <!-- âœ… æ–°å¢ï¼šå‡ºè²¨æ—¥æœŸç¯©é¸ -->
        <div>
            <label>ğŸ“… å‡ºè²¨æ—¥æœŸ</label>
            <select class="form-control" id="shipDateFilter" onchange="filterInventory()">
                <option value="">å…¨éƒ¨æ—¥æœŸ</option>
                <option value="today">ğŸ“Œ ä»Šå¤©</option>
                <option value="tomorrow">â¡ï¸ æ˜å¤©</option>
                <option value="week">ğŸ“† æœ¬é€±</option>
                <option value="month">ğŸ“… æœ¬æœˆ</option>
                <option value="overdue">âš ï¸ å·²é€¾æœŸ</option>
                <option value="custom">ğŸ”§ è‡ªè¨‚æ—¥æœŸ</option>
            </select>
        </div>
        
        <!-- æŒ‰éˆ• -->
        <button class="btn btn-primary" onclick="addNewInventory()">â• æ–°å¢</button>
        <button class="btn btn-success" onclick="refreshInventory()">ğŸ”„ é‡æ–°æ•´ç†</button>
    </div>
    
    <!-- âœ… æ–°å¢ï¼šè‡ªè¨‚æ—¥æœŸç¯„åœï¼ˆé è¨­éš±è—ï¼‰ -->
    <div id="customDateRange" style="display: none; margin-top: 10px; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #e0e0e0;">
        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
            <div>
                <label style="font-size: 0.9em; font-weight: 600; color: #374151;">ğŸ“… é–‹å§‹æ—¥æœŸ</label>
                <input type="date" class="form-control" id="startDate" onchange="filterInventory()">
            </div>
            <div>
                <label style="font-size: 0.9em; font-weight: 600; color: #374151;">ğŸ“… çµæŸæ—¥æœŸ</label>
                <input type="date" class="form-control" id="endDate" onchange="filterInventory()">
            </div>
            <button class="btn btn-secondary" onclick="clearCustomDate()" style="padding: 10px 15px;">æ¸…é™¤</button>
        </div>
    </div>
    
    <!-- ç¯©é¸çµ±è¨ˆ -->
    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em; color: #666;">
        <i class="fas fa-info-circle"></i> 
        é¡¯ç¤º <strong id="filteredCount" style="color: #667eea;">0</strong> / 
        <strong id="totalCount" style="color: #333;">0</strong> ç­†è³‡æ–™
        <span id="dateFilterInfo" style="margin-left: 15px; color: #667eea;"></span>
    </div>
</div>

                    
                    <div class="table-container">
                                                        <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th>å“é …ç·¨è™Ÿ</th>
                            <th>å“å</th>
                            <th>é€²è²¨æ—¥</th>
                            <th>æ‰¹è™Ÿ/æœ‰æ•ˆ</th>
                            <th>å‰æ—¥åº«å­˜</th>
                            <th>å‡ºè²¨ç¸½æ•¸</th>
                            <th>é€€è²¨</th>
                            <th>é€²è²¨</th>
                            <th>åº«å­˜</th>
                            <th>å…æ”¶æ—¥</th>
                            <th>å…æ”¶å¤©æ•¸</th>
                            <th>æœ‰æ•ˆå¤©æ•¸</th>
                            <th>å‡ºè²¨æ—¥æœŸ</th>
                            <th>å» å•†</th>
                            <th>å®‰å…¨åº«å­˜</th>
                            <th>åº«å­˜ä¸­ä½é»</th>
                            <th>æº«å±¤</th>
                            <th>ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>

                            <tbody id="inventoryTableBody">
                                <!-- å‹•æ…‹è¼‰å…¥ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- éœ€æ±‚è¨­å®š -->
            <div id="demand" class="tab-content">
                <div class="permission-message" id="demandPermissionMessage" style="display: none;">
                    <h3>ğŸ”’ æ¬Šé™ä¸è¶³</h3>
                    <p>æ‚¨ç›®å‰çš„æ¬Šé™ç­‰ç´šç„¡æ³•è¨ªå•æ­¤åŠŸèƒ½</p>
                    <p>å¦‚éœ€ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡æå‡æ¬Šé™</p>
                </div>
                
                <div id="demandContent">
                    <h2>å®¢æˆ¶éœ€æ±‚èˆ‡æœå‹™æ°´æº–è¨­å®š</h2>
                    
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-title">æ–°å¢éœ€æ±‚è¨­å®š</div>
                            <div class="form-group">
                                <label>SKUä»£ç¢¼</label>
                                <input type="text" class="form-control" id="demandSKU" placeholder="ä¾‹: SKU001">
                            </div>
                            <div class="form-group">
                                <label>å“å</label>
                                <input type="text" class="form-control" id="demandName" placeholder="ä¾‹: å†·å‡ç‰›è‚‰">
                            </div>
                            <div class="form-group">
                                <label>å®¢æˆ¶</label>
                                <input type="text" class="form-control" id="demandCustomer" placeholder="ä¾‹: å®¢æˆ¶A">
                            </div>
                            <div class="form-group">
                                <label>æœå‹™æ°´æº–</label>
                                <select class="form-control" id="demandServiceLevel">
                                    <option value="Q3">Q3ç´š (99.5% - z=2.58)</option>
                                    <option value="Q2" selected>Q2ç´š (97.5% - z=1.96)</option>
                                    <option value="Q1">Q1ç´š (95% - z=1.645)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>å¹³å‡æ—¥éœ€æ±‚</label>
                                <input type="number" class="form-control" id="demandDaily" placeholder="ä¾‹: 100">
                            </div>
                            <div class="form-group">
                                <label>äº¤æœŸ(å¤©)</label>
                                <input type="number" class="form-control" id="demandLeadTime" value="7">
                            </div>
                            <button class="btn btn-primary" onclick="saveDemand()">å„²å­˜éœ€æ±‚è¨­å®š</button>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">æœå‹™æ°´æº–èªªæ˜</div>
                            <table style="width: 100%;">
                                <tr>
                                    <td><strong>Q3ç´š</strong></td>
                                    <td>99.5% æœå‹™æ°´æº–</td>
                                    <td>z = 2.58</td>
                                </tr>
                                <tr>
                                    <td><strong>Q2ç´š</strong></td>
                                    <td>97.5% æœå‹™æ°´æº–</td>
                                    <td>z = 1.96</td>
                                </tr>
                                <tr>
                                    <td><strong>Q1ç´š</strong></td>
                                    <td>95% æœå‹™æ°´æº–</td>
                                    <td>z = 1.645</td>
                                </tr>
                            </table>
                            
                            <h4 style="margin-top: 20px;">è¨ˆç®—å…¬å¼</h4>
                            <p><strong>å®‰å…¨åº«å­˜(SS)</strong> = z Ã— Ïƒ_L</p>
                            <p><strong>è£œè²¨é»(ROP)</strong> = dÌ„ Ã— LT + SS</p>
                            <p><strong>ç›®æ¨™åº«å­˜</strong> = dÌ„ Ã— (LT + RP) + SS</p>
                            <p style="font-size: 0.9em; color: #666;">
                                å…¶ä¸­ï¼šz=æœå‹™æ°´æº–ä¿‚æ•¸, Ïƒ_L=äº¤æœŸéœ€æ±‚æ¨™æº–å·®, dÌ„=å¹³å‡éœ€æ±‚, LT=äº¤æœŸ, RP=æª¢è¦–é€±æœŸ
                            </p>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 30px;">å·²è¨­å®šçš„éœ€æ±‚æ¸…å–®</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>SKU</th>
                                    <th>å“å</th>
                                    <th>å®¢æˆ¶</th>
                                    <th>æœå‹™æ°´æº–</th>
                                    <th>æ—¥éœ€æ±‚</th>
                                    <th>äº¤æœŸ</th>
                                    <th>å®‰å…¨åº«å­˜</th>
                                    <th>è£œè²¨é»</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="demandTableBody">
                                <!-- å‹•æ…‹è¼‰å…¥ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- AIé æ¸¬åˆ†æ -->
            <div id="prediction" class="tab-content">
                <div class="permission-message" id="predictionPermissionMessage" style="display: none;">
                    <h3>ğŸ”’ æ¬Šé™ä¸è¶³</h3>
                    <p>æ‚¨ç›®å‰çš„æ¬Šé™ç­‰ç´šç„¡æ³•è¨ªå•æ­¤åŠŸèƒ½</p>
                    <p>å¦‚éœ€ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡æå‡æ¬Šé™</p>
                </div>
                
                <div id="predictionContent">
                    <h2>AIé æ¸¬åˆ†æå¼•æ“</h2>
                    
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-title">é æ¸¬åƒæ•¸è¨­å®š</div>
                            <div class="form-group">
                                <label>é æ¸¬æœŸé–“</label>
                                <select class="form-control" id="predictionPeriod">
                                    <option value="7">æœªä¾†7å¤©</option>
                                    <option value="14">æœªä¾†14å¤©</option>
                                    <option value="30" selected>æœªä¾†30å¤©</option>
                                    <option value="60">æœªä¾†60å¤©</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>é æ¸¬æ–¹æ³•</label>
                                <select class="form-control" id="predictionMethod">
                                    <option value="MA">ç§»å‹•å¹³å‡æ³•</option>
                                    <option value="ES">æŒ‡æ•¸å¹³æ»‘æ³•</option>
                                    <option value="ARIMA">ARIMAæ¨¡å‹</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ç‰¹æ®Šå› ç´ è€ƒé‡</label>
                                <div>
                                    <label><input type="checkbox" id="seasonalFactor"> å­£ç¯€æ€§å› ç´ </label><br>
                                    <label><input type="checkbox" id="promotionFactor"> ä¿ƒéŠ·æ´»å‹•</label><br>
                                    <label><input type="checkbox" id="weatherFactor"> å¤©æ°£å½±éŸ¿</label>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="runPrediction()">ğŸ¤– åŸ·è¡Œé æ¸¬</button>
                            <button class="btn btn-secondary" onclick="viewHistory()">ğŸ“Š æŸ¥çœ‹æ­·å²</button>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">é æ¸¬çµæœæ‘˜è¦</div>
                            <div id="predictionSummary">
                                <p>å°šæœªåŸ·è¡Œé æ¸¬...</p>
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 30px;">é æ¸¬çµæœè©³æƒ…</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>SKU</th>
                                    <th>å“å</th>
                                    <th>é æ¸¬æœŸé–“</th>
                                    <th>é æ¸¬éœ€æ±‚</th>
                                    <th>æ¨™æº–å·®</th>
                                    <th>ä¿¡è³´å€é–“</th>
                                    <th>å»ºè­°è¡Œå‹•</th>
                                </tr>
                            </thead>
                            <tbody id="predictionTableBody">
                                <!-- å‹•æ…‹è¼‰å…¥ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
<!-- è£œå–®ç®¡ç† -->
<div id="replenishment" class="tab-content">
    <div class="permission-message" id="replenishmentPermissionMessage" style="display: none;">
        <h3>ğŸ”’ æ¬Šé™ä¸è¶³</h3>
        <p>æ‚¨ç›®å‰çš„æ¬Šé™ç­‰ç´šç„¡æ³•è¨ªå•æ­¤åŠŸèƒ½</p>
        <p>å¦‚éœ€ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡æå‡æ¬Šé™</p>
    </div>
    
    <div id="replenishmentContent">
        <h2>æ™ºèƒ½è£œå–®ç®¡ç†</h2>
        
        <!-- æ“ä½œæŒ‰éˆ•å€ -->
        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="generateReplenishment()">ğŸ”„ é‡æ–°è¼‰å…¥è£œå–®å»ºè­°</button>
            <button class="btn btn-success" onclick="approveAllSuggestions()">âœ… å…¨éƒ¨æ ¸å‡†</button>
            <button class="btn btn-warning" onclick="sendReplenishmentEmail()">ğŸ“§ è£œå–®å¯„ç™¼</button>
            <button class="btn btn-info" onclick="sendReplenishmentEmail(true)">ğŸ§ª æ¸¬è©¦å¯„ç™¼</button>
            <button class="btn btn-danger" onclick="clearPending()">ğŸ—‘ï¸ æ¸…é™¤å¾…è™•ç†</button>
        </div>
        
        <!-- ç¯©é¸å€ -->
        <div class="form-group">
            <div class="input-group" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; align-items: end;">
                <!-- æœå°‹æ¡† -->
                <div>
                    <label>ğŸ” å¿«é€Ÿæœå°‹</label>
                    <input type="text" class="form-control" id="replenishmentSearch" 
                           placeholder="è¼¸å…¥SKUæˆ–å“å..." onkeyup="filterReplenishment()">
                </div>
                
                <!-- æº«å±¤ç¯©é¸ -->
                <div>
                    <label>ğŸŒ¡ï¸ æº«å±¤</label>
                    <select class="form-control" id="replenishmentTempFilter" onchange="filterReplenishment()">
                        <option value="">å…¨éƒ¨æº«å±¤</option>
                        <option value="å†·å‡">â„ï¸ å†·å‡</option>
                        <option value="å†·è—">ğŸ§Š å†·è—</option>
                    </select>
                </div>
                
                <!-- å» å•†ç¯©é¸ -->
                <div>
                    <label>ğŸ­ å» å•†</label>
                    <select class="form-control" id="replenishmentSupplierFilter" onchange="filterReplenishment()">
                        <option value="">å…¨éƒ¨å» å•†</option>
                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                    </select>
                </div>
                
                <!-- ç‹€æ…‹ç¯©é¸ -->
                <div>
                    <label>ğŸš¦ åº«å­˜ç‹€æ…‹</label>
                    <select class="form-control" id="replenishmentStatusFilter" onchange="filterReplenishment()">
                        <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                        <option value="danger">ğŸ”´ ä½æ–¼å®‰å…¨åº«å­˜</option>
                        <option value="warning">ğŸŸ¡ ä½æ–¼ä¸­ä½é»</option>
                    </select>
                </div>
                
                <button class="btn btn-secondary" onclick="clearReplenishmentFilters()">æ¸…é™¤ç¯©é¸</button>
            </div>
            
            <!-- ç¯©é¸çµ±è¨ˆ -->
            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em; color: #666;">
                <i class="fas fa-info-circle"></i> 
                é¡¯ç¤º <strong id="replenishmentFilteredCount" style="color: #667eea;">0</strong> / 
                <strong id="replenishmentTotalCount" style="color: #333;">0</strong> ç­†è£œå–®å»ºè­°
            </div>
        </div>
        
        <!-- è£œå–®å»ºè­°æ¸…å–®è¡¨æ ¼ -->
        <h3>è£œå–®å»ºè­°æ¸…å–®</h3>
        <div class="table-container">
            <table id="replenishmentTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" onchange="selectAllReplenishments()"></th>
                        <th>å“é …ç·¨è™Ÿ</th>
                        <th>å“å</th>
                        <th>é€²è²¨æ—¥</th>
                        <th>æ‰¹è™Ÿ/æœ‰æ•ˆ</th>
                        <th>å‰æ—¥åº«å­˜</th>
                        <th>å‡ºè²¨ç¸½æ•¸</th>
                        <th>é€€è²¨</th>
                        <th>é€²è²¨</th>
                        <th>åº«å­˜</th>
                        <th>å…æ”¶æ—¥</th>
                        <th>å…æ”¶å¤©æ•¸</th>
                        <th>æœ‰æ•ˆå¤©æ•¸</th>
                        <th>å‡ºè²¨æ—¥æœŸ</th>
                        <th>å» å•†</th>
                        <th>å®‰å…¨åº«å­˜</th>
                        <th>åº«å­˜ä¸­ä½é»</th>
                        <th>æº«å±¤</th>
                        <th>ç‹€æ…‹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="replenishmentTableBody">
                    <!-- å‹•æ…‹è¼‰å…¥ -->
                </tbody>
            </table>
        </div>
    </div>
</div>

            
            <!-- å€‰å®¹ç›£æ§ -->
            <div id="capacity" class="tab-content">
                <div class="permission-message" id="capacityPermissionMessage" style="display: none;">
                    <h3>ğŸ”’ æ¬Šé™ä¸è¶³</h3>
                    <p>æ‚¨ç›®å‰çš„æ¬Šé™ç­‰ç´šç„¡æ³•è¨ªå•æ­¤åŠŸèƒ½</p>
                    <p>å¦‚éœ€ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡æå‡æ¬Šé™</p>
                </div>
                
                <div id="capacityContent">
                    <h2>å€‰å®¹å³æ™‚ç›£æ§</h2>
                    
                    <h3>â„ï¸ å†·å‡åº« (3åº§)</h3>
                    <div class="dashboard-grid" id="freezerCapacity">
                        <!-- å‹•æ…‹è¼‰å…¥ -->
                    </div>
                    
                    <h3 style="margin-top: 30px;">ğŸ§Š å†·è—åº« (7åº§)</h3>
                    <div class="dashboard-grid" id="coolerCapacity">
                        <!-- å‹•æ…‹è¼‰å…¥ -->
                    </div>
                    
                    <h3 style="margin-top: 30px;">å€‰å®¹åˆ†é…å»ºè­°</h3>
                    <div id="capacityRecommendations">
                        <!-- å‹•æ…‹è¼‰å…¥ -->
                    </div>
                </div>
            </div>
            
            <!-- ç³»çµ±è¨­å®š -->
            <div id="settings" class="tab-content">
                <div class="permission-message" id="settingsPermissionMessage" style="display: none;">
                    <h3>ğŸ”’ æ¬Šé™ä¸è¶³</h3>
                    <p>æ‚¨ç›®å‰çš„æ¬Šé™ç­‰ç´šç„¡æ³•è¨ªå•æ­¤åŠŸèƒ½</p>
                    <p>åªæœ‰ç®¡ç†å“¡(s4)æ¬Šé™å¯ä»¥ä½¿ç”¨ç³»çµ±è¨­å®šåŠŸèƒ½</p>
                </div>
                
                <div id="settingsContent">
                    <h2>ç³»çµ±è¨­å®š</h2>
                    
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-title">Google Sheet é€£æ¥è¨­å®š</div>
                            <div class="form-group">
                                <label>Sheet ID</label>
                                <input type="text" class="form-control" id="sheetId" value="1Viqk5tApAs9xeT3s9NSN8K5Aej0nEdc53Eqc4dg96ts" readonly>
                            </div>
                            <div class="form-group">
                                <label>Web App URL</label>
                                <input type="text" class="form-control" id="webAppUrl" placeholder="https://script.google.com/macros/s/AKfycbzhOTG1lvysVJDrpStKV3yKj3vS_W3J8o6L6jTipqmhODqQFEB0x2MCXa8kxpwKwwPf/exec">
                            </div>
                            <button class="btn btn-primary" onclick="testConnection()">æ¸¬è©¦é€£æ¥</button>
                            <button class="btn btn-success" onclick="saveConnection()">å„²å­˜è¨­å®š</button>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">ç³»çµ±åƒæ•¸</div>
                            <div class="form-group">
                                <label>é è¨­æª¢è¦–é€±æœŸ(å¤©)</label>
                                <input type="number" class="form-control" id="reviewPeriod" value="7">
                            </div>
                            <div class="form-group">
                                <label>é è¨­äº¤æœŸ(å¤©)</label>
                                <input type="number" class="form-control" id="defaultLeadTime" value="7">
                            </div>
                            <div class="form-group">
                                <label>å®¹é‡è­¦æˆ’ç·š(%)</label>
                                <input type="number" class="form-control" id="capacityAlert" value="85">
                            </div>
                            <button class="btn btn-primary" onclick="saveSystemSettings()">å„²å­˜åƒæ•¸</button>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 30px;">è³‡æ–™åˆå§‹åŒ–</h3>
                    <div class="card">
                        <p>é¦–æ¬¡ä½¿ç”¨è«‹åŸ·è¡Œåˆå§‹åŒ–ï¼Œå°‡å»ºç«‹æ‰€æœ‰å¿…è¦çš„å·¥ä½œè¡¨çµæ§‹ã€‚</p>
                        <button class="btn btn-warning" onclick="initializeSystem()">ğŸš€ åˆå§‹åŒ–ç³»çµ±</button>
                        <button class="btn btn-danger" onclick="resetSystem()">âš ï¸ é‡ç½®ç³»çµ±ï¼ˆæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼‰</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">æ¨™é¡Œ</h3>
            </div>
            <div id="modalBody">
                <!-- å‹•æ…‹å…§å®¹ -->
            </div>
        </div>
    </div>
    
    <script>
        // ç³»çµ±é…ç½®
        let GAS_URL = 'https://script.google.com/macros/s/AKfycbzhOTG1lvysVJDrpStKV3yKj3vS_W3J8o6L6jTipqmhODqQFEB0x2MCXa8kxpwKwwPf/exec';
        const SHEET_ID = '1Viqk5tApAs9xeT3s9NSN8K5Aej0nEdc53Eqc4dg96ts';
        
        // ç”¨æˆ¶æœƒè©±ç®¡ç†
        let currentUser = null;
        let userLevel = null;
        
        // æ¬Šé™é…ç½®
        const PERMISSIONS = {
            's1': ['dashboard'], // åªèƒ½çœ‹ä¸»æ§å°ï¼Œç„¡æ³•ä½¿ç”¨æŒ‰éˆ•
            's2': ['dashboard', 'inventory'], // å¯ä½¿ç”¨ä¸»æ§å°å’Œå³æ™‚åº«å­˜
            's3': ['dashboard', 'inventory', 'demand', 'prediction', 'replenishment', 'capacity'], // é™¤ç³»çµ±è¨­å®šå¤–éƒ½å¯ç”¨
            's4': ['dashboard', 'inventory', 'demand', 'prediction', 'replenishment', 'capacity', 'settings'] // ç„¡é™åˆ¶
        };

document.addEventListener('DOMContentLoaded', function() {
    console.log('ç³»çµ±å•Ÿå‹•...');
    
    // è¨­å®šç³»çµ±è¨­å®šé é¢çš„ URL é¡¯ç¤ºï¼ˆåƒ…ä¾›ç®¡ç†å“¡æŸ¥çœ‹ï¼‰
    const webAppUrlElement = document.getElementById('webAppUrl');
    if (webAppUrlElement) {
        webAppUrlElement.value = GAS_URL;
    }
    
    // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
    const savedUser = sessionStorage.getItem('currentUser');
    const savedLevel = sessionStorage.getItem('userLevel');
    
    if (savedUser && savedLevel) {
        currentUser = JSON.parse(savedUser);
        userLevel = savedLevel;
        showMainSystem();
        checkConnection();
        
        // âœ… æ–°å¢ï¼šç™»å…¥å¾Œé è¼‰å…¥è³‡æ–™
        preloadAllData().then(success => {
            if (success) {
                updateDashboard(systemData.dashboard);
            }
        });
        
        // âœ… æ–°å¢ï¼šæ¯å¤©è‡ªå‹•é‡æ–°æ•´ç†ä¸€æ¬¡ï¼ˆ24å°æ™‚ï¼‰
        setInterval(() => {
            console.log('ğŸ”„ è‡ªå‹•é‡æ–°æ•´ç†è³‡æ–™...');
            preloadAllData().then(success => {
                if (success) {
                    // å¦‚æœç•¶å‰åœ¨ä¸»æ§å°ï¼Œæ›´æ–°é¡¯ç¤º
                    const activeTab = document.querySelector('.tab-content.active');
                    if (activeTab && activeTab.id === 'dashboard') {
                        updateDashboard(systemData.dashboard);
                    }
                    
                    // é¡¯ç¤ºé€šçŸ¥
                    const lastUpdateEl = document.getElementById('lastUpdate');
                    if (lastUpdateEl) {
                        lastUpdateEl.textContent = `æœ€å¾Œæ›´æ–°: ${systemData.lastUpdate.toLocaleString('zh-TW')}`;
                    }
                }
            });
        }, 24 * 60 * 60 * 1000); // 24 å°æ™‚
        
    } else {
        showLoginForm();
    }
});



        // é¡¯ç¤ºç™»å…¥è¡¨å–®
        function showLoginForm() {
            const loginContainer = document.getElementById('loginContainer');
            const mainSystem = document.getElementById('mainSystem');
            
            if (loginContainer) {
                loginContainer.style.display = 'flex';
            }
            
            if (mainSystem) {
                mainSystem.style.display = 'none';
            }
        }

        // é¡¯ç¤ºä¸»ç³»çµ±
        function showMainSystem() {
            const loginContainer = document.getElementById('loginContainer');
            const mainSystem = document.getElementById('mainSystem');
            
            if (loginContainer) {
                loginContainer.style.display = 'none';
            }
            
            if (mainSystem) {
                mainSystem.style.display = 'flex';
            }
            
            // æ›´æ–°ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º
            updateUserInfo();
            
            // æ ¹æ“šæ¬Šé™è¨­å®šä»‹é¢
            applyPermissions();
        }

        // è™•ç†ç™»å…¥
// âœ… ä¿®æ”¹å¾Œï¼šç™»å…¥æˆåŠŸå¾Œé è¼‰å…¥è³‡æ–™
function handleLogin(event) {
    event.preventDefault();
    
    const account = document.getElementById('loginAccount').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!account || !password) {
        alert('è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼ï¼');
        return;
    }
    
    showLoading();
    
    callAPI('login', { account, password })
        .then(result => {
            if (result.success) {
                currentUser = {
                    account: account,
                    name: result.user.name || account,
                    title: result.user.title || '',
                    level: result.user.level || 's1'
                };
                userLevel = result.user.level || 's1';
                
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                sessionStorage.setItem('userLevel', userLevel);
                
                showMainSystem();
                
                // âœ… æ–°å¢ï¼šé è¼‰å…¥æ‰€æœ‰è³‡æ–™
                preloadAllData().then(success => {
                    if (success) {
                        // é è¼‰å®Œæˆå¾Œï¼Œé¡¯ç¤ºä¸»æ§å°
                        updateDashboard(systemData.dashboard);
                        
                        // é¡¯ç¤ºæœ€å¾Œæ›´æ–°æ™‚é–“
                        const lastUpdateEl = document.getElementById('lastUpdate');
                        if (lastUpdateEl) {
                            lastUpdateEl.textContent = `æœ€å¾Œæ›´æ–°: ${systemData.lastUpdate.toLocaleString('zh-TW')}`;
                        }
                    }
                });
            } else {
                hideLoading();
                alert(result.message || 'ç™»å…¥å¤±æ•—ï¼');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Login error:', error);
            alert('ç™»å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ï¼');
        });
}

        // âœ… æ–°å¢ï¼šé è¼‰å…¥æ‰€æœ‰è³‡æ–™
async function preloadAllData() {
    showLoading('æ­£åœ¨è¼‰å…¥ç³»çµ±è³‡æ–™ï¼Œè«‹ç¨å€™...');
    
    try {
        console.log('ğŸš€ é–‹å§‹é è¼‰å…¥æ‰€æœ‰è³‡æ–™...');
        
        // æ ¹æ“šæ¬Šé™æ±ºå®šè¦è¼‰å…¥å“ªäº›è³‡æ–™
        const promises = [];
        
        // 1ï¸âƒ£ æ‰€æœ‰ç”¨æˆ¶éƒ½è¼‰å…¥ä¸»æ§å°
        promises.push(
            callAPI('getDashboard')
                .then(data => {
                    systemData.dashboard = data;
                    console.log('âœ… ä¸»æ§å°è³‡æ–™è¼‰å…¥å®Œæˆ');
                })
        );
        
        // 2ï¸âƒ£ s2 ä»¥ä¸Šè¼‰å…¥åº«å­˜
        if (checkPermission('s2')) {
            promises.push(
                callAPI('getInventory')
                    .then(data => {
                        systemData.inventory = data.items || [];
                        console.log(`âœ… åº«å­˜è³‡æ–™è¼‰å…¥å®Œæˆ (${systemData.inventory.length} ç­†)`);
                    })
            );
        }
        
        // 3ï¸âƒ£ s3 ä»¥ä¸Šè¼‰å…¥éœ€æ±‚ã€é æ¸¬ã€è£œå–®ã€å€‰å®¹
        if (checkPermission('s3')) {
            promises.push(
                callAPI('getDemands')
                    .then(data => {
                        systemData.demands = data.demands || [];
                        console.log(`âœ… éœ€æ±‚è¨­å®šè¼‰å…¥å®Œæˆ (${systemData.demands.length} ç­†)`);
                    }),
                
                callAPI('getPredictions')
                    .then(data => {
                        systemData.predictions = data.predictions || [];
                        console.log(`âœ… é æ¸¬çµæœè¼‰å…¥å®Œæˆ (${systemData.predictions.length} ç­†)`);
                    }),
                
                callAPI('getReplenishments')
                    .then(data => {
                        systemData.replenishments = data.suggestions || [];
                        console.log(`âœ… è£œå–®å»ºè­°è¼‰å…¥å®Œæˆ (${systemData.replenishments.length} ç­†)`);
                    }),
                
                callAPI('getCapacity')
                    .then(data => {
                        systemData.capacity = data;
                        console.log('âœ… å€‰å®¹è³‡æ–™è¼‰å…¥å®Œæˆ');
                    })
            );
        }
        
        // ç­‰å¾…æ‰€æœ‰è³‡æ–™è¼‰å…¥å®Œæˆ
        await Promise.all(promises);
        
        // è¨˜éŒ„è¼‰å…¥æ™‚é–“
        systemData.lastUpdate = new Date();
        systemData.isLoaded = true;
        
        hideLoading();
        console.log('ğŸ‰ æ‰€æœ‰è³‡æ–™é è¼‰å®Œæˆï¼', systemData);
        
        return true;
        
    } catch (error) {
        hideLoading();
        console.error('âŒ é è¼‰è³‡æ–™å¤±æ•—:', error);
        alert('éƒ¨åˆ†è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œå°‡åœ¨åˆ‡æ›é é¢æ™‚é‡æ–°è¼‰å…¥\néŒ¯èª¤è¨Šæ¯ï¼š' + error.message);
        return false;
    }
}


        // æ›´æ–°ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º
        function updateUserInfo() {
            const header = document.querySelector('.header');
            if (header && currentUser) {
                let userInfoDiv = header.querySelector('.user-info');
                if (!userInfoDiv) {
                    userInfoDiv = document.createElement('div');
                    userInfoDiv.className = 'user-info';
                    header.appendChild(userInfoDiv);
                }
                
                const levelNames = {
                    's1': 'è¨ªå®¢',
                    's2': 'æ“ä½œå“¡',
                    's3': 'ä¸»ç®¡',
                    's4': 'ç®¡ç†å“¡'
                };
                
                userInfoDiv.innerHTML = `
                    <span>æ­¡è¿ï¼Œ${currentUser.name} (${levelNames[userLevel] || userLevel})</span>
                    <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
                `;
            }
        }

        // æ‡‰ç”¨æ¬Šé™è¨­å®š
        function applyPermissions() {
            if (!userLevel) return;
            
            const allowedTabs = PERMISSIONS[userLevel] || [];
            
            // è™•ç†å°èˆªæ¨™ç±¤
            const allTabs = document.querySelectorAll('.nav-tab');
            allTabs.forEach(tab => {
                const tabFunction = tab.getAttribute('onclick');
                if (tabFunction) {
                    const tabName = tabFunction.match(/switchTab\('(\w+)'\)/)?.[1];
                    if (tabName && !allowedTabs.includes(tabName)) {
                        tab.classList.add('disabled');
                        tab.onclick = function(e) {
                            e.preventDefault();
                            alert('æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•è¨ªå•æ­¤åŠŸèƒ½');
                        };
                    }
                }
            });
            
            // è™•ç†å„é é¢çš„æ¬Šé™æ§åˆ¶
            allowedTabs.forEach(tabName => {
                const contentDiv = document.getElementById(tabName + 'Content');
                const permissionDiv = document.getElementById(tabName + 'PermissionMessage');
                
                if (contentDiv && permissionDiv) {
                    contentDiv.style.display = 'block';
                    permissionDiv.style.display = 'none';
                }
            });
            
            // éš±è—ç„¡æ¬Šé™çš„é é¢å…§å®¹
            Object.keys(PERMISSIONS).forEach(level => {
                PERMISSIONS[level].forEach(tabName => {
                    if (!allowedTabs.includes(tabName)) {
                        const contentDiv = document.getElementById(tabName + 'Content');
                        const permissionDiv = document.getElementById(tabName + 'PermissionMessage');
                        
                        if (contentDiv && permissionDiv) {
                            contentDiv.style.display = 'none';
                            permissionDiv.style.display = 'block';
                        }
                    }
                });
            });
            
            // s1 ç”¨æˆ¶ç‰¹æ®Šè™•ç†ï¼šç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
            if (userLevel === 's1') {
                disableAllButtons();
            }
            
            // è™•ç†æŒ‰éˆ•æ¬Šé™
            const buttonsWithPermission = document.querySelectorAll('[data-permission]');
            buttonsWithPermission.forEach(button => {
                const requiredLevel = button.getAttribute('data-permission');
                const requiredLevels = ['s1', 's2', 's3', 's4'];
                const currentLevelIndex = requiredLevels.indexOf(userLevel);
                const requiredLevelIndex = requiredLevels.indexOf(requiredLevel);
                
                if (currentLevelIndex < requiredLevelIndex) {
                    button.classList.add('disabled');
                    button.onclick = function(e) {
                        e.preventDefault();
                        alert('æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•ä½¿ç”¨æ­¤åŠŸèƒ½');
                    };
                }
            });
        }

        // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•ï¼ˆs1 å°ˆç”¨ï¼‰
        function disableAllButtons() {
            const allButtons = document.querySelectorAll('.btn');
            allButtons.forEach(button => {
                // é™¤äº†ç™»å‡ºæŒ‰éˆ•å¤–éƒ½ç¦ç”¨
                if (!button.classList.contains('logout-btn')) {
                    button.classList.add('disabled');
                    button.onclick = function(e) {
                        e.preventDefault();
                        alert('æ‚¨ç›®å‰çš„æ¬Šé™åƒ…èƒ½æŸ¥çœ‹ï¼Œç„¡æ³•åŸ·è¡Œæ“ä½œ');
                    };
                }
            });
        }

        // ç™»å‡ºåŠŸèƒ½
        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                sessionStorage.removeItem('currentUser');
                sessionStorage.removeItem('userLevel');
                currentUser = null;
                userLevel = null;
                showLoginForm();
            }
        }

        // æª¢æŸ¥æ¬Šé™
        function checkPermission(requiredLevel) {
            const levels = ['s1', 's2', 's3', 's4'];
            const currentIndex = levels.indexOf(userLevel);
            const requiredIndex = levels.indexOf(requiredLevel);
            return currentIndex >= requiredIndex;
        }

                   // âœ… ä¿®æ”¹å¾Œï¼šæ–°å¢å®Œæ•´çš„è³‡æ–™å¿«å–çµæ§‹
            let systemData = {
                inventory: [],
                demands: [],
                predictions: [],
                replenishments: [],
                capacity: {
                    freezers: [],
                    coolers: []
                },
                dashboard: null,
                lastUpdate: null,  // âœ… æ–°å¢ï¼šè¨˜éŒ„æœ€å¾Œæ›´æ–°æ™‚é–“
                isLoaded: false    // âœ… æ–°å¢ï¼šæ¨™è¨˜è³‡æ–™æ˜¯å¦å·²è¼‰å…¥
            };

        
        // æª¢æŸ¥é€£æ¥ç‹€æ…‹
        function checkConnection() {
            const statusEl = document.getElementById('connectionStatus');
            
            if (!GAS_URL) {
                statusEl.textContent = 'é€£æ¥ç‹€æ…‹: æœªè¨­å®š';
                statusEl.className = 'status-indicator error';
                return;
            }
            
            fetch(`${GAS_URL}?action=ping`)
                .then(response => response.json())
                .then(data => {
                    statusEl.textContent = 'é€£æ¥ç‹€æ…‹: å·²é€£æ¥';
                    statusEl.className = 'status-indicator connected';
                })
                .catch(error => {
                    statusEl.textContent = 'é€£æ¥ç‹€æ…‹: é€£æ¥å¤±æ•—';
                    statusEl.className = 'status-indicator error';
                    console.error('Connection error:', error);
                });
        }
        
        // åˆ‡æ›æ¨™ç±¤
        function switchTab(tabName) {
            // æª¢æŸ¥æ¬Šé™
            if (!PERMISSIONS[userLevel] || !PERMISSIONS[userLevel].includes(tabName)) {
                alert('æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•è¨ªå•æ­¤åŠŸèƒ½');
                return;
            }
            
            // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => tab.classList.remove('active'));
            
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤æŒ‰éˆ•çš„ active é¡
            const allButtons = document.querySelectorAll('.nav-tab');
            allButtons.forEach(btn => btn.classList.remove('active'));
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤
            document.getElementById(tabName).classList.add('active');
            
            // è¨­ç½®æŒ‰éˆ•ç‚º active
            event.target.classList.add('active');
            
            // è¼‰å…¥å°æ‡‰çš„è³‡æ–™
            loadTabData(tabName);
        }
        
        // è¼‰å…¥æ¨™ç±¤è³‡æ–™
 // âœ… ä¿®æ”¹å¾Œï¼šå„ªå…ˆä½¿ç”¨å¿«å–è³‡æ–™
function loadTabData(tabName) {
    switch(tabName) {
        case 'dashboard':
            if (systemData.dashboard) {
                updateDashboard(systemData.dashboard);
            } else {
                refreshDashboard();
            }
            break;
            
        case 'inventory':
            if (checkPermission('s2')) {
                if (systemData.inventory.length > 0) {
                    displayInventory();
                } else {
                    refreshInventory();
                }
            }
            break;
            
        case 'demand':
            if (checkPermission('s3')) {
                if (systemData.demands.length > 0) {
                    displayDemands();
                } else {
                    loadDemands();
                }
            }
            break;
            
        case 'prediction':
            if (checkPermission('s3')) {
                if (systemData.predictions.length > 0) {
                    displayPredictions();
                } else {
                    loadPredictions();
                }
            }
            break;
            
        case 'replenishment':
            if (checkPermission('s3')) {
                if (systemData.replenishments.length > 0) {
                    displayReplenishments();
                } else {
                    loadReplenishments();
                }
            }
            break;
            
        case 'capacity':
            if (checkPermission('s3')) {
                if (systemData.capacity && systemData.capacity.freezers && systemData.capacity.freezers.length > 0) {
                    displayCapacity();
                } else {
                    loadCapacity();
                }
            }
            break;
    }
}

        
        // é¡¯ç¤ºè¼‰å…¥ä¸­
        function showLoading() {
            document.getElementById('loading').classList.add('active');
        }
        
        // éš±è—è¼‰å…¥ä¸­
        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }
        
        // é¡¯ç¤º Modal
        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }
        
        // é—œé–‰ Modal
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }
        
        // API å‘¼å«å‡½æ•¸
        function callAPI(action, data = {}) {
             if (!GAS_URL) {
        alert('ç³»çµ±é…ç½®éŒ¯èª¤ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡');
                return Promise.reject('No URL configured');
            }
            
            showLoading();
            
            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify({
                    action: action,
                    user: currentUser,
                    ...data
                })
            };
            
            return fetch(GAS_URL, options)
                .then(response => response.json())
                .then(result => {
                    hideLoading();
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    return result;
                })
                .catch(error => {
                    hideLoading();
                    console.error('API Error:', error);
                    throw error;
                });
        }
        
        // === ä¸»æ§å°åŠŸèƒ½ ===
// âœ… ä¿®æ”¹å¾Œï¼šé‡æ–°æ•´ç†æ™‚åŒæ­¥æ›´æ–°å¿«å–
function refreshDashboard() {
    showLoading('æ­£åœ¨é‡æ–°æ•´ç†è³‡æ–™...');
    
    callAPI('getDashboard')
        .then(data => {
            hideLoading();
            systemData.dashboard = data;  // âœ… æ›´æ–°å¿«å–
            systemData.lastUpdate = new Date();  // âœ… æ›´æ–°æ™‚é–“
            
            updateDashboard(data);
            
            const lastUpdateEl = document.getElementById('lastUpdate');
            if (lastUpdateEl) {
                lastUpdateEl.textContent = `æœ€å¾Œæ›´æ–°: ${systemData.lastUpdate.toLocaleString('zh-TW')}`;
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Dashboard error:', error);
            alert('é‡æ–°æ•´ç†å¤±æ•—ï¼š' + error.message);
        });
}
        // âœ… æ–°å¢ï¼šé‡æ–°æ•´ç†æ‰€æœ‰è³‡æ–™
function refreshAllData() {
    if (!checkPermission('s2')) {
        alert('æ¬Šé™ä¸è¶³');
        return;
    }
    
    if (!confirm('ç¢ºå®šè¦é‡æ–°æ•´ç†æ‰€æœ‰è³‡æ–™å—ï¼Ÿ\né€™å¯èƒ½éœ€è¦ 3-5 ç§’çš„æ™‚é–“ã€‚')) {
        return;
    }
    
    preloadAllData().then(success => {
        if (success) {
            alert('âœ… æ‰€æœ‰è³‡æ–™å·²é‡æ–°æ•´ç†å®Œæˆï¼');
            
            // å¦‚æœç•¶å‰åœ¨ä¸»æ§å°ï¼Œæ›´æ–°é¡¯ç¤º
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab && activeTab.id === 'dashboard') {
                updateDashboard(systemData.dashboard);
            }
        } else {
            alert('âŒ éƒ¨åˆ†è³‡æ–™é‡æ–°æ•´ç†å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
    });
}


        
function updateDashboard(data) {
    // âœ… ä¸Šæ’ï¼š3 å€‹ KPI å¡ç‰‡ + 1 å¼µåœ–ç‰‡
    const topContainer = document.getElementById('dashboardKPIsTop');
    if (topContainer) {
        topContainer.innerHTML = `
            <div class="card">
                <div class="card-title">â„ï¸ å†·å‡åº«ä½¿ç”¨ç‡</div>
                <div class="kpi-value">${data.freezerUsage || 0}%</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${data.freezerUsage || 0}%">${data.freezerUsage || 0}%</div>
                </div>
                <div class="kpi-label">3åº§å†·å‡åº« | å¯ç”¨: ${data.freezerAvailable || 0}å€‹æ£§æ¿ä½</div>
            </div>
            
            <div class="card">
                <div class="card-title">ğŸ§Š å†·è—åº«ä½¿ç”¨ç‡</div>
                <div class="kpi-value">${data.coolerUsage || 0}%</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${data.coolerUsage || 0}%">${data.coolerUsage || 0}%</div>
                </div>
                <div class="kpi-label">7åº§å†·è—åº« | å¯ç”¨: ${data.coolerAvailable || 0}å€‹æ£§æ¿ä½</div>
            </div>
            
            <div class="card">
                <div class="card-title">ğŸ“¦ ç¸½SKUæ•¸</div>
                <div class="kpi-value">${data.totalSKUs || 0}</div>
                <div class="kpi-label">å€‹å“é …</div>
            </div>
            
            <div class="image-card">
                <div class="card-title">GAIå•†å“åº«å­˜è¨ˆç®—æ•¸ä½ä¸»ä»»<br>Elon</div>
                <img src="S1.png" alt="GAIå•†å“åº«å­˜è¨ˆç®—æ•¸ä½ä¸»ä»» Elon">
            </div>
        `;
    }
    
    // âœ… ä¸‹æ’ï¼š2 å€‹è­¦å ±å¡
    const bottomContainer = document.getElementById('dashboardKPIsBottom');
    if (bottomContainer) {
        // è¨ˆç®—è¶¨å‹¢
        const trendHtml = generateTrendBadge(data.carbonTrend);
        
        bottomContainer.innerHTML = `
            <div class="card alert-card">
                <div class="card-title">âš ï¸ ä½åº«å­˜è­¦å ±</div>
                <div class="kpi-value">${data.lowStockCount || 0}</div>
                <div class="kpi-label">å€‹å“é …éœ€è£œè²¨</div>
            </div>
            
            <div class="card" style="background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%); color: white;">
                <div class="card-title" style="color: white;">ğŸ“Š å ±å»¢é£Ÿæ(æœ¬æœˆç´¯è¨ˆ)-æº«å®¤æ°£é«”æ’æ”¾é‡ï¼ˆCOâ‚‚eï¼‰</div>
                <div class="kpi-value">${data.carbonEmission || 0}</div>
                <div class="kpi-label" style="color: rgba(255,255,255,0.9);">kg COâ‚‚e</div>
                ${trendHtml}
            </div>
        `;
    }
    
    // æ›´æ–°è­¦å ±
    const alertsContainer = document.getElementById('alertsContainer');
    if (alertsContainer) {
        if (data.alerts && data.alerts.length > 0) {
            alertsContainer.innerHTML = data.alerts.map(alert => `
                <div class="alert-card" style="margin-bottom: 10px; padding: 15px;">
                    <strong>${alert.type}:</strong> ${alert.message}
                </div>
            `).join('');
        } else {
            alertsContainer.innerHTML = '<p style="color: #666;">ç›®å‰ç„¡è­¦å ±</p>';
        }
    }
}

// âœ… æ–°å¢ï¼šç”¢ç”Ÿè¶¨å‹¢æ¨™ç±¤
function generateTrendBadge(trend) {
    if (!trend) return '';
    
    const { direction, percentage, lastMonth, currentMonth } = trend;
    
    let badgeClass = 'trend-neutral';
    let arrow = 'â¡ï¸';
    let text = 'æŒå¹³';
    
    if (direction === 'up') {
        badgeClass = 'trend-up';
        arrow = 'ğŸ“ˆ';
        text = `è¼ƒä¸Šæœˆå¢åŠ  ${percentage}%`;
    } else if (direction === 'down') {
        badgeClass = 'trend-down';
        arrow = 'ğŸ“‰';
        text = `è¼ƒä¸Šæœˆæ¸›å°‘ ${percentage}%`;
    }
    
    return `
        <div class="trend-badge ${badgeClass}">
            ${arrow} ${text}
        </div>
        <div style="margin-top: 8px; font-size: 0.85em; color: rgba(255,255,255,0.8);">
            ä¸Šæœˆ: ${lastMonth} kg | æœ¬æœˆ: ${currentMonth} kg
        </div>
    `;
}


        
        // === åº«å­˜ç®¡ç†åŠŸèƒ½ ===
// âœ… ä¿®æ”¹å¾Œï¼šé‡æ–°æ•´ç†æ™‚åŒæ­¥æ›´æ–°å¿«å–
function refreshInventory() {
    if (!checkPermission('s2')) {
        alert('æ¬Šé™ä¸è¶³');
        return;
    }
    
    showLoading('æ­£åœ¨é‡æ–°æ•´ç†åº«å­˜è³‡æ–™...');
    
    callAPI('getInventory')
        .then(data => {
            hideLoading();
            systemData.inventory = data.items || [];  // âœ… æ›´æ–°å¿«å–
            systemData.lastUpdate = new Date();  // âœ… æ›´æ–°æ™‚é–“
            
            displayInventory();
        })
        .catch(error => {
            hideLoading();
            console.error('Inventory error:', error);
            alert('é‡æ–°æ•´ç†å¤±æ•—ï¼š' + error.message);
        });
}

        
function displayInventory() {
    const tbody = document.getElementById('inventoryTableBody');
    
    // âœ… æ›´æ–°å» å•†ä¸‹æ‹‰é¸å–®
    updateSupplierFilter();
    
    // âœ… æ›´æ–°çµ±è¨ˆ
    updateFilterStats(systemData.inventory.length, systemData.inventory.length);
    
    // âœ… æ‡‰ç”¨ç¯©é¸
    filterInventory();
}

// âœ… æ–°å¢ï¼šæ›´æ–°å» å•†ä¸‹æ‹‰é¸å–®
function updateSupplierFilter() {
    const supplierFilter = document.getElementById('supplierFilter');
    if (!supplierFilter) return;
    
    // å–å¾—æ‰€æœ‰å”¯ä¸€çš„å» å•†
    const suppliers = [...new Set(systemData.inventory.map(item => item.supplier).filter(s => s))];
    suppliers.sort(); // æŒ‰å­—æ¯æ’åº
    
    // ä¿å­˜ç•¶å‰é¸æ“‡
    const currentValue = supplierFilter.value;
    
    // æ¸…ç©ºä¸¦é‡å»ºé¸é …
    supplierFilter.innerHTML = '<option value="">å…¨éƒ¨å» å•†</option>';
    suppliers.forEach(supplier => {
        const option = document.createElement('option');
        option.value = supplier;
        option.textContent = supplier;
        supplierFilter.appendChild(option);
    });
    
    // æ¢å¾©é¸æ“‡
    supplierFilter.value = currentValue;
}

// âœ… æ–°å¢ï¼šæ›´æ–°ç¯©é¸çµ±è¨ˆ
function updateFilterStats(filteredCount, totalCount) {
    const filteredCountEl = document.getElementById('filteredCount');
    const totalCountEl = document.getElementById('totalCount');
    
    if (filteredCountEl) filteredCountEl.textContent = filteredCount;
    if (totalCountEl) totalCountEl.textContent = totalCount;
}


        
        function searchInventory() {
    if (checkPermission('s2')) {
        filterInventory(); // çµ±ä¸€ä½¿ç”¨ filterInventory
    }
}

        
function filterInventory() {
    if (!checkPermission('s2')) return;
    
    const tbody = document.getElementById('inventoryTableBody');
    const searchTerm = document.getElementById('inventorySearch')?.value.toLowerCase() || '';
    const tempFilter = document.getElementById('tempFilter')?.value || '';
    const supplierFilter = document.getElementById('supplierFilter')?.value || '';
    const statusFilter = document.getElementById('statusFilter')?.value || '';
    const shipDateFilter = document.getElementById('shipDateFilter')?.value || '';
    
    let filtered = systemData.inventory;
    
    // 1ï¸âƒ£ æœå°‹éæ¿¾ï¼ˆSKU æˆ–å“åï¼‰
    if (searchTerm) {
        filtered = filtered.filter(item => 
            (item.sku && item.sku.toLowerCase().includes(searchTerm)) || 
            (item.name && item.name.toLowerCase().includes(searchTerm))
        );
    }
    
    // 2ï¸âƒ£ æº«å±¤éæ¿¾
    if (tempFilter) {
        filtered = filtered.filter(item => item.tempZone === tempFilter);
    }
    
    // 3ï¸âƒ£ å» å•†éæ¿¾
    if (supplierFilter) {
        filtered = filtered.filter(item => item.supplier === supplierFilter);
    }
    
    // 4ï¸âƒ£ ç‹€æ…‹éæ¿¾
    if (statusFilter) {
        filtered = filtered.filter(item => {
            const stock = parseFloat(item.stock) || 0;
            const safetyStock = parseFloat(item.safetyStock) || 0;
            const midLowPoint = parseFloat(item.midLowPoint) || 0;
            
            let status = 'normal';
            if (stock <= safetyStock) {
                status = 'danger';
            } else if (stock <= midLowPoint) {
                status = 'warning';
            }
            
            return status === statusFilter;
        });
    }
    
    // 5ï¸âƒ£ å‡ºè²¨æ—¥æœŸéæ¿¾
    if (shipDateFilter) {
        filtered = filterByShipDate(filtered, shipDateFilter);
    }
    
    // âœ… æ›´æ–°çµ±è¨ˆè³‡è¨Š
    updateFilterStats(filtered.length, systemData.inventory.length);
    
    // âœ… æ›´æ–°æ—¥æœŸç¯©é¸è³‡è¨Š
    updateDateFilterInfo(shipDateFilter);
    
    // æ¸²æŸ“è¡¨æ ¼
    tbody.innerHTML = filtered.map(item => {
        // ç‹€æ…‹åˆ¤æ–·é‚è¼¯
        const stock = parseFloat(item.stock) || 0;
        const safetyStock = parseFloat(item.safetyStock) || 0;
        const midLowPoint = parseFloat(item.midLowPoint) || 0;
        
        let status = 'normal';
        let statusText = 'âœ… æ­£å¸¸';
        
        if (stock <= safetyStock) {
            status = 'danger';
            statusText = 'ğŸ”´ ä½æ–¼å®‰å…¨åº«å­˜';
        } else if (stock <= midLowPoint) {
            status = 'warning';
            statusText = 'ğŸŸ¡ ä½æ–¼ä¸­ä½é»';
        }
        
        // âœ… å‡ºè²¨æ—¥æœŸæ¨™è¨˜ï¼ˆå¦‚æœæ˜¯ä»Šå¤©æˆ–å·²é€¾æœŸï¼Œç‰¹åˆ¥æ¨™ç¤ºï¼‰
        let shipDateDisplay = item.shipDate || '';
        const shipDateClass = getShipDateClass(item.shipDate);
        if (shipDateClass) {
            shipDateDisplay = `<span style="${shipDateClass}">${item.shipDate || ''}</span>`;
        }
        
        return `
            <tr>
                <td>${item.sku || ''}</td>
                <td>${item.name || ''}</td>
                <td>${item.purchaseDate || ''}</td>
                <td>${item.batchExpiry || ''}</td>
                <td>${item.previousStock || 0}</td>
                <td>${item.shipmentQty || 0}</td>
                <td>${item.returnQty || 0}</td>
                <td>${item.receiveQty || 0}</td>
                <td class="editable-cell" onclick="editCell(this, '${item.sku}', 'stock')">${stock}</td>
                <td>${item.acceptDate || ''}</td>
                <td>${item.acceptDays || 0}</td>
                <td>${item.validDays || 0}</td>
                <td>${shipDateDisplay}</td>
                <td>${item.supplier || ''}</td>
                <td class="editable-cell" onclick="editCell(this, '${item.sku}', 'safetyStock')">${safetyStock}</td>
                <td class="editable-cell" onclick="editCell(this, '${item.sku}', 'midLowPoint')">${midLowPoint}</td>
                <td>${item.tempZone || ''}</td>
                <td><span class="status-badge status-${status}">${statusText}</span></td>
                <td>
                    <button class="btn btn-primary" style="padding: 5px 10px;" onclick="updateInventoryItem('${item.sku}')">æ›´æ–°</button>
                    <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteInventoryItem('${item.sku}')">åˆªé™¤</button>
                </td>
            </tr>
        `;
    }).join('');
    
    // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºæç¤º
    if (filtered.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="19" style="text-align: center; padding: 40px; color: #9ca3af;">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“­</div>
                    <div style="font-size: 16px; font-weight: bold;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</div>
                    <div style="font-size: 14px; margin-top: 8px; color: #6b7280;">è«‹èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–æ–°å¢åº«å­˜è³‡æ–™</div>
                </td>
            </tr>
        `;
    }
}

// âœ… æ–°å¢ï¼šå‡ºè²¨æ—¥æœŸç¯©é¸é‚è¼¯
// âœ… ä¿®æ­£ç‰ˆï¼šå‡ºè²¨æ—¥æœŸç¯©é¸é‚è¼¯
function filterByShipDate(items, filterType) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // é¡¯ç¤º/éš±è—è‡ªè¨‚æ—¥æœŸç¯„åœ
    const customDateRange = document.getElementById('customDateRange');
    if (customDateRange) {
        customDateRange.style.display = filterType === 'custom' ? 'block' : 'none';
    }
    
    return items.filter(item => {
        if (!item.shipDate) return false;
        
        const shipDate = parseDate(item.shipDate);
        if (!shipDate) return false;
        
        // âœ… é‡è¦ï¼šå°‡ shipDate ä¹Ÿè¨­å®šç‚º 00:00:00ï¼Œç¢ºä¿åªæ¯”è¼ƒæ—¥æœŸ
        shipDate.setHours(0, 0, 0, 0);
        
        switch(filterType) {
            case 'today':
                return isSameDay(shipDate, today);
                
            case 'tomorrow':
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                return isSameDay(shipDate, tomorrow);
                
                case 'week':
                    // æ‰¾åˆ°æœ¬é€±ä¸€
                    const weekStart = new Date(today);
                    const dayOfWeek = weekStart.getDay();
                    const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // é€±æ—¥ç‰¹æ®Šè™•ç†
                    weekStart.setDate(weekStart.getDate() + diff);
                    weekStart.setHours(0, 0, 0, 0);
                    
                    // æœ¬é€±æ—¥
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    weekEnd.setHours(23, 59, 59, 999);
                    
                    return shipDate >= weekStart && shipDate <= weekEnd;


                
            case 'month':
                // âœ… ä¿®æ­£ï¼šç¯©é¸ã€Œæœ¬æœˆå…§ã€çš„æ‰€æœ‰æ—¥æœŸï¼Œä¸é™æ–¼ä»Šå¤©ä¹‹å¾Œ
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                monthStart.setHours(0, 0, 0, 0);
                monthEnd.setHours(23, 59, 59, 999); // è¨­å®šç‚ºç•¶æœˆæœ€å¾Œä¸€å¤©çš„æœ€å¾Œä¸€åˆ»
                
                return shipDate >= monthStart && shipDate <= monthEnd;
                
            case 'overdue':
                return shipDate < today;
                
            case 'custom':
                const startDate = document.getElementById('startDate')?.value;
                const endDate = document.getElementById('endDate')?.value;
                
                if (!startDate && !endDate) return true;
                
                const start = startDate ? new Date(startDate) : new Date('1900-01-01');
                const end = endDate ? new Date(endDate) : new Date('2100-12-31');
                
                // âœ… è¨­å®šæ™‚é–“ç‚º 00:00:00 å’Œ 23:59:59
                start.setHours(0, 0, 0, 0);
                end.setHours(23, 59, 59, 999);
                
                return shipDate >= start && shipDate <= end;
                
            default:
                return true;
        }
    });
}

// âœ… æ–°å¢ï¼šè§£ææ—¥æœŸå­—ä¸²
function parseDate(dateStr) {
    if (!dateStr) return null;
    
    // è™•ç† YYYY/M/D æ ¼å¼
    if (typeof dateStr === 'string' && dateStr.match(/^\d{4}\/\d{1,2}\/\d{1,2}$/)) {
        const parts = dateStr.split('/');
        return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    }
    
    // è™•ç† Date ç‰©ä»¶
    if (dateStr instanceof Date) {
        return dateStr;
    }
    
    // å˜—è©¦ä¸€èˆ¬è§£æ
    const date = new Date(dateStr);
    return isNaN(date.getTime()) ? null : date;
}

// âœ… æ–°å¢ï¼šåˆ¤æ–·æ˜¯å¦ç‚ºåŒä¸€å¤©
function isSameDay(date1, date2) {
    return date1.getFullYear() === date2.getFullYear() &&
           date1.getMonth() === date2.getMonth() &&
           date1.getDate() === date2.getDate();
}

// âœ… æ–°å¢ï¼šå–å¾—å‡ºè²¨æ—¥æœŸæ¨£å¼
function getShipDateClass(shipDateStr) {
    if (!shipDateStr) return '';
    
    const shipDate = parseDate(shipDateStr);
    if (!shipDate) return '';
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (shipDate < today) {
        return 'color: #dc3545; font-weight: bold;'; // å·²é€¾æœŸï¼šç´…è‰²
    } else if (isSameDay(shipDate, today)) {
        return 'color: #ffc107; font-weight: bold;'; // ä»Šå¤©ï¼šé»ƒè‰²
    }
    
    return '';
}

// âœ… æ–°å¢ï¼šæ›´æ–°æ—¥æœŸç¯©é¸è³‡è¨Š
function updateDateFilterInfo(filterType) {
    const dateFilterInfo = document.getElementById('dateFilterInfo');
    if (!dateFilterInfo) return;
    
    const filterNames = {
        'today': 'ğŸ“Œ ä»Šå¤©å‡ºè²¨',
        'tomorrow': 'â¡ï¸ æ˜å¤©å‡ºè²¨',
        'week': 'ğŸ“† æœ¬é€±å‡ºè²¨',
        'month': 'ğŸ“… æœ¬æœˆå‡ºè²¨',
        'overdue': 'âš ï¸ å·²é€¾æœŸ',
        'custom': 'ğŸ”§ è‡ªè¨‚æ—¥æœŸç¯„åœ'
    };
    
    if (filterType && filterNames[filterType]) {
        dateFilterInfo.textContent = `| ç¯©é¸: ${filterNames[filterType]}`;
    } else {
        dateFilterInfo.textContent = '';
    }
}

// âœ… æ–°å¢ï¼šæ¸…é™¤è‡ªè¨‚æ—¥æœŸ
function clearCustomDate() {
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    filterInventory();
}


        
        function addNewInventory() {
            if (!checkPermission('s2')) {
                alert('æ¬Šé™ä¸è¶³');
                return;
            }
            
            showModal('æ–°å¢åº«å­˜', `
                <div class="form-group">
                    <label>SKU</label>
                    <input type="text" class="form-control" id="newSKU">
                </div>
                <div class="form-group">
                    <label>å“å</label>
                    <input type="text" class="form-control" id="newName">
                </div>
                <div class="form-group">
                    <label>æº«å±¤</label>
                    <select class="form-control" id="newTempZone">
                        <option value="å†·å‡">å†·å‡ (-18Â°C)</option>
                        <option value="å†·è—">å†·è— (4Â°C)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>åˆå§‹åº«å­˜</label>
                    <input type="number" class="form-control" id="newStock" value="0">
                </div>
                <button class="btn btn-primary" onclick="saveNewInventory()">å„²å­˜</button>
            `);
        }
        
        function saveNewInventory() {
            if (!checkPermission('s2')) return;
            
            const data = {
                sku: document.getElementById('newSKU').value,
                name: document.getElementById('newName').value,
                tempZone: document.getElementById('newTempZone').value,
                currentStock: parseInt(document.getElementById('newStock').value) || 0
            };
            
            callAPI('addInventory', data)
                .then(result => {
                    closeModal();
                    refreshInventory();
                    alert('åº«å­˜æ–°å¢æˆåŠŸï¼');
                })
                .catch(error => {
                    alert('æ–°å¢å¤±æ•—: ' + error.message);
                });
        }
        
        // === éœ€æ±‚è¨­å®šåŠŸèƒ½ ===
        function saveDemand() {
            if (!checkPermission('s3')) {
                alert('æ¬Šé™ä¸è¶³');
                return;
            }
            
            const data = {
                sku: document.getElementById('demandSKU').value,
                name: document.getElementById('demandName').value,
                customer: document.getElementById('demandCustomer').value,
                serviceLevel: document.getElementById('demandServiceLevel').value,
                dailyDemand: parseFloat(document.getElementById('demandDaily').value) || 0,
                leadTime: parseInt(document.getElementById('demandLeadTime').value) || 7
            };
            
            if (!data.sku || !data.name) {
                alert('è«‹å¡«å¯« SKU å’Œå“å');
                return;
            }
            
            callAPI('saveDemand', data)
                .then(result => {
                    alert('éœ€æ±‚è¨­å®šå·²å„²å­˜ï¼');
                    document.getElementById('demandSKU').value = '';
                    document.getElementById('demandName').value = '';
                    document.getElementById('demandDaily').value = '';
                    loadDemands();
                })
                .catch(error => {
                    alert('å„²å­˜å¤±æ•—: ' + error.message);
                });
        }
        
        function loadDemands() {
            if (!checkPermission('s3')) return;
            
            callAPI('getDemands')
                .then(data => {
                    systemData.demands = data.demands || [];
                    displayDemands();
                })
                .catch(error => {
                    console.error('Demands error:', error);
                });
        }
        
        function displayDemands() {
            const tbody = document.getElementById('demandTableBody');
            
            tbody.innerHTML = systemData.demands.map(demand => `
                <tr>
                    <td>${demand.sku}</td>
                    <td>${demand.name}</td>
                    <td>${demand.customer}</td>
                    <td>${demand.serviceLevel}</td>
                    <td>${demand.dailyDemand}</td>
                    <td>${demand.leadTime}å¤©</td>
                    <td>${demand.safetyStock || 0}</td>
                    <td>${demand.rop || 0}</td>
                    <td>
                        <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteDemand('${demand.sku}')">åˆªé™¤</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // === AIé æ¸¬åŠŸèƒ½ ===
        function runPrediction() {
            if (!checkPermission('s3')) {
                alert('æ¬Šé™ä¸è¶³');
                return;
            }
            
            const period = document.getElementById('predictionPeriod').value;
            const method = document.getElementById('predictionMethod').value;
            
            callAPI('runPrediction', {
                period: period,
                method: method,
                seasonal: document.getElementById('seasonalFactor').checked,
                promotion: document.getElementById('promotionFactor').checked,
                weather: document.getElementById('weatherFactor').checked
            })
                .then(result => {
                    document.getElementById('predictionSummary').innerHTML = `
                        <p><strong>é æ¸¬å®Œæˆï¼</strong></p>
                        <p>è™•ç†å“é …æ•¸: ${result.itemCount || 0}</p>
                        <p>é æ¸¬æœŸé–“: ${period}å¤©</p>
                        <p>å¹³å‡æº–ç¢ºåº¦: ${result.accuracy || 95}%</p>
                    `;
                    loadPredictions();
                })
                .catch(error => {
                    alert('é æ¸¬å¤±æ•—: ' + error.message);
                });
        }
        
        function loadPredictions() {
            if (!checkPermission('s3')) return;
            
            callAPI('getPredictions')
                .then(data => {
                    systemData.predictions = data.predictions || [];
                    displayPredictions();
                })
                .catch(error => {
                    console.error('Predictions error:', error);
                });
        }
        
        function displayPredictions() {
            const tbody = document.getElementById('predictionTableBody');
            
            tbody.innerHTML = systemData.predictions.map(pred => `
                <tr>
                    <td>${pred.sku}</td>
                    <td>${pred.name}</td>
                    <td>${pred.period}å¤©</td>
                    <td>${pred.forecast}</td>
                    <td>${pred.stdDev}</td>
                    <td>${pred.confidenceInterval}</td>
                    <td>${pred.action}</td>
                </tr>
            `).join('');
        }
        
        // === è£œå–®ç®¡ç†åŠŸèƒ½ ===
function generateReplenishment() {
    if (!checkPermission('s3')) {
        alert('æ¬Šé™ä¸è¶³');
        return;
    }
    
    showLoading();
    
    // â­ ç›´æ¥è®€å– Google Sheet çš„ã€è£œå–®å»ºè­°ã€‘å·¥ä½œè¡¨
    callAPI('getReplenishments')
        .then(result => {
            hideLoading();
            const count = result.suggestions?.length || 0;
            alert(`å·²è¼‰å…¥ ${count} ç­†è£œå–®å»ºè­°`);
            systemData.replenishments = result.suggestions || [];
            displayReplenishments();
        })
        .catch(error => {
            hideLoading();
            alert('è¼‰å…¥è£œå–®å¤±æ•—: ' + error.message);
        });
}

        
function loadReplenishments() {
    if (!checkPermission('s3')) return;
    
    showLoading();
    
    callAPI('getReplenishments')
        .then(data => {
            hideLoading();
            systemData.replenishments = data.suggestions || [];
            displayReplenishments();
        })
        .catch(error => {
            hideLoading();
            console.error('Replenishments error:', error);
            alert('è¼‰å…¥è£œå–®å»ºè­°å¤±æ•—: ' + error.message);
        });
}

        
function displayReplenishments() {
    const tbody = document.getElementById('replenishmentTableBody');
    
    // âœ… æ›´æ–°å» å•†ä¸‹æ‹‰é¸å–®
    updateReplenishmentSupplierFilter();
    
    // âœ… æ›´æ–°çµ±è¨ˆ
    updateReplenishmentStats(systemData.replenishments.length, systemData.replenishments.length);
    
    // âœ… æ‡‰ç”¨ç¯©é¸
    filterReplenishment();
}

// âœ… æ–°å¢ï¼šæ›´æ–°å» å•†ä¸‹æ‹‰é¸å–®
function updateReplenishmentSupplierFilter() {
    const supplierFilter = document.getElementById('replenishmentSupplierFilter');
    if (!supplierFilter) return;
    
    // å–å¾—æ‰€æœ‰å”¯ä¸€çš„å» å•†
    const suppliers = [...new Set(systemData.replenishments.map(item => item.supplier).filter(s => s))];
    suppliers.sort();
    
    // ä¿å­˜ç•¶å‰é¸æ“‡
    const currentValue = supplierFilter.value;
    
    // æ¸…ç©ºä¸¦é‡å»ºé¸é …
    supplierFilter.innerHTML = '<option value="">å…¨éƒ¨å» å•†</option>';
    suppliers.forEach(supplier => {
        const option = document.createElement('option');
        option.value = supplier;
        option.textContent = supplier;
        supplierFilter.appendChild(option);
    });
    
    // æ¢å¾©é¸æ“‡
    supplierFilter.value = currentValue;
}
        // âœ… æ–°å¢ï¼šç¯©é¸è£œå–®æ¸…å–®
function filterReplenishment() {
    if (!checkPermission('s3')) return;
    
    const tbody = document.getElementById('replenishmentTableBody');
    const searchTerm = document.getElementById('replenishmentSearch')?.value.toLowerCase() || '';
    const tempFilter = document.getElementById('replenishmentTempFilter')?.value || '';
    const supplierFilter = document.getElementById('replenishmentSupplierFilter')?.value || '';
    const statusFilter = document.getElementById('replenishmentStatusFilter')?.value || '';
    
    let filtered = systemData.replenishments;
    
    // 1ï¸âƒ£ æœå°‹éæ¿¾
    if (searchTerm) {
        filtered = filtered.filter(item => 
            (item.sku && item.sku.toLowerCase().includes(searchTerm)) || 
            (item.name && item.name.toLowerCase().includes(searchTerm))
        );
    }
    
    // 2ï¸âƒ£ æº«å±¤éæ¿¾
    if (tempFilter) {
        filtered = filtered.filter(item => item.tempZone === tempFilter);
    }
    
    // 3ï¸âƒ£ å» å•†éæ¿¾
    if (supplierFilter) {
        filtered = filtered.filter(item => item.supplier === supplierFilter);
    }
    
    // 4ï¸âƒ£ ç‹€æ…‹éæ¿¾
    if (statusFilter) {
        filtered = filtered.filter(item => {
            const stock = parseFloat(item.currentStock) || 0;
            const safetyStock = parseFloat(item.safetyStock) || 0;
            const rop = parseFloat(item.rop) || 0;
            
            let status = 'normal';
            if (stock <= safetyStock) {
                status = 'danger';
            } else if (stock <= rop) {
                status = 'warning';
            }
            
            return status === statusFilter;
        });
    }
    
    // âœ… æ›´æ–°çµ±è¨ˆè³‡è¨Š
    updateReplenishmentStats(filtered.length, systemData.replenishments.length);
    
    // æ¸²æŸ“è¡¨æ ¼
    tbody.innerHTML = filtered.map(item => {
        // ç‹€æ…‹åˆ¤æ–·
        const stock = parseFloat(item.currentStock) || 0;
        const safetyStock = parseFloat(item.safetyStock) || 0;
        const rop = parseFloat(item.rop) || 0;
        
        let status = 'normal';
        let statusText = 'âœ… æ­£å¸¸';
        let statusClass = 'status-normal';
        
        if (stock <= safetyStock) {
            status = 'danger';
            statusText = 'ğŸ”´ ä½æ–¼å®‰å…¨åº«å­˜';
            statusClass = 'status-danger';
        } else if (stock <= rop) {
            status = 'warning';
            statusText = 'ğŸŸ¡ ä½æ–¼ä¸­ä½é»';
            statusClass = 'status-warning';
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        const formatDate = (date) => {
            if (!date) return '-';
            if (typeof date === 'string' && date.match(/^\d{4}\/\d{1,2}\/\d{1,2}$/)) {
                return date;
            }
            const d = new Date(date);
            return isNaN(d.getTime()) ? date : d.toLocaleDateString('zh-TW');
        };
        
        return `
            <tr>
                <td><input type="checkbox" value="${item.sku}" class="replenishment-check"></td>
                <td>${item.sku || ''}</td>
                <td>${item.name || ''}</td>
                <td>${formatDate(item.purchaseDate)}</td>
                <td>${item.batchExpiry || ''}</td>
                <td>${item.previousStock || 0}</td>
                <td>${item.shipmentTotal || 0}</td>
                <td>${item.returns || 0}</td>
                <td>${item.incoming || 0}</td>
                <td>${stock}</td>
                <td>${formatDate(item.acceptanceDate)}</td>
                <td>${item.acceptanceDays || '-'}</td>
                <td>${item.validDays || '-'}</td>
                <td>${formatDate(item.shipmentDate)}</td>
                <td>${item.supplier || ''}</td>
                <td>${safetyStock}</td>
                <td>${rop}</td>
                <td>${item.tempZone || ''}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>
                    <button class="btn btn-success" style="padding: 5px 10px;" 
                            onclick="approveReplenishment('${item.sku}')">âœ… æ ¸å‡†</button>
                </td>
            </tr>
        `;
    }).join('');
    
    // å¦‚æœæ²’æœ‰è³‡æ–™
    if (filtered.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="20" style="text-align: center; padding: 40px; color: #9ca3af;">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“­</div>
                    <div style="font-size: 16px; font-weight: bold;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è£œå–®å»ºè­°</div>
                    <div style="font-size: 14px; margin-top: 8px; color: #6b7280;">è«‹èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–é‡æ–°è¼‰å…¥è³‡æ–™</div>
                </td>
            </tr>
        `;
    }
}

// âœ… æ–°å¢ï¼šæ¸…é™¤ç¯©é¸
function clearReplenishmentFilters() {
    document.getElementById('replenishmentSearch').value = '';
    document.getElementById('replenishmentTempFilter').value = '';
    document.getElementById('replenishmentSupplierFilter').value = '';
    document.getElementById('replenishmentStatusFilter').value = '';
    filterReplenishment();
}


// âœ… æ–°å¢ï¼šæ›´æ–°çµ±è¨ˆè³‡è¨Š
function updateReplenishmentStats(filteredCount, totalCount) {
    const filteredCountEl = document.getElementById('replenishmentFilteredCount');
    const totalCountEl = document.getElementById('replenishmentTotalCount');
    
    if (filteredCountEl) filteredCountEl.textContent = filteredCount;
    if (totalCountEl) totalCountEl.textContent = totalCount;
}

        
        function selectAllReplenishments() {
            if (!checkPermission('s3')) return;
            
            const selectAll = document.getElementById('selectAll').checked;
            document.querySelectorAll('.replenishment-check').forEach(cb => {
                cb.checked = selectAll;
            });
        }
        
        function approveReplenishment(sku) {
            if (!checkPermission('s3')) {
                alert('æ¬Šé™ä¸è¶³');
                return;
            }
            
            callAPI('approveReplenishment', { skus: [sku] })
                .then(result => {
                    alert('è£œå–®å·²æ ¸å‡†ï¼');
                    loadReplenishments();
                })
                .catch(error => {
                    alert('æ ¸å‡†å¤±æ•—: ' + error.message);
                });
        }
        
        function approveAllSuggestions() {
            if (!checkPermission('s3')) {
                alert('æ¬Šé™ä¸è¶³');
                return;
            }
            
            const selected = [];
            document.querySelectorAll('.replenishment-check:checked').forEach(cb => {
                selected.push(cb.value);
            });
            
            if (selected.length === 0) {
                alert('è«‹é¸æ“‡è¦æ ¸å‡†çš„é …ç›®');
                return;
            }
            
            callAPI('approveReplenishment', { skus: selected })
                .then(result => {
                    alert(`å·²æ ¸å‡† ${selected.length} ç­†è£œå–®`);
                    loadReplenishments();
                })
                .catch(error => {
                    alert('æ ¸å‡†å¤±æ•—: ' + error.message);
                });
        }
        
        // === å€‰å®¹ç®¡ç† ===
        function loadCapacity() {
            if (!checkPermission('s3')) return;
            
            console.log('é–‹å§‹è¼‰å…¥å€‰å®¹è³‡æ–™...');
            
            callAPI('getCapacity')
                .then(data => {
                    console.log('å€‰å®¹è³‡æ–™è¼‰å…¥æˆåŠŸ:', data);
                    systemData.capacity = data;
                    
                    if (!data.freezers || data.freezers.length === 0) {
                        console.warn('å†·å‡åº«è³‡æ–™ç‚ºç©ºï¼Œå˜—è©¦åˆå§‹åŒ–...');
                        return callAPI('initializeSystem');
                    }
                    
                    displayCapacity();
                })
                .then(result => {
                    if (result) {
                        console.log('ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼Œé‡æ–°è¼‰å…¥å€‰å®¹è³‡æ–™');
                        return callAPI('getCapacity');
                    }
                })
                .then(data => {
                    if (data) {
                        systemData.capacity = data;
                        displayCapacity();
                    }
                })
                .catch(error => {
                    console.error('å€‰å®¹è³‡æ–™è¼‰å…¥å¤±æ•—:', error);
                    
                    const freezerContainer = document.getElementById('freezerCapacity');
                    const coolerContainer = document.getElementById('coolerCapacity');
                    
                    const errorMessage = `
                        <div class="card" style="background: #f8d7da; color: #721c24;">
                            <div class="card-title">è¼‰å…¥å¤±æ•—</div>
                            <p>ç„¡æ³•è¼‰å…¥å€‰å®¹è³‡æ–™ï¼Œè«‹æª¢æŸ¥ï¼š</p>
                            <ul>
                                <li>ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸</li>
                                <li>Google Apps Script è¨­å®šæ˜¯å¦æ­£ç¢º</li>
                                <li>æ˜¯å¦å·²åŸ·è¡Œç³»çµ±åˆå§‹åŒ–</li>
                            </ul>
                            ${checkPermission('s4') ? '<button class="btn btn-primary" onclick="initializeSystem()">åˆå§‹åŒ–ç³»çµ±</button>' : ''}
                            <button class="btn btn-secondary" onclick="loadCapacity()">é‡æ–°è¼‰å…¥</button>
                        </div>
                    `;
                    
                    if (freezerContainer) {
                        freezerContainer.innerHTML = errorMessage;
                    }
                    if (coolerContainer) {
                        coolerContainer.innerHTML = '<p>è«‹å…ˆè§£æ±ºå†·å‡åº«è³‡æ–™è¼‰å…¥å•é¡Œ</p>';
                    }
                });
        }
        
function displayCapacity() {
    console.log('é–‹å§‹é¡¯ç¤ºå€‰å®¹è³‡æ–™:', systemData.capacity);
    
    const freezerContainer = document.getElementById('freezerCapacity');
    if (!freezerContainer) {
        console.error('æ‰¾ä¸åˆ° freezerCapacity å®¹å™¨');
        return;
    }
    
    const freezers = systemData.capacity.freezers || [];
    if (freezers.length === 0) {
        freezerContainer.innerHTML = `
            <div class="card">
                <div class="card-title">ç„¡è³‡æ–™</div>
                <p>å°šæœªå»ºç«‹å†·å‡åº«è³‡æ–™</p>
                ${checkPermission('s4') ? '<button class="btn btn-primary" onclick="initializeSystem()">åˆå§‹åŒ–ç³»çµ±</button>' : ''}
            </div>
        `;
    } else {
        freezerContainer.innerHTML = freezers.map((wh, index) => {
            // âœ… ä¿®æ­£ï¼šå°‡ç™¾åˆ†æ¯”æ ¼å¼åŒ–ç‚ºæ•´æ•¸
            const usageRate = Math.round(parseFloat(wh.usageRate) || 0);
            const bgColor = usageRate > 85 ? '#f44336' : '#667eea';
            
            return `
                <div class="card">
                    <div class="card-title">${wh.name || `å†·å‡åº« #${index + 1}`}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${usageRate}%; background: ${bgColor}">${usageRate}%</div>
                    </div>
                    <div class="kpi-label">${wh.usedPallets || 0}/${wh.totalPallets || 0} æ£§æ¿ä½</div>
                    <small style="color: #666;">æ›´æ–°æ™‚é–“: ${wh.updateTime ? new Date(wh.updateTime).toLocaleString('zh-TW') : 'æœªçŸ¥'}</small>
                </div>
            `;
        }).join('');
    }
    
    const coolerContainer = document.getElementById('coolerCapacity');
    if (!coolerContainer) {
        console.error('æ‰¾ä¸åˆ° coolerCapacity å®¹å™¨');
        return;
    }
    
    const coolers = systemData.capacity.coolers || [];
    if (coolers.length === 0) {
        coolerContainer.innerHTML = `
            <div class="card">
                <div class="card-title">ç„¡è³‡æ–™</div>
                <p>å°šæœªå»ºç«‹å†·è—åº«è³‡æ–™</p>
                ${checkPermission('s4') ? '<button class="btn btn-primary" onclick="initializeSystem()">åˆå§‹åŒ–ç³»çµ±</button>' : ''}
            </div>
        `;
    } else {
        coolerContainer.innerHTML = coolers.map((wh, index) => {
            // âœ… ä¿®æ­£ï¼šå°‡ç™¾åˆ†æ¯”æ ¼å¼åŒ–ç‚ºæ•´æ•¸
            const usageRate = Math.round(parseFloat(wh.usageRate) || 0);
            const bgColor = usageRate > 85 ? '#f44336' : '#667eea';
            
            return `
                <div class="card">
                    <div class="card-title">${wh.name || `å†·è—åº« #${index + 1}`}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${usageRate}%; background: ${bgColor}">${usageRate}%</div>
                    </div>
                    <div class="kpi-label">${wh.usedPallets || 0}/${wh.totalPallets || 0} æ£§æ¿ä½</div>
                    <small style="color: #666;">æ›´æ–°æ™‚é–“: ${wh.updateTime ? new Date(wh.updateTime).toLocaleString('zh-TW') : 'æœªçŸ¥'}</small>
                </div>
            `;
        }).join('');
    }
    
    console.log('å€‰å®¹è³‡æ–™é¡¯ç¤ºå®Œæˆ');
}

        
function testConnection() {
    if (!checkPermission('s4')) {
        alert('æ¬Šé™ä¸è¶³ï¼Œåªæœ‰ç®¡ç†å“¡å¯ä»¥ä¿®æ”¹ç³»çµ±è¨­å®š');
        return;
    }
    
    showLoading();
    fetch(`${GAS_URL}?action=ping`)
        .then(response => response.json())
        .then(data => {
            hideLoading();
            alert('é€£æ¥æˆåŠŸï¼');
        })
        .catch(error => {
            hideLoading();
            alert('é€£æ¥å¤±æ•—: ' + error.message);
        });
}

function saveConnection() {
    if (!checkPermission('s4')) {
        alert('æ¬Šé™ä¸è¶³ï¼Œåªæœ‰ç®¡ç†å“¡å¯ä»¥ä¿®æ”¹ç³»çµ±è¨­å®š');
        return;
    }
    
    const url = document.getElementById('webAppUrl').value;
    if (!url) {
        alert('è«‹è¼¸å…¥ Web App URL');
        return;
    }
    
    // åªæ›´æ–°é¡¯ç¤ºï¼Œä¸å¯¦éš›æ”¹è®Šç³»çµ± URLï¼ˆé™¤éæ‚¨å¸Œæœ›å…è¨±ç®¡ç†å“¡å‹•æ…‹ä¿®æ”¹ï¼‰
    alert('URL é¡¯ç¤ºå·²æ›´æ–°ï¼æ³¨æ„ï¼šå¯¦éš›ç³»çµ± URL éœ€è¦åœ¨ç¨‹å¼ç¢¼ä¸­ä¿®æ”¹');
    
    // å¦‚æœæ‚¨å¸Œæœ›å…è¨±ç®¡ç†å“¡å‹•æ…‹ä¿®æ”¹ URLï¼Œå¯ä»¥åŠ ä¸Šï¼š
    // GAS_URL = url;
    // localStorage.setItem('GAS_URL', url);
    
    checkConnection();
}

        
        function saveConnection() {
            if (!checkPermission('s4')) {
                alert('æ¬Šé™ä¸è¶³ï¼Œåªæœ‰ç®¡ç†å“¡å¯ä»¥ä¿®æ”¹ç³»çµ±è¨­å®š');
                return;
            }
            
            const url = document.getElementById('webAppUrl').value;
            if (!url) {
                alert('è«‹è¼¸å…¥ Web App URL');
                return;
            }
            
            localStorage.setItem('GAS_URL', url);
            GAS_URL = url;
            alert('è¨­å®šå·²å„²å­˜ï¼');
            checkConnection();
        }
        
        function saveSystemSettings() {
            if (!checkPermission('s4')) {
                alert('æ¬Šé™ä¸è¶³ï¼Œåªæœ‰ç®¡ç†å“¡å¯ä»¥ä¿®æ”¹ç³»çµ±è¨­å®š');
                return;
            }
            
            const settings = {
                reviewPeriod: document.getElementById('reviewPeriod').value,
                defaultLeadTime: document.getElementById('defaultLeadTime').value,
                capacityAlert: document.getElementById('capacityAlert').value
            };
            
            callAPI('saveSettings', settings)
                .then(result => {
                    alert('ç³»çµ±åƒæ•¸å·²å„²å­˜ï¼');
                })
                .catch(error => {
                    alert('å„²å­˜å¤±æ•—: ' + error.message);
                });
        }
        
        function initializeSystem() {
            if (!checkPermission('s4')) {
                alert('æ¬Šé™ä¸è¶³ï¼Œåªæœ‰ç®¡ç†å“¡å¯ä»¥åˆå§‹åŒ–ç³»çµ±');
                return;
            }
            
            if (!confirm('ç¢ºå®šè¦åˆå§‹åŒ–ç³»çµ±ï¼Ÿé€™å°‡å»ºç«‹æ‰€æœ‰å¿…è¦çš„å·¥ä½œè¡¨çµæ§‹ã€‚')) {
                return;
            }
            
            callAPI('initializeSystem')
                .then(result => {
                    alert('ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼');
                    refreshDashboard();
                })
                .catch(error => {
                    alert('åˆå§‹åŒ–å¤±æ•—: ' + error.message);
                });
        }
        
        function resetSystem() {
            if (!checkPermission('s4')) {
                alert('æ¬Šé™ä¸è¶³ï¼Œåªæœ‰ç®¡ç†å“¡å¯ä»¥é‡ç½®ç³»çµ±');
                return;
            }
            
            if (!confirm('ç¢ºå®šè¦é‡ç½®ç³»çµ±ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼')) {
                return;
            }
            
            if (!confirm('å†æ¬¡ç¢ºèªï¼šé€™å°‡æ°¸ä¹…åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒï¼Ÿ')) {
                return;
            }
            
            callAPI('resetSystem')
                .then(result => {
                    alert('ç³»çµ±å·²é‡ç½®ï¼');
                    refreshDashboard();
                })
                .catch(error => {
                    alert('é‡ç½®å¤±æ•—: ' + error.message);
                });
        }
        
        // === è¼”åŠ©åŠŸèƒ½ ===
        function runFullAnalysis() {
            if (!checkPermission('s3')) {
                alert('æ¬Šé™ä¸è¶³');
                return;
            }
            
            showModal('åŸ·è¡Œå®Œæ•´åˆ†æ', '<p>æ­£åœ¨åŸ·è¡Œå®Œæ•´åˆ†ææµç¨‹...</p>');
            
            Promise.all([
                callAPI('runPrediction', { period: 30 }),
                callAPI('generateReplenishment'),
                callAPI('analyzeCapacity')
            ])
                .then(results => {
                    closeModal();
                    showModal('åˆ†æå®Œæˆ', `
                        <p><strong>åˆ†æçµæœï¼š</strong></p>
                        <p>âœ… éœ€æ±‚é æ¸¬å®Œæˆï¼š${results[0].itemCount || 0} å€‹å“é …</p>
                        <p>âœ… è£œå–®å»ºè­°ç”¢ç”Ÿï¼š${results[1].count || 0} ç­†</p>
                        <p>âœ… å€‰å®¹åˆ†æå®Œæˆ</p>
                        <button class="btn btn-primary" onclick="closeModal()">ç¢ºå®š</button>
                    `);
                    refreshDashboard();
                })
                .catch(error => {
                    closeModal();
                    alert('åˆ†æå¤±æ•—: ' + error.message);
                });
        }
        
        function generateAllSuggestions() {
            if (!checkPermission('s3')) {
                alert('æ¬Šé™ä¸è¶³');
                return;
            }
            
            callAPI('generateAllSuggestions')
                .then(result => {
                    alert('æ‰€æœ‰å»ºè­°å·²ç”¢ç”Ÿï¼');
                    refreshDashboard();
                })
                .catch(error => {
                    alert('ç”¢ç”Ÿå»ºè­°å¤±æ•—: ' + error.message);
                });
        }
        
        function exportDashboard() {
            if (!checkPermission('s2')) {
                alert('æ¬Šé™ä¸è¶³');
                return;
            }
            
            callAPI('exportDashboard')
                .then(result => {
                    alert('å„€è¡¨æ¿å·²åŒ¯å‡ºè‡³ Google Sheetï¼');
                })
                .catch(error => {
                    alert('åŒ¯å‡ºå¤±æ•—: ' + error.message);
                });
        }
        
        function exportReplenishment() {
            if (!checkPermission('s3')) {
                alert('æ¬Šé™ä¸è¶³');
                return;
            }
            
            callAPI('exportReplenishment')
                .then(result => {
                    alert('è£œå–®å·²åŒ¯å‡ºè‡³ Google Sheetï¼');
                })
                .catch(error => {
                    alert('åŒ¯å‡ºå¤±æ•—: ' + error.message);
                });
        }
        

// æ–°å¢ï¼šè£œå–®å¯„ç™¼å‡½æ•¸
function sendReplenishmentEmail(isTest = false) {
    if (!checkPermission('s3')) {
        alert('æ¬Šé™ä¸è¶³ï¼šéœ€è¦ S3 æˆ–ä»¥ä¸Šæ¬Šé™');
        return;
    }
    
    const confirmMsg = isTest 
        ? 'ç¢ºå®šè¦å¯„é€æ¸¬è©¦è£œå–®åˆ° phycck@gmail.com å—ï¼Ÿ' 
        : 'ç¢ºå®šè¦å¯„é€è£œå–®çµ¦æ‰€æœ‰å» å•†å—ï¼Ÿ';
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    // âœ… æ”¹ç”¨æ–°çš„å‡½æ•¸åç¨±
    const loadingMsg = isTest ? 'æ­£åœ¨å¯„é€æ¸¬è©¦è£œå–®...' : 'æ­£åœ¨å¯„é€è£œå–®çµ¦å» å•†...';
    showEmailLoading(loadingMsg);
    
    callAPI('sendReplenishmentEmail', { isTest: isTest })
        .then(result => {
            hideEmailLoading(); // âœ… æ”¹ç”¨æ–°çš„å‡½æ•¸åç¨±
            
            if (result.status === 'success') {
                let message = `âœ… è£œå–®å¯„ç™¼å®Œæˆï¼\n\n`;
                message += `ğŸ“§ æˆåŠŸå¯„é€ï¼š${result.successCount} å€‹å» å•†\n`;
                
                if (result.skippedCount > 0) {
                    message += `âš ï¸ è·³éï¼ˆç„¡ Emailï¼‰ï¼š${result.skippedCount} å€‹å» å•†\n`;
                    message += `\nè·³éçš„å» å•†ï¼š\n${result.skippedSuppliers.join('\n')}`;
                }
                
                if (isTest) {
                    message += `\n\nğŸ§ª æ¸¬è©¦ä¿¡å·²å¯„é€åˆ°ï¼šphycck@gmail.com`;
                }
                
                alert(message);
                loadReplenishments();
            } else {
                alert('âŒ å¯„é€å¤±æ•—ï¼š' + result.message);
            }
        })
        .catch(error => {
            hideEmailLoading(); // âœ… æ”¹ç”¨æ–°çš„å‡½æ•¸åç¨±
            alert('âŒ å¯„é€å¤±æ•—ï¼š' + error.message);
        });
}



// âœ… ä¿®æ”¹å¾Œï¼šæ”¹åç‚º showEmailLoading
function showEmailLoading(message) {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'emailLoadingOverlay';
    loadingDiv.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    `;
    loadingDiv.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 10px; text-align: center;">
            <div class="spinner" style="margin: 0 auto 15px;"></div>
            <p style="margin-top: 15px; font-size: 16px; color: #333;">${message || 'è™•ç†ä¸­...'}</p>
        </div>
    `;
    document.body.appendChild(loadingDiv);
}

// âœ… ä¿®æ”¹å¾Œï¼šæ”¹åç‚º hideEmailLoading
function hideEmailLoading() {
    const loadingDiv = document.getElementById('emailLoadingOverlay');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}


        
        function editCell(cell, sku, field) {
            if (!checkPermission('s2')) {
                alert('æ¬Šé™ä¸è¶³');
                return;
            }
            
            const currentValue = cell.textContent;
            cell.innerHTML = `<input type="number" value="${currentValue}" onblur="saveCell(this, '${sku}', '${field}')" onkeypress="if(event.keyCode==13) this.blur()">`;
            cell.querySelector('input').focus();
        }
        
        function saveCell(input, sku, field) {
            const newValue = input.value;
            const cell = input.parentElement;
            cell.textContent = newValue;
            
            callAPI('updateInventoryField', {
                sku: sku,
                field: field,
                value: newValue
            }).catch(error => {
                console.error('Update failed:', error);
                cell.textContent = input.defaultValue;
            });
        }
        
        function updateInventoryItem(sku) {
            if (!checkPermission('s2')) {
                alert('æ¬Šé™ä¸è¶³');
                return;
            }
            
            const item = systemData.inventory.find(i => i.sku === sku);
            if (item) {
                callAPI('updateInventory', item)
                    .then(result => {
                        alert('æ›´æ–°æˆåŠŸï¼');
                        refreshInventory();
                    })
                    .catch(error => {
                        alert('æ›´æ–°å¤±æ•—: ' + error.message);
                    });
            }
        }
        
        function deleteInventoryItem(sku) {
            if (!checkPermission('s2')) {
                alert('æ¬Šé™ä¸è¶³');
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${sku} å—ï¼Ÿ`)) {
                return;
            }
            
            callAPI('deleteInventory', { sku: sku })
                .then(result => {
                    alert('åˆªé™¤æˆåŠŸï¼');
                    refreshInventory();
                })
                .catch(error => {
                    alert('åˆªé™¤å¤±æ•—: ' + error.message);
                });
        }
        
        function deleteDemand(sku) {
            if (!checkPermission('s3')) {
                alert('æ¬Šé™ä¸è¶³');
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${sku} çš„éœ€æ±‚è¨­å®šå—ï¼Ÿ`)) {
                return;
            }
            
            callAPI('deleteDemand', { sku: sku })
                .then(result => {
                    alert('åˆªé™¤æˆåŠŸï¼');
                    loadDemands();
                })
                .catch(error => {
                    alert('åˆªé™¤å¤±æ•—: ' + error.message);
                });
        }
        
        function clearPending() {
            if (!checkPermission('s3')) {
                alert('æ¬Šé™ä¸è¶³');
                return;
            }
            
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¾…è™•ç†çš„è£œå–®ï¼Ÿ')) {
                return;
            }
            
            callAPI('clearPendingReplenishments')
                .then(result => {
                    alert('å·²æ¸…é™¤å¾…è™•ç†è£œå–®ï¼');
                    loadReplenishments();
                })
                .catch(error => {
                    alert('æ¸…é™¤å¤±æ•—: ' + error.message);
                });
        }
        
        function viewHistory() {
            if (!checkPermission('s3')) {
                alert('æ¬Šé™ä¸è¶³');
                return;
            }
            
            showModal('æ­·å²é æ¸¬è¨˜éŒ„', '<p>åŠŸèƒ½é–‹ç™¼ä¸­...</p>');
        }
    </script>
</body>
</html>
