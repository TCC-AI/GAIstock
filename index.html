<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜¶é’ç‰©æµGAIå¯„åº«åº«å­˜é‡æ°´ä½è£œå–®ç³»çµ±</title>
    <style>
        /* ç™»å…¥ä»‹é¢æ¨£å¼ */
.login-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
}

.login-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    padding: 0;
    width: 400px;
    max-width: 90vw;
    overflow: hidden;
    animation: slideIn 0.5s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.login-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-align: center;
    padding: 30px 20px;
    position: relative;
}

.login-logo {
    width: 60px;
    height: 60px;
    margin-bottom: 15px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    padding: 10px;
}

.login-header h2 {
    margin: 0 0 5px 0;
    font-size: 1.5em;
    font-weight: bold;
}

.login-header p {
    margin: 0;
    font-size: 0.9em;
    opacity: 0.9;
}

.login-body {
    padding: 40px 30px 30px;
}

.login-body h3 {
    text-align: center;
    color: #333;
    margin-bottom: 30px;
    font-size: 1.3em;
}

.login-btn {
    width: 100%;
    padding: 15px;
    font-size: 1.1em;
    border-radius: 10px;
    margin-top: 20px;
    background: linear-gradient(135deg, #00bcd4 0%, #26c6da 100%);
    border: none;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.login-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(0, 188, 212, 0.3);
}

.login-btn:active {
    transform: translateY(0);
}

.login-footer {
    background: #f8f9fa;
    padding: 15px 30px;
    text-align: center;
}

.connection-status {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 0.9em;
    color: #666;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #4caf50;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* æ¬Šé™ç›¸é—œæ¨£å¼ */
.nav-tab.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

.btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

.user-info {
    position: absolute;
    top: 20px;
    right: 30px;
    color: white;
    font-size: 0.9em;
}

.logout-btn {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 5px 15px;
    border-radius: 15px;
    cursor: pointer;
    margin-left: 10px;
    transition: all 0.3s ease;
}

.logout-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0; /* ç§»é™¤æ‰€æœ‰å¤–è· */
            overflow: hidden; /* æ–°å¢ï¼šé˜²æ­¢æ²è»¸å‡ºç¾ */
        }
        
        .container {
            max-width: 100vw; /* å¯¬åº¦å¡«æ»¿è¦–çª— */
            width: 100%;
            height: 100vh; /* æ–°å¢ï¼šé«˜åº¦å¡«æ»¿è¦–çª— */
            margin: 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0; /* ç§»é™¤åœ“è§’ */
            box-shadow: none; /* ç§»é™¤é™°å½± */
            overflow: hidden;
            display: flex; /* æ–°å¢ï¼šä½¿ç”¨ flexbox */
            flex-direction: column; /* æ–°å¢ï¼šå‚ç›´æ’åˆ— */
        }

        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px; /* æ¸›å°‘ä¸Šä¸‹å…§è· */
            text-align: center;
            flex-shrink: 0; /* æ–°å¢ï¼šé˜²æ­¢å£“ç¸® */
        }
        
                
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .status-indicator {
            display: inline-block;
            padding: 5px 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            margin-top: 10px;
        }
        
        .status-indicator.connected {
            background: #4caf50;
        }
        
        .status-indicator.error {
            background: #f44336;
        }
         .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #667eea;
            overflow-x: auto;
            flex-shrink: 0; /* æ–°å¢ï¼šé˜²æ­¢å£“ç¸® */
        }

        
        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1em;
            transition: all 0.3s ease;
            white-space: nowrap;
            color: #333;
        }
        
        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .nav-tab.active {
            background: white;
            color: #667eea;
            font-weight: bold;
            border-bottom: 3px solid #667eea;
            margin-bottom: -3px;
        }
        
        .content {
            padding: 20px 30px; /* æ¸›å°‘å…§è· */
            flex: 1; /* æ–°å¢ï¼šä½”æ»¿å‰©é¤˜ç©ºé–“ */
            overflow-y: auto; /* æ–°å¢ï¼šå…§å®¹éå¤šæ™‚å¯æ²å‹• */
            min-height: 0; /* æ–°å¢ï¼šå…è¨±ç¸®å° */
        }

        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .card-title {
            font-size: 1.3em;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .kpi-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        
        .kpi-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .alert-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color: white;
        }
        
        .alert-card .card-title {
            color: white;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .status-normal {
            background: #d4edda;
            color: #155724;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading.active {
            display: flex;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5em;
            color: #333;
        }
        
        .close-modal {
            float: right;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }
        
        .close-modal:hover {
            color: #333;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .input-group .form-control {
            flex: 1;
        }
        
        .editable-cell {
            cursor: pointer;
            position: relative;
        }
        
        .editable-cell:hover {
            background: #f0f0f0;
        }
        
        .editable-cell input {
            width: 100%;
            border: 1px solid #667eea;
            padding: 5px;
        }
    </style>
</head>
<body>
    <!-- ç™»å…¥ä»‹é¢ -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9IndoaXRlIj4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9Im5vbmUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiPgo8cGF0aCBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHN0cm9rZS13aWR0aD0iMiIgZD0iTTkgMTJoNm0tNiAwaDZtLTYgMGg2bS02IDBoNiIvPgo8L3N2Zz4KPC9zdmc+Cjwvc3ZnPg==" alt="Logo" class="login-logo">
                <h2>æ˜¶é’ä½æº«ç‰©æµ</h2>
                <p>CHANG CHING COLD CHAIN LOGISTICS</p>
            </div>
            <div class="login-body">
                <h3>æ´¾è»ŠGAIæ•¸æ“šç®¡ç†ç³»çµ±</h3>
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>å¸³è™Ÿ</label>
                        <input type="text" id="loginAccount" class="form-control" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" required>
                    </div>
                    <div class="form-group">
                        <label>å¯†ç¢¼</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required>
                    </div>
                    <button type="submit" class="btn btn-primary login-btn">ç™»å…¥</button>
                </form>
            </div>
            <div class="login-footer">
                <div class="connection-status" id="loginConnectionStatus">
                    <span class="status-dot"></span>
                    å·²é€£ç·š
                </div>
            </div>
        </div>
    </div>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    
    <div class="container" id="mainSystem">
        <div class="header">
            <h1>ğŸ­ æ˜¶é’ç‰©æµGAIå¯„åº«åº«å­˜é‡æ°´ä½è£œå–®ç³»çµ±</h1>
            <p>æ™ºèƒ½åŒ–å†·éˆå€‰å„²ç®¡ç†å¹³å° | 8åº§å†·å‡åº« Â· 5åº§å†·è—åº«</p>
            <div class="status-indicator" id="connectionStatus">
                é€£æ¥ç‹€æ…‹: æª¢æŸ¥ä¸­...
            </div>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">ğŸ“Š ä¸»æ§å°</button>
            <button class="nav-tab" onclick="switchTab('inventory')">ğŸ“¦ å³æ™‚åº«å­˜</button>
            <button class="nav-tab" onclick="switchTab('demand')">ğŸ“ˆ éœ€æ±‚è¨­å®š</button>
            <button class="nav-tab" onclick="switchTab('prediction')">ğŸ¤– AIé æ¸¬åˆ†æ</button>
            <button class="nav-tab" onclick="switchTab('replenishment')">ğŸ“ è£œå–®ç®¡ç†</button>
            <button class="nav-tab" onclick="switchTab('capacity')">ğŸ¢ å€‰å®¹ç›£æ§</button>
            <button class="nav-tab" onclick="switchTab('settings')">âš™ï¸ ç³»çµ±è¨­å®š</button>
        </div>
        
        <div class="content">
            <!-- ä¸»æ§å° -->
            <div id="dashboard" class="tab-content active">
                <h2>å³æ™‚ç‡Ÿé‹ç¸½è¦½</h2>
                <div style="text-align: right; margin-bottom: 20px;">
                    <button class="btn btn-warning" onclick="refreshDashboard()">ğŸ”„ é‡æ–°æ•´ç†</button>
                    <span style="margin-left: 10px; color: #666;" id="lastUpdate">æœ€å¾Œæ›´æ–°: --</span>
                </div>
                
                <div class="dashboard-grid" id="dashboardKPIs">
                    <!-- KPI å¡ç‰‡å°‡å‹•æ…‹è¼‰å…¥ -->
                </div>
                
                <h3>ç³»çµ±å¿«é€Ÿæ“ä½œ</h3>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="runFullAnalysis()">ğŸš€ åŸ·è¡Œå®Œæ•´åˆ†ææµç¨‹</button>
                    <button class="btn btn-success" onclick="generateAllSuggestions()">ğŸ“‹ ç”¢ç”Ÿæ‰€æœ‰å»ºè­°</button>
                    <button class="btn btn-secondary" onclick="exportDashboard()">ğŸ“¥ åŒ¯å‡ºå„€è¡¨æ¿</button>
                </div>
                
                <h3 style="margin-top: 30px;">ç³»çµ±è­¦å ±èˆ‡é€šçŸ¥</h3>
                <div id="alertsContainer">
                    <!-- è­¦å ±å°‡å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
            
            <!-- å³æ™‚åº«å­˜ -->
            <div id="inventory" class="tab-content">
                <h2>å³æ™‚åº«å­˜ç®¡ç†</h2>
                
                <div class="form-group">
                    <div class="input-group">
                        <div style="flex: 1;">
                            <label>å¿«é€Ÿæœå°‹</label>
                            <input type="text" class="form-control" id="inventorySearch" placeholder="è¼¸å…¥SKUæˆ–å“å..." onkeyup="searchInventory()">
                        </div>
                        <div>
                            <label>æº«å±¤ç¯©é¸</label>
                            <select class="form-control" id="tempFilter" onchange="filterInventory()">
                                <option value="">å…¨éƒ¨</option>
                                <option value="å†·å‡">å†·å‡ (-18Â°C)</option>
                                <option value="å†·è—">å†·è— (4Â°C)</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="addNewInventory()">â• æ–°å¢åº«å­˜</button>
                        <button class="btn btn-success" onclick="refreshInventory()">ğŸ”„ é‡æ–°æ•´ç†</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>å“å</th>
                                <th>æº«å±¤</th>
                                <th>ç¾æœ‰åº«å­˜</th>
                                <th>åœ¨é€”é‡</th>
                                <th>å¯ç”¨é‡</th>
                                <th>å®‰å…¨åº«å­˜</th>
                                <th>ç‹€æ…‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            <!-- å‹•æ…‹è¼‰å…¥ -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- éœ€æ±‚è¨­å®š -->
            <div id="demand" class="tab-content">
                <h2>å®¢æˆ¶éœ€æ±‚èˆ‡æœå‹™æ°´æº–è¨­å®š</h2>
                
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-title">æ–°å¢éœ€æ±‚è¨­å®š</div>
                        <div class="form-group">
                            <label>SKUä»£ç¢¼</label>
                            <input type="text" class="form-control" id="demandSKU" placeholder="ä¾‹: SKU001">
                        </div>
                        <div class="form-group">
                            <label>å“å</label>
                            <input type="text" class="form-control" id="demandName" placeholder="ä¾‹: å†·å‡ç‰›è‚‰">
                        </div>
                        <div class="form-group">
                            <label>å®¢æˆ¶</label>
                            <input type="text" class="form-control" id="demandCustomer" placeholder="ä¾‹: å®¢æˆ¶A">
                        </div>
                        <div class="form-group">
                            <label>æœå‹™æ°´æº–</label>
                            <select class="form-control" id="demandServiceLevel">
                                <option value="P">Pç´š (99.5% - z=2.58)</option>
                                <option value="Q" selected>Qç´š (97.5% - z=1.96)</option>
                                <option value="R">Rç´š (95% - z=1.645)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å¹³å‡æ—¥éœ€æ±‚</label>
                            <input type="number" class="form-control" id="demandDaily" placeholder="ä¾‹: 100">
                        </div>
                        <div class="form-group">
                            <label>äº¤æœŸ(å¤©)</label>
                            <input type="number" class="form-control" id="demandLeadTime" value="7">
                        </div>
                        <button class="btn btn-primary" onclick="saveDemand()">å„²å­˜éœ€æ±‚è¨­å®š</button>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">æœå‹™æ°´æº–èªªæ˜</div>
                        <table style="width: 100%;">
                            <tr>
                                <td><strong>Pç´š</strong></td>
                                <td>99.5% æœå‹™æ°´æº–</td>
                                <td>z = 2.58</td>
                            </tr>
                            <tr>
                                <td><strong>Qç´š</strong></td>
                                <td>97.5% æœå‹™æ°´æº–</td>
                                <td>z = 1.96</td>
                            </tr>
                            <tr>
                                <td><strong>Rç´š</strong></td>
                                <td>95% æœå‹™æ°´æº–</td>
                                <td>z = 1.645</td>
                            </tr>
                        </table>
                        
                        <h4 style="margin-top: 20px;">è¨ˆç®—å…¬å¼</h4>
                        <p><strong>å®‰å…¨åº«å­˜(SS)</strong> = z Ã— Ïƒ_L</p>
                        <p><strong>è£œè²¨é»(ROP)</strong> = dÌ„ Ã— LT + SS</p>
                        <p><strong>ç›®æ¨™åº«å­˜</strong> = dÌ„ Ã— (LT + RP) + SS</p>
                        <p style="font-size: 0.9em; color: #666;">
                            å…¶ä¸­ï¼šz=æœå‹™æ°´æº–ä¿‚æ•¸, Ïƒ_L=äº¤æœŸéœ€æ±‚æ¨™æº–å·®, dÌ„=å¹³å‡éœ€æ±‚, LT=äº¤æœŸ, RP=æª¢è¦–é€±æœŸ
                        </p>
                    </div>
                </div>
                
                <h3 style="margin-top: 30px;">å·²è¨­å®šçš„éœ€æ±‚æ¸…å–®</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>å“å</th>
                                <th>å®¢æˆ¶</th>
                                <th>æœå‹™æ°´æº–</th>
                                <th>æ—¥éœ€æ±‚</th>
                                <th>äº¤æœŸ</th>
                                <th>å®‰å…¨åº«å­˜</th>
                                <th>è£œè²¨é»</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="demandTableBody">
                            <!-- å‹•æ…‹è¼‰å…¥ -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- AIé æ¸¬åˆ†æ -->
            <div id="prediction" class="tab-content">
                <h2>AIé æ¸¬åˆ†æå¼•æ“</h2>
                
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-title">é æ¸¬åƒæ•¸è¨­å®š</div>
                        <div class="form-group">
                            <label>é æ¸¬æœŸé–“</label>
                            <select class="form-control" id="predictionPeriod">
                                <option value="7">æœªä¾†7å¤©</option>
                                <option value="14">æœªä¾†14å¤©</option>
                                <option value="30" selected>æœªä¾†30å¤©</option>
                                <option value="60">æœªä¾†60å¤©</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>é æ¸¬æ–¹æ³•</label>
                            <select class="form-control" id="predictionMethod">
                                <option value="MA">ç§»å‹•å¹³å‡æ³•</option>
                                <option value="ES">æŒ‡æ•¸å¹³æ»‘æ³•</option>
                                <option value="ARIMA">ARIMAæ¨¡å‹</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç‰¹æ®Šå› ç´ è€ƒé‡</label>
                            <div>
                                <label><input type="checkbox" id="seasonalFactor"> å­£ç¯€æ€§å› ç´ </label><br>
                                <label><input type="checkbox" id="promotionFactor"> ä¿ƒéŠ·æ´»å‹•</label><br>
                                <label><input type="checkbox" id="weatherFactor"> å¤©æ°£å½±éŸ¿</label>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="runPrediction()">ğŸ¤– åŸ·è¡Œé æ¸¬</button>
                        <button class="btn btn-secondary" onclick="viewHistory()">ğŸ“Š æŸ¥çœ‹æ­·å²</button>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">é æ¸¬çµæœæ‘˜è¦</div>
                        <div id="predictionSummary">
                            <p>å°šæœªåŸ·è¡Œé æ¸¬...</p>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin-top: 30px;">é æ¸¬çµæœè©³æƒ…</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>å“å</th>
                                <th>é æ¸¬æœŸé–“</th>
                                <th>é æ¸¬éœ€æ±‚</th>
                                <th>æ¨™æº–å·®</th>
                                <th>ä¿¡è³´å€é–“</th>
                                <th>å»ºè­°è¡Œå‹•</th>
                            </tr>
                        </thead>
                        <tbody id="predictionTableBody">
                            <!-- å‹•æ…‹è¼‰å…¥ -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- è£œå–®ç®¡ç† -->
            <div id="replenishment" class="tab-content">
                <h2>æ™ºèƒ½è£œå–®ç®¡ç†</h2>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="generateReplenishment()">ğŸ”„ ç”¢ç”Ÿè£œå–®å»ºè­°</button>
                    <button class="btn btn-success" onclick="approveAllSuggestions()">âœ… å…¨éƒ¨æ ¸å‡†</button>
                    <button class="btn btn-warning" onclick="exportReplenishment()">ğŸ“¥ åŒ¯å‡ºè£œå–®</button>
                    <button class="btn btn-danger" onclick="clearPending()">ğŸ—‘ï¸ æ¸…é™¤å¾…è™•ç†</button>
                </div>
                
                <h3>è£œå–®å»ºè­°æ¸…å–®</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll" onchange="selectAllReplenishments()"></th>
                                <th>SKU</th>
                                <th>å“å</th>
                                <th>ç¾æœ‰åº«å­˜</th>
                                <th>å®‰å…¨åº«å­˜</th>
                                <th>è£œè²¨é»</th>
                                <th>å»ºè­°è£œè²¨é‡</th>
                                <th>é è¨ˆé‡‘é¡</th>
                                <th>å„ªå…ˆç´š</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="replenishmentTableBody">
                            <!-- å‹•æ…‹è¼‰å…¥ -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- å€‰å®¹ç›£æ§ -->
            <div id="capacity" class="tab-content">
                <h2>å€‰å®¹å³æ™‚ç›£æ§</h2>
                
                <h3>â„ï¸ å†·å‡åº« (8åº§)</h3>
                <div class="dashboard-grid" id="freezerCapacity">
                    <!-- å‹•æ…‹è¼‰å…¥ -->
                </div>
                
                <h3 style="margin-top: 30px;">ğŸ§Š å†·è—åº« (5åº§)</h3>
                <div class="dashboard-grid" id="coolerCapacity">
                    <!-- å‹•æ…‹è¼‰å…¥ -->
                </div>
                
                <h3 style="margin-top: 30px;">å€‰å®¹åˆ†é…å»ºè­°</h3>
                <div id="capacityRecommendations">
                    <!-- å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
            
            <!-- ç³»çµ±è¨­å®š -->
            <div id="settings" class="tab-content">
                <h2>ç³»çµ±è¨­å®š</h2>
                
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-title">Google Sheet é€£æ¥è¨­å®š</div>
                        <div class="form-group">
                            <label>Sheet ID</label>
                            <input type="text" class="form-control" id="sheetId" value="1Viqk5tApAs9xeT3s9NSN8K5Aej0nEdc53Eqc4dg96ts" readonly>
                        </div>
                        <div class="form-group">
                            <label>Web App URL</label>
                            <input type="text" class="form-control" id="webAppUrl" placeholder="è¼¸å…¥æ‚¨çš„ Google Apps Script Web App URL">
                        </div>
                        <button class="btn btn-primary" onclick="testConnection()">æ¸¬è©¦é€£æ¥</button>
                        <button class="btn btn-success" onclick="saveConnection()">å„²å­˜è¨­å®š</button>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">ç³»çµ±åƒæ•¸</div>
                        <div class="form-group">
                            <label>é è¨­æª¢è¦–é€±æœŸ(å¤©)</label>
                            <input type="number" class="form-control" id="reviewPeriod" value="7">
                        </div>
                        <div class="form-group">
                            <label>é è¨­äº¤æœŸ(å¤©)</label>
                            <input type="number" class="form-control" id="defaultLeadTime" value="7">
                        </div>
                        <div class="form-group">
                            <label>å®¹é‡è­¦æˆ’ç·š(%)</label>
                            <input type="number" class="form-control" id="capacityAlert" value="85">
                        </div>
                        <button class="btn btn-primary" onclick="saveSystemSettings()">å„²å­˜åƒæ•¸</button>
                    </div>
                </div>
                
                <h3 style="margin-top: 30px;">è³‡æ–™åˆå§‹åŒ–</h3>
                <div class="card">
                    <p>é¦–æ¬¡ä½¿ç”¨è«‹åŸ·è¡Œåˆå§‹åŒ–ï¼Œå°‡å»ºç«‹æ‰€æœ‰å¿…è¦çš„å·¥ä½œè¡¨çµæ§‹ã€‚</p>
                    <button class="btn btn-warning" onclick="initializeSystem()">ğŸš€ åˆå§‹åŒ–ç³»çµ±</button>
                    <button class="btn btn-danger" onclick="resetSystem()">âš ï¸ é‡ç½®ç³»çµ±ï¼ˆæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼‰</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">æ¨™é¡Œ</h3>
            </div>
            <div id="modalBody">
                <!-- å‹•æ…‹å…§å®¹ -->
            </div>
        </div>
    </div>
    
    <script>
        // ç³»çµ±é…ç½®
        let GAS_URL = localStorage.getItem('https://script.google.com/macros/s/AKfycbwYs2MPAXORgnuiLTKWJOG1tLVZ8MZiKgX4Bb9mkDPQPMkSVAfRKVQLTJ2tG7xpOHFq/exec') || '';
        const SHEET_ID = '1Viqk5tApAs9xeT3s9NSN8K5Aej0nEdc53Eqc4dg96ts';
         // ç”¨æˆ¶æœƒè©±ç®¡ç†
        let currentUser = null;
        let userLevel = null;

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ç³»çµ±å•Ÿå‹•...');
            // è¼‰å…¥å„²å­˜çš„è¨­å®š
    const savedUrl = localStorage.getItem('GAS_URL');
    if (savedUrl) {
        const webAppUrlElement = document.getElementById('webAppUrl');
        if (webAppUrlElement) {
            webAppUrlElement.value = savedUrl;
        }
        GAS_URL = savedUrl;
    }
            
            // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
            const savedUser = sessionStorage.getItem('currentUser');
            const savedLevel = sessionStorage.getItem('userLevel');
            
            if (savedUser && savedLevel) {
        currentUser = JSON.parse(savedUser);
        userLevel = savedLevel;
        showMainSystem();
        // æª¢æŸ¥é€£æ¥ä¸¦è¼‰å…¥ä¸»æ§å°
        checkConnection();
        refreshDashboard();
    } else {
        showLoginForm();
    }
        });

// é¡¯ç¤ºç™»å…¥è¡¨å–®
function showLoginForm() {
    const loginContainer = document.getElementById('loginContainer');
    const mainSystem = document.getElementById('mainSystem');
    
    if (loginContainer) {
        loginContainer.style.display = 'flex';
    } else {
        console.error('æ‰¾ä¸åˆ° loginContainer å…ƒç´ ');
    }
    
    if (mainSystem) {
        mainSystem.style.display = 'none';
    } else {
        console.error('æ‰¾ä¸åˆ° mainSystem å…ƒç´ ');
    }
}

// é¡¯ç¤ºä¸»ç³»çµ±
function showMainSystem() {
    const loginContainer = document.getElementById('loginContainer');
    const mainSystem = document.getElementById('mainSystem');
    
    if (loginContainer) {
        loginContainer.style.display = 'none';
    } else {
        console.error('æ‰¾ä¸åˆ° loginContainer å…ƒç´ ');
    }
    
    if (mainSystem) {
        mainSystem.style.display = 'flex';
    } else {
        console.error('æ‰¾ä¸åˆ° mainSystem å…ƒç´ ');
    }
    
    // æ›´æ–°ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º
    updateUserInfo();
    
    // æ ¹æ“šæ¬Šé™è¨­å®šä»‹é¢
    applyPermissions();
}

        // ç³»çµ±ç‹€æ…‹
        let systemData = {
            inventory: [],
            demands: [],
            predictions: [],
            replenishments: [],
            capacity: {
                freezers: [],
                coolers: []
            }
        };
        

        
        // æª¢æŸ¥é€£æ¥ç‹€æ…‹
        function checkConnection() {
            const statusEl = document.getElementById('connectionStatus');
            
            if (!GAS_URL) {
                statusEl.textContent = 'é€£æ¥ç‹€æ…‹: æœªè¨­å®š';
                statusEl.className = 'status-indicator error';
                return;
            }
            
            fetch(`${GAS_URL}?action=ping`)
                .then(response => response.json())
                .then(data => {
                    statusEl.textContent = 'é€£æ¥ç‹€æ…‹: å·²é€£æ¥';
                    statusEl.className = 'status-indicator connected';
                })
                .catch(error => {
                    statusEl.textContent = 'é€£æ¥ç‹€æ…‹: é€£æ¥å¤±æ•—';
                    statusEl.className = 'status-indicator error';
                    console.error('Connection error:', error);
                });
        }
        
        // åˆ‡æ›æ¨™ç±¤
        function switchTab(tabName) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => tab.classList.remove('active'));
            
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤æŒ‰éˆ•çš„ active é¡
            const allButtons = document.querySelectorAll('.nav-tab');
            allButtons.forEach(btn => btn.classList.remove('active'));
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤
            document.getElementById(tabName).classList.add('active');
            
            // è¨­ç½®æŒ‰éˆ•ç‚º active
            event.target.classList.add('active');
            
            // è¼‰å…¥å°æ‡‰çš„è³‡æ–™
            loadTabData(tabName);
        }
        
        // è¼‰å…¥æ¨™ç±¤è³‡æ–™
        function loadTabData(tabName) {
            switch(tabName) {
                case 'dashboard':
                    refreshDashboard();
                    break;
                case 'inventory':
                    refreshInventory();
                    break;
                case 'demand':
                    loadDemands();
                    break;
                case 'prediction':
                    loadPredictions();
                    break;
                case 'replenishment':
                    loadReplenishments();
                    break;
                case 'capacity':
                    loadCapacity();
                    break;
            }
        }
        
        // é¡¯ç¤ºè¼‰å…¥ä¸­
        function showLoading() {
            document.getElementById('loading').classList.add('active');
        }
        
        // éš±è—è¼‰å…¥ä¸­
        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }
        
        // é¡¯ç¤º Modal
        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }
        
        // é—œé–‰ Modal
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }
        
        // API å‘¼å«å‡½æ•¸
        function callAPI(action, data = {}) {
            if (!GAS_URL) {
                alert('è«‹å…ˆè¨­å®š Google Apps Script Web App URL');
                switchTab('settings');
                return Promise.reject('No URL configured');
            }
            
            showLoading();
            
            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify({
                    action: action,
                    ...data
                })
            };
            
            return fetch(GAS_URL, options)
                .then(response => response.json())
                .then(result => {
                    hideLoading();
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    return result;
                })
                .catch(error => {
                    hideLoading();
                    console.error('API Error:', error);
                    throw error;
                });
        }
        
        // === ä¸»æ§å°åŠŸèƒ½ ===
        function refreshDashboard() {
            callAPI('getDashboard')
                .then(data => {
                    updateDashboard(data);
                    document.getElementById('lastUpdate').textContent = 
                        `æœ€å¾Œæ›´æ–°: ${new Date().toLocaleString('zh-TW')}`;
                })
                .catch(error => {
                    console.error('Dashboard error:', error);
                });
        }
        
        function updateDashboard(data) {
            const container = document.getElementById('dashboardKPIs');
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">â„ï¸ å†·å‡åº«ä½¿ç”¨ç‡</div>
                    <div class="kpi-value">${data.freezerUsage || 0}%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${data.freezerUsage || 0}%">${data.freezerUsage || 0}%</div>
                    </div>
                    <div class="kpi-label">8åº§å†·å‡åº« | å¯ç”¨: ${data.freezerAvailable || 0}å€‹æ£§æ¿ä½</div>
                </div>
                
                <div class="card">
                    <div class="card-title">ğŸ§Š å†·è—åº«ä½¿ç”¨ç‡</div>
                    <div class="kpi-value">${data.coolerUsage || 0}%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${data.coolerUsage || 0}%">${data.coolerUsage || 0}%</div>
                    </div>
                    <div class="kpi-label">5åº§å†·è—åº« | å¯ç”¨: ${data.coolerAvailable || 0}å€‹æ£§æ¿ä½</div>
                </div>
                
                <div class="card">
                    <div class="card-title">ğŸ“¦ ç¸½SKUæ•¸</div>
                    <div class="kpi-value">${data.totalSKUs || 0}</div>
                    <div class="kpi-label">å€‹å“é …</div>
                </div>
                
                <div class="card">
                    <div class="card-title">âš ï¸ ä½åº«å­˜è­¦å ±</div>
                    <div class="kpi-value">${data.lowStockCount || 0}</div>
                    <div class="kpi-label">å€‹å“é …éœ€è£œè²¨</div>
                </div>
            `;
            
            // æ›´æ–°è­¦å ±
            const alertsContainer = document.getElementById('alertsContainer');
            if (data.alerts && data.alerts.length > 0) {
                alertsContainer.innerHTML = data.alerts.map(alert => `
                    <div class="alert-card" style="margin-bottom: 10px; padding: 15px;">
                        <strong>${alert.type}:</strong> ${alert.message}
                    </div>
                `).join('');
            } else {
                alertsContainer.innerHTML = '<p style="color: #666;">ç›®å‰ç„¡è­¦å ±</p>';
            }
        }
        
        // === åº«å­˜ç®¡ç†åŠŸèƒ½ ===
        function refreshInventory() {
            callAPI('getInventory')
                .then(data => {
                    systemData.inventory = data.items || [];
                    displayInventory();
                })
                .catch(error => {
                    console.error('Inventory error:', error);
                });
        }
        
        function displayInventory() {
            const tbody = document.getElementById('inventoryTableBody');
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            const tempFilter = document.getElementById('tempFilter').value;
            
            let filtered = systemData.inventory;
            
            // æœå°‹éæ¿¾
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    item.sku.toLowerCase().includes(searchTerm) || 
                    item.name.toLowerCase().includes(searchTerm)
                );
            }
            
            // æº«å±¤éæ¿¾
            if (tempFilter) {
                filtered = filtered.filter(item => item.tempZone === tempFilter);
            }
            
            tbody.innerHTML = filtered.map(item => {
                const status = item.available < item.safetyStock ? 'danger' : 
                              item.available < item.rop ? 'warning' : 'normal';
                
                return `
                    <tr>
                        <td>${item.sku}</td>
                        <td>${item.name}</td>
                        <td>${item.tempZone}</td>
                        <td class="editable-cell" onclick="editCell(this, '${item.sku}', 'currentStock')">${item.currentStock || 0}</td>
                        <td class="editable-cell" onclick="editCell(this, '${item.sku}', 'inTransit')">${item.inTransit || 0}</td>
                        <td>${item.available || 0}</td>
                        <td>${item.safetyStock || 0}</td>
                        <td><span class="status-badge status-${status}">${
                            status === 'danger' ? 'ç¼ºè²¨' : 
                            status === 'warning' ? 'ä½åº«å­˜' : 'æ­£å¸¸'
                        }</span></td>
                        <td>
                            <button class="btn btn-primary" style="padding: 5px 10px;" onclick="updateInventoryItem('${item.sku}')">æ›´æ–°</button>
                            <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteInventoryItem('${item.sku}')">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function searchInventory() {
            displayInventory();
        }
        
        function filterInventory() {
            displayInventory();
        }
        
        function addNewInventory() {
            showModal('æ–°å¢åº«å­˜', `
                <div class="form-group">
                    <label>SKU</label>
                    <input type="text" class="form-control" id="newSKU">
                </div>
                <div class="form-group">
                    <label>å“å</label>
                    <input type="text" class="form-control" id="newName">
                </div>
                <div class="form-group">
                    <label>æº«å±¤</label>
                    <select class="form-control" id="newTempZone">
                        <option value="å†·å‡">å†·å‡ (-18Â°C)</option>
                        <option value="å†·è—">å†·è— (4Â°C)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>åˆå§‹åº«å­˜</label>
                    <input type="number" class="form-control" id="newStock" value="0">
                </div>
                <button class="btn btn-primary" onclick="saveNewInventory()">å„²å­˜</button>
            `);
        }
        
        function saveNewInventory() {
            const data = {
                sku: document.getElementById('newSKU').value,
                name: document.getElementById('newName').value,
                tempZone: document.getElementById('newTempZone').value,
                currentStock: parseInt(document.getElementById('newStock').value) || 0
            };
            
            callAPI('addInventory', data)
                .then(result => {
                    closeModal();
                    refreshInventory();
                    alert('åº«å­˜æ–°å¢æˆåŠŸï¼');
                })
                .catch(error => {
                    alert('æ–°å¢å¤±æ•—: ' + error.message);
                });
        }
        
        // === éœ€æ±‚è¨­å®šåŠŸèƒ½ ===
        function saveDemand() {
            const data = {
                sku: document.getElementById('demandSKU').value,
                name: document.getElementById('demandName').value,
                customer: document.getElementById('demandCustomer').value,
                serviceLevel: document.getElementById('demandServiceLevel').value,
                dailyDemand: parseFloat(document.getElementById('demandDaily').value) || 0,
                leadTime: parseInt(document.getElementById('demandLeadTime').value) || 7
            };
            
            if (!data.sku || !data.name) {
                alert('è«‹å¡«å¯« SKU å’Œå“å');
                return;
            }
            
            callAPI('saveDemand', data)
                .then(result => {
                    alert('éœ€æ±‚è¨­å®šå·²å„²å­˜ï¼');
                    document.getElementById('demandSKU').value = '';
                    document.getElementById('demandName').value = '';
                    document.getElementById('demandDaily').value = '';
                    loadDemands();
                })
                .catch(error => {
                    alert('å„²å­˜å¤±æ•—: ' + error.message);
                });
        }
        
        function loadDemands() {
            callAPI('getDemands')
                .then(data => {
                    systemData.demands = data.demands || [];
                    displayDemands();
                })
                .catch(error => {
                    console.error('Demands error:', error);
                });
        }
        
        function displayDemands() {
            const tbody = document.getElementById('demandTableBody');
            
            tbody.innerHTML = systemData.demands.map(demand => `
                <tr>
                    <td>${demand.sku}</td>
                    <td>${demand.name}</td>
                    <td>${demand.customer}</td>
                    <td>${demand.serviceLevel}</td>
                    <td>${demand.dailyDemand}</td>
                    <td>${demand.leadTime}å¤©</td>
                    <td>${demand.safetyStock || 0}</td>
                    <td>${demand.rop || 0}</td>
                    <td>
                        <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteDemand('${demand.sku}')">åˆªé™¤</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // === AIé æ¸¬åŠŸèƒ½ ===
        function runPrediction() {
            const period = document.getElementById('predictionPeriod').value;
            const method = document.getElementById('predictionMethod').value;
            
            callAPI('runPrediction', {
                period: period,
                method: method,
                seasonal: document.getElementById('seasonalFactor').checked,
                promotion: document.getElementById('promotionFactor').checked,
                weather: document.getElementById('weatherFactor').checked
            })
                .then(result => {
                    document.getElementById('predictionSummary').innerHTML = `
                        <p><strong>é æ¸¬å®Œæˆï¼</strong></p>
                        <p>è™•ç†å“é …æ•¸: ${result.itemCount || 0}</p>
                        <p>é æ¸¬æœŸé–“: ${period}å¤©</p>
                        <p>å¹³å‡æº–ç¢ºåº¦: ${result.accuracy || 95}%</p>
                    `;
                    loadPredictions();
                })
                .catch(error => {
                    alert('é æ¸¬å¤±æ•—: ' + error.message);
                });
        }
        
        function loadPredictions() {
            callAPI('getPredictions')
                .then(data => {
                    systemData.predictions = data.predictions || [];
                    displayPredictions();
                })
                .catch(error => {
                    console.error('Predictions error:', error);
                });
        }
        
        function displayPredictions() {
            const tbody = document.getElementById('predictionTableBody');
            
            tbody.innerHTML = systemData.predictions.map(pred => `
                <tr>
                    <td>${pred.sku}</td>
                    <td>${pred.name}</td>
                    <td>${pred.period}å¤©</td>
                    <td>${pred.forecast}</td>
                    <td>${pred.stdDev}</td>
                    <td>${pred.confidenceInterval}</td>
                    <td>${pred.action}</td>
                </tr>
            `).join('');
        }
        
        // === è£œå–®ç®¡ç†åŠŸèƒ½ ===
        function generateReplenishment() {
            callAPI('generateReplenishment')
                .then(result => {
                    alert(`å·²ç”¢ç”Ÿ ${result.count || 0} ç­†è£œå–®å»ºè­°`);
                    loadReplenishments();
                })
                .catch(error => {
                    alert('ç”¢ç”Ÿè£œå–®å¤±æ•—: ' + error.message);
                });
        }
        
        function loadReplenishments() {
            callAPI('getReplenishments')
                .then(data => {
                    systemData.replenishments = data.suggestions || [];
                    displayReplenishments();
                })
                .catch(error => {
                    console.error('Replenishments error:', error);
                });
        }
        
        function displayReplenishments() {
            const tbody = document.getElementById('replenishmentTableBody');
            
            tbody.innerHTML = systemData.replenishments.map((item, index) => {
                const priority = item.priority || (item.currentStock < item.safetyStock ? 'HIGH' : 'MEDIUM');
                
                return `
                    <tr>
                        <td><input type="checkbox" value="${item.sku}" class="replenishment-check"></td>
                        <td>${item.sku}</td>
                        <td>${item.name}</td>
                        <td>${item.currentStock || 0}</td>
                        <td>${item.safetyStock || 0}</td>
                        <td>${item.rop || 0}</td>
                        <td>${item.suggestedQty || 0}</td>
                        <td>NT$ ${(item.suggestedQty * 1000).toLocaleString()}</td>
                        <td><span class="status-badge status-${priority === 'HIGH' ? 'danger' : 'warning'}">${priority}</span></td>
                        <td>
                            <button class="btn btn-success" style="padding: 5px 10px;" onclick="approveReplenishment('${item.sku}')">æ ¸å‡†</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function selectAllReplenishments() {
            const selectAll = document.getElementById('selectAll').checked;
            document.querySelectorAll('.replenishment-check').forEach(cb => {
                cb.checked = selectAll;
            });
        }
        
        function approveReplenishment(sku) {
            callAPI('approveReplenishment', { skus: [sku] })
                .then(result => {
                    alert('è£œå–®å·²æ ¸å‡†ï¼');
                    loadReplenishments();
                })
                .catch(error => {
                    alert('æ ¸å‡†å¤±æ•—: ' + error.message);
                });
        }
        
        function approveAllSuggestions() {
            const selected = [];
            document.querySelectorAll('.replenishment-check:checked').forEach(cb => {
                selected.push(cb.value);
            });
            
            if (selected.length === 0) {
                alert('è«‹é¸æ“‡è¦æ ¸å‡†çš„é …ç›®');
                return;
            }
            
            callAPI('approveReplenishment', { skus: selected })
                .then(result => {
                    alert(`å·²æ ¸å‡† ${selected.length} ç­†è£œå–®`);
                    loadReplenishments();
                })
                .catch(error => {
                    alert('æ ¸å‡†å¤±æ•—: ' + error.message);
                });
        }
        
        // === å€‰å®¹ç›£æ§åŠŸèƒ½ ===
        function loadCapacity() {
            callAPI('getCapacity')
                .then(data => {
                    systemData.capacity = data;
                    displayCapacity();
                })
                .catch(error => {
                    console.error('Capacity error:', error);
                });
        }
        
        function displayCapacity() {
            // é¡¯ç¤ºå†·å‡åº«
            const freezerContainer = document.getElementById('freezerCapacity');
            freezerContainer.innerHTML = (systemData.capacity.freezers || []).map((wh, index) => `
                <div class="card">
                    <div class="card-title">å†·å‡åº« #${index + 1}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${wh.usageRate}%; background: ${wh.usageRate > 85 ? '#f44336' : ''}">${wh.usageRate}%</div>
                    </div>
                    <div class="kpi-label">${wh.usedPallets}/${wh.totalPallets} æ£§æ¿ä½</div>
                </div>
            `).join('');
            
            // é¡¯ç¤ºå†·è—åº«
            const coolerContainer = document.getElementById('coolerCapacity');
            coolerContainer.innerHTML = (systemData.capacity.coolers || []).map((wh, index) => `
                <div class="card">
                    <div class="card-title">å†·è—åº« #${index + 1}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${wh.usageRate}%; background: ${wh.usageRate > 85 ? '#f44336' : ''}">${wh.usageRate}%</div>
                    </div>
                    <div class="kpi-label">${wh.usedPallets}/${wh.totalPallets} æ£§æ¿ä½</div>
                </div>
            `).join('');
        }
        
        // === ç³»çµ±è¨­å®šåŠŸèƒ½ ===
        function testConnection() {
            const url = document.getElementById('webAppUrl').value;
            if (!url) {
                alert('è«‹è¼¸å…¥ Web App URL');
                return;
            }
            
            showLoading();
            fetch(`${url}?action=ping`)
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    alert('é€£æ¥æˆåŠŸï¼');
                })
                .catch(error => {
                    hideLoading();
                    alert('é€£æ¥å¤±æ•—: ' + error.message);
                });
        }
        
        function saveConnection() {
            const url = document.getElementById('webAppUrl').value;
            if (!url) {
                alert('è«‹è¼¸å…¥ Web App URL');
                return;
            }
            
            localStorage.setItem('GAS_URL', url);
            GAS_URL = url;
            alert('è¨­å®šå·²å„²å­˜ï¼');
            checkConnection();
        }
        
        function saveSystemSettings() {
            const settings = {
                reviewPeriod: document.getElementById('reviewPeriod').value,
                defaultLeadTime: document.getElementById('defaultLeadTime').value,
                capacityAlert: document.getElementById('capacityAlert').value
            };
            
            callAPI('saveSettings', settings)
                .then(result => {
                    alert('ç³»çµ±åƒæ•¸å·²å„²å­˜ï¼');
                })
                .catch(error => {
                    alert('å„²å­˜å¤±æ•—: ' + error.message);
                });
        }
        
        function initializeSystem() {
            if (!confirm('ç¢ºå®šè¦åˆå§‹åŒ–ç³»çµ±ï¼Ÿé€™å°‡å»ºç«‹æ‰€æœ‰å¿…è¦çš„å·¥ä½œè¡¨çµæ§‹ã€‚')) {
                return;
            }
            
            callAPI('initializeSystem')
                .then(result => {
                    alert('ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼');
                    refreshDashboard();
                })
                .catch(error => {
                    alert('åˆå§‹åŒ–å¤±æ•—: ' + error.message);
                });
        }
        
        function resetSystem() {
            if (!confirm('ç¢ºå®šè¦é‡ç½®ç³»çµ±ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼')) {
                return;
            }
            
            if (!confirm('å†æ¬¡ç¢ºèªï¼šé€™å°‡æ°¸ä¹…åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒï¼Ÿ')) {
                return;
            }
            
            callAPI('resetSystem')
                .then(result => {
                    alert('ç³»çµ±å·²é‡ç½®ï¼');
                    refreshDashboard();
                })
                .catch(error => {
                    alert('é‡ç½®å¤±æ•—: ' + error.message);
                });
        }
        // è™•ç†ç™»å…¥
function handleLogin(event) {
    event.preventDefault();
    
    const account = document.getElementById('loginAccount').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!account || !password) {
        alert('è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼ï¼');
        return;
    }
    
    // é¡¯ç¤ºè¼‰å…¥ä¸­
    showLoading();
    
    // å‘¼å«å¾Œç«¯é©—è­‰
    callAPI('login', {
        account: account,
        password: password
    })
    .then(result => {
        if (result.success) {
            // ç™»å…¥æˆåŠŸ
            currentUser = {
                account: account,
                name: result.name || account
            };
            userLevel = result.level || 'operator';
            
            // å„²å­˜åˆ° sessionStorage
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            sessionStorage.setItem('userLevel', userLevel);
            
            // é¡¯ç¤ºä¸»ç³»çµ±
            showMainSystem();
            
            // æª¢æŸ¥é€£æ¥ä¸¦è¼‰å…¥ä¸»æ§å°
            checkConnection();
            refreshDashboard();
            
        } else {
            alert(result.message || 'ç™»å…¥å¤±æ•—ï¼');
        }
    })
    .catch(error => {
        console.error('Login error:', error);
        alert('ç™»å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ï¼');
    });
}

// æ›´æ–°ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º
function updateUserInfo() {
    // åœ¨ header ä¸­é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
    const header = document.querySelector('.header');
    if (header && currentUser) {
        // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç”¨æˆ¶è³‡è¨Šå€å¡Š
        let userInfoDiv = header.querySelector('.user-info');
        if (!userInfoDiv) {
            userInfoDiv = document.createElement('div');
            userInfoDiv.className = 'user-info';
            header.appendChild(userInfoDiv);
        }
        
        userInfoDiv.innerHTML = `
            <span>æ­¡è¿ï¼Œ${currentUser.name} (${userLevel})</span>
            <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
        `;
    }
}

// æ‡‰ç”¨æ¬Šé™è¨­å®š
function applyPermissions() {
    // æ ¹æ“šç”¨æˆ¶ç­‰ç´šè¨­å®šä»‹é¢æ¬Šé™
    if (userLevel === 'operator') {
        // æ“ä½œå“¡åªèƒ½æŸ¥çœ‹ï¼Œä¸èƒ½ä¿®æ”¹ç³»çµ±è¨­å®š
        const tabs = document.querySelectorAll('.nav-tab');
        tabs.forEach(tab => {
            if (tab.textContent.includes('ç³»çµ±è¨­å®š')) {
                tab.classList.add('disabled');
            }
        });
        
        // ç¦ç”¨æŸäº›å±éšªæ“ä½œæŒ‰éˆ•
        const dangerButtons = document.querySelectorAll('.btn-danger');
        dangerButtons.forEach(btn => {
            if (btn.textContent.includes('åˆªé™¤') || btn.textContent.includes('é‡ç½®')) {
                btn.classList.add('disabled');
            }
        });
    }
    
    if (userLevel !== 'admin') {
        // éç®¡ç†å“¡ç„¡æ³•é‡ç½®ç³»çµ±
        const resetButtons = document.querySelectorAll('button');
        resetButtons.forEach(btn => {
            if (btn.textContent.includes('é‡ç½®ç³»çµ±')) {
                btn.classList.add('disabled');
            }
        });
    }
}

// ç™»å‡ºåŠŸèƒ½
function logout() {
    if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
        sessionStorage.removeItem('currentUser');
        sessionStorage.removeItem('userLevel');
        currentUser = null;
        userLevel = null;
        showLoginForm();
    }
}

        
        // === è¼”åŠ©åŠŸèƒ½ ===
        function runFullAnalysis() {
            showModal('åŸ·è¡Œå®Œæ•´åˆ†æ', '<p>æ­£åœ¨åŸ·è¡Œå®Œæ•´åˆ†ææµç¨‹...</p>');
            
            Promise.all([
                callAPI('runPrediction', { period: 30 }),
                callAPI('generateReplenishment'),
                callAPI('analyzeCapacity')
            ])
                .then(results => {
                    closeModal();
                    showModal('åˆ†æå®Œæˆ', `
                        <p><strong>åˆ†æçµæœï¼š</strong></p>
                        <p>âœ… éœ€æ±‚é æ¸¬å®Œæˆï¼š${results[0].itemCount || 0} å€‹å“é …</p>
                        <p>âœ… è£œå–®å»ºè­°ç”¢ç”Ÿï¼š${results[1].count || 0} ç­†</p>
                        <p>âœ… å€‰å®¹åˆ†æå®Œæˆ</p>
                        <button class="btn btn-primary" onclick="closeModal()">ç¢ºå®š</button>
                    `);
                    refreshDashboard();
                })
                .catch(error => {
                    closeModal();
                    alert('åˆ†æå¤±æ•—: ' + error.message);
                });
        }
        
        function generateAllSuggestions() {
            callAPI('generateAllSuggestions')
                .then(result => {
                    alert('æ‰€æœ‰å»ºè­°å·²ç”¢ç”Ÿï¼');
                    refreshDashboard();
                })
                .catch(error => {
                    alert('ç”¢ç”Ÿå»ºè­°å¤±æ•—: ' + error.message);
                });
        }
        
        function exportDashboard() {
            callAPI('exportDashboard')
                .then(result => {
                    alert('å„€è¡¨æ¿å·²åŒ¯å‡ºè‡³ Google Sheetï¼');
                })
                .catch(error => {
                    alert('åŒ¯å‡ºå¤±æ•—: ' + error.message);
                });
        }
        
        function exportReplenishment() {
            callAPI('exportReplenishment')
                .then(result => {
                    alert('è£œå–®å·²åŒ¯å‡ºè‡³ Google Sheetï¼');
                })
                .catch(error => {
                    alert('åŒ¯å‡ºå¤±æ•—: ' + error.message);
                });
        }
        
        function editCell(cell, sku, field) {
            const currentValue = cell.textContent;
            cell.innerHTML = `<input type="number" value="${currentValue}" onblur="saveCell(this, '${sku}', '${field}')" onkeypress="if(event.keyCode==13) this.blur()">`;
            cell.querySelector('input').focus();
        }
        
        function saveCell(input, sku, field) {
            const newValue = input.value;
            const cell = input.parentElement;
            cell.textContent = newValue;
            
            // æ›´æ–°åˆ°å¾Œç«¯
            callAPI('updateInventoryField', {
                sku: sku,
                field: field,
                value: newValue
            }).catch(error => {
                console.error('Update failed:', error);
                cell.textContent = input.defaultValue;
            });
        }
        
        function updateInventoryItem(sku) {
            const item = systemData.inventory.find(i => i.sku === sku);
            if (item) {
                callAPI('updateInventory', item)
                    .then(result => {
                        alert('æ›´æ–°æˆåŠŸï¼');
                        refreshInventory();
                    })
                    .catch(error => {
                        alert('æ›´æ–°å¤±æ•—: ' + error.message);
                    });
            }
        }
        
        function deleteInventoryItem(sku) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${sku} å—ï¼Ÿ`)) {
                return;
            }
            
            callAPI('deleteInventory', { sku: sku })
                .then(result => {
                    alert('åˆªé™¤æˆåŠŸï¼');
                    refreshInventory();
                })
                .catch(error => {
                    alert('åˆªé™¤å¤±æ•—: ' + error.message);
                });
        }
        
        function deleteDemand(sku) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${sku} çš„éœ€æ±‚è¨­å®šå—ï¼Ÿ`)) {
                return;
            }
            
            callAPI('deleteDemand', { sku: sku })
                .then(result => {
                    alert('åˆªé™¤æˆåŠŸï¼');
                    loadDemands();
                })
                .catch(error => {
                    alert('åˆªé™¤å¤±æ•—: ' + error.message);
                });
        }
        
        function clearPending() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¾…è™•ç†çš„è£œå–®ï¼Ÿ')) {
                return;
            }
            
            callAPI('clearPendingReplenishments')
                .then(result => {
                    alert('å·²æ¸…é™¤å¾…è™•ç†è£œå–®ï¼');
                    loadReplenishments();
                })
                .catch(error => {
                    alert('æ¸…é™¤å¤±æ•—: ' + error.message);
                });
        }
        
        function viewHistory() {
            showModal('æ­·å²é æ¸¬è¨˜éŒ„', '<p>åŠŸèƒ½é–‹ç™¼ä¸­...</p>');
        }
    </script>
</body>
</html>
