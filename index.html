<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAI寄庫庫存量水位補單系統</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-size: 14px;
            color: #666;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .kpi-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .kpi-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .alert-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .alert-card {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
        }

        .alert-card.danger {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-card.success {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .warehouse-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .warehouse-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }

        .warehouse-card.freezer {
            border-left-color: #3498db;
        }

        .warehouse-card.chiller {
            border-left-color: #e74c3c;
        }

        .capacity-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .capacity-fill {
            height: 100%;
            background: linear-gradient(90deg, #56ab2f 0%, #a8e6cf 100%);
            transition: width 0.3s ease;
        }

        .capacity-fill.warning {
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
        }

        .capacity-fill.danger {
            background: linear-gradient(90deg, #ff416c 0%, #ff4b2b 100%);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.danger {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                margin-bottom: 5px;
            }
            
            .kpi-grid,
            .alert-grid,
            .form-grid,
            .warehouse-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏭 GAI寄庫庫存量水位補單系統</h1>
            <p>智能冷鏈物流倉儲管理系統 - 冷凍庫8座 | 冷藏庫5座</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">📊 主控頁</button>
            <button class="nav-tab" onclick="showTab('customer')">👥 客戶需求</button>
            <button class="nav-tab" onclick="showTab('project')">📋 寄庫專案</button>
            <button class="nav-tab" onclick="showTab('sku')">📦 SKU主檔</button>
            <button class="nav-tab" onclick="showTab('warehouse')">🏪 倉容管理</button>
            <button class="nav-tab" onclick="showTab('forecast')">🤖 AI預測</button>
            <button class="nav-tab" onclick="showTab('safety')">🛡️ 安全庫存</button>
            <button class="nav-tab" onclick="showTab('recommendation')">💡 庫存建議</button>
            <button class="nav-tab" onclick="showTab('replenishment')">📝 補單管理</button>
            <button class="nav-tab" onclick="showTab('monitoring')">📈 監控告警</button>
        </div>

        <!-- 主控頁 -->
        <div id="dashboard" class="tab-content active">
            <h2>📊 系統主控頁</h2>
            
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value" id="fillRate">98.5%</div>
                    <div class="kpi-label">Fill Rate</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="stockoutRate">1.2%</div>
                    <div class="kpi-label">缺貨率</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="turnoverDays">15.3</div>
                    <div class="kpi-label">庫存週轉天數</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="freezerUtilization">76%</div>
                    <div class="kpi-label">冷凍庫利用率</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="chillerUtilization">82%</div>
                    <div class="kpi-label">冷藏庫利用率</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="expiringRate">3.1%</div>
                    <div class="kpi-label">即期品占比</div>
                </div>
            </div>

            <div class="alert-grid">
                <div class="alert-card danger">
                    <h4>🚨 緊急告警</h4>
                    <p>冷凍庫F-03容量已達89%，建議立即處理</p>
                    <small>更新時間: 2025-08-13 20:45</small>
                </div>
                <div class="alert-card warning">
                    <h4>⚠️ 效期預警</h4>
                    <p>3個品項將於7天內到期，需執行FEFO出貨</p>
                    <small>影響SKU: 15個</small>
                </div>
                <div class="alert-card success">
                    <h4>✅ 系統正常</h4>
                    <p>AI預測模型運行正常，預測準確度97.2%</p>
                    <small>最後更新: 2025-08-13 20:00</small>
                </div>
            </div>

            <div class="quick-actions">
                <button class="btn btn-primary" onclick="refreshDashboard()">🔄 重新整理</button>
                <button class="btn btn-success" onclick="runAIForecast()">🤖 執行AI預測</button>
                <button class="btn btn-warning" onclick="generateRecommendation()">💡 產生庫存建議</button>
                <button class="btn btn-primary" onclick="exportReport()">📄 匯出報表</button>
            </div>

            <div class="loading" id="dashboardLoading">
                <div class="spinner"></div>
                <p>載入中...</p>
            </div>
        </div>

        <!-- 客戶需求確認 -->
        <div id="customer" class="tab-content">
            <h2>👥 客戶需求確認</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>客戶名稱</label>
                    <select id="customerSelect">
                        <option value="">請選擇客戶</option>
                        <option value="customer1">統一企業</option>
                        <option value="customer2">義美食品</option>
                        <option value="customer3">愛之味</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>服務水準</label>
                    <select id="serviceLevel">
                        <option value="">請選擇服務水準</option>
                        <option value="P">P級 (99.5%)</option>
                        <option value="Q">Q級 (97.5%)</option>
                        <option value="R">R級 (95%)</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>品項需求清單</label>
                <textarea id="itemList" rows="5" placeholder="請輸入品項代碼、名稱、預估銷量等資訊..."></textarea>
            </div>

            <div class="quick-actions">
                <button class="btn btn-primary" onclick="saveCustomerDemand()">💾 儲存需求</button>
                <button class="btn btn-success" onclick="importDemandFile()">📁 匯入檔案</button>
                <button class="btn btn-warning" onclick="calculateSafetyStock()">🧮 試算安全庫存</button>
            </div>

            <table class="data-table" id="customerDemandTable">
                <thead>
                    <tr>
                        <th>客戶名稱</th>
                        <th>品項代碼</th>
                        <th>品項名稱</th>
                        <th>預估銷量</th>
                        <th>服務水準</th>
                        <th>狀態</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 動態載入資料 -->
                </tbody>
            </table>
        </div>

        <!-- 寄庫專案設定 -->
        <div id="project" class="tab-content">
            <h2>📋 寄庫專案設定</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>專案名稱</label>
                    <input type="text" id="projectName" placeholder="請輸入專案名稱">
                </div>
                <div class="form-group">
                    <label>客戶</label>
                    <select id="projectCustomer">
                        <option value="">請選擇客戶</option>
                        <option value="customer1">統一企業</option>
                        <option value="customer2">義美食品</option>
                        <option value="customer3">愛之味</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>指派倉別</label>
                    <select id="warehouseAssignment" multiple>
                        <option value="F01">冷凍庫F-01</option>
                        <option value="F02">冷凍庫F-02</option>
                        <option value="F03">冷凍庫F-03</option>
                        <option value="F04">冷凍庫F-04</option>
                        <option value="F05">冷凍庫F-05</option>
                        <option value="F06">冷凍庫F-06</option>
                        <option value="F07">冷凍庫F-07</option>
                        <option value="F08">冷凍庫F-08</option>
                        <option value="C01">冷藏庫C-01</option>
                        <option value="C02">冷藏庫C-02</option>
                        <option value="C03">冷藏庫C-03</option>
                        <option value="C04">冷藏庫C-04</option>
                        <option value="C05">冷藏庫C-05</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>覆核週期</label>
                    <select id="reviewCycle">
                        <option value="daily">每日</option>
                        <option value="weekly">每週</option>
                        <option value="monthly">每月</option>
                    </select>
                </div>
            </div>

            <div class="quick-actions">
                <button class="btn btn-primary" onclick="saveProject()">💾 建立專案</button>
                <button class="btn btn-success" onclick="activateProject()">✅ 啟用專案</button>
                <button class="btn btn-warning" onclick="copyProject()">📋 複製專案</button>
            </div>

            <table class="data-table" id="projectTable">
                <thead>
                    <tr>
                        <th>專案名稱</th>
                        <th>客戶</th>
                        <th>指派倉別</th>
                        <th>覆核週期</th>
                        <th>狀態</th>
                        <th>建立時間</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 動態載入資料 -->
                </tbody>
            </table>
        </div>

        <!-- SKU主檔 -->
        <div id="sku" class="tab-content">
            <h2>📦 SKU主檔管理</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>SKU代碼</label>
                    <input type="text" id="skuCode" placeholder="請輸入SKU代碼">
                </div>
                <div class="form-group">
                    <label>品項名稱</label>
                    <input type="text" id="skuName" placeholder="請輸入品項名稱">
                </div>
                <div class="form-group">
                    <label>溫層</label>
                    <select id="temperatureZone">
                        <option value="">請選擇溫層</option>
                        <option value="frozen">冷凍 (-18°C)</option>
                        <option value="chilled">冷藏 (0-4°C)</option>
                        <option value="ambient">常溫</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>體積 (m³)</label>
                    <input type="number" id="volume" step="0.001" placeholder="請輸入體積">
                </div>
                <div class="form-group">
                    <label>重量 (kg)</label>
                    <input type="number" id="weight" step="0.1" placeholder="請輸入重量">
                </div>
                <div class="form-group">
                    <label>保存天數</label>
                    <input type="number" id="shelfLife" placeholder="請輸入保存天數">
                </div>
            </div>

            <div class="quick-actions">
                <button class="btn btn-primary" onclick="saveSKU()">💾 儲存SKU</button>
                <button class="btn btn-success" onclick="importSKUFile()">📁 批次匯入</button>
                <button class="btn btn-warning" onclick="validateSKUData()">✅ 資料驗證</button>
                <button class="btn btn-primary" onclick="exportSKUData()">📄 匯出資料</button>
            </div>

            <table class="data-table" id="skuTable">
                <thead>
                    <tr>
                        <th>SKU代碼</th>
                        <th>品項名稱</th>
                        <th>溫層</th>
                        <th>體積(m³)</th>
                        <th>重量(kg)</th>
                        <th>保存天數</th>
                        <th>狀態</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 動態載入資料 -->
                </tbody>
            </table>
        </div>

        <!-- 倉容管理 -->
        <div id="warehouse" class="tab-content">
            <h2>🏪 倉容管理</h2>
            
            <div class="warehouse-grid">
                <!-- 冷凍庫 -->
                <div class="warehouse-card freezer">
                    <h4>❄️ 冷凍庫 F-01</h4>
                    <p>溫度: -18°C | 總棧板位: 120</p>
                    <div class="capacity-bar">
                        <div class="capacity-fill" style="width: 65%"></div>
                    </div>
                    <p>使用率: 65% (78/120)</p>
                    <span class="status-badge active">正常運行</span>
                </div>
                
                <div class="warehouse-card freezer">
                    <h4>❄️ 冷凍庫 F-02</h4>
                    <p>溫度: -18°C | 總棧板位: 120</p>
                    <div class="capacity-bar">
                        <div class="capacity-fill" style="width: 72%"></div>
                    </div>
                    <p>使用率: 72% (86/120)</p>
                    <span class="status-badge active">正常運行</span>
                </div>
                
                <div class="warehouse-card freezer">
                    <h4>❄️ 冷凍庫 F-03</h4>
                    <p>溫度: -18°C | 總棧板位: 120</p>
                    <div class="capacity-bar">
                        <div class="capacity-fill danger" style="width: 89%"></div>
                    </div>
                    <p>使用率: 89% (107/120)</p>
                    <span class="status-badge danger">容量警告</span>
                </div>
                
                <div class="warehouse-card freezer">
                    <h4>❄️ 冷凍庫 F-04</h4>
                    <p>溫度: -18°C | 總棧板位: 120</p>
                    <div class="capacity-bar">
                        <div class="capacity-fill" style="width: 58%"></div>
                    </div>
                    <p>使用率: 58% (70/120)</p>
                    <span class="status-badge active">正常運行</span>
                </div>
                
                <!-- 冷藏庫 -->
                <div class="warehouse-card chiller">
                    <h4>🧊 冷藏庫 C-01</h4>
                    <p>溫度: 0-4°C | 總棧板位: 100</p>
                    <div class="capacity-bar">
                        <div class="capacity-fill warning" style="width: 82%"></div>
                    </div>
                    <p>使用率: 82% (82/100)</p>
                    <span class="status-badge warning">容量偏高</span>
                </div>
                
                <div class="warehouse-card chiller">
                    <h4>🧊 冷藏庫 C-02</h4>
                    <p>溫度: 0-4°C | 總棧板位: 100</p>
                    <div class="capacity-bar">
                        <div class="capacity-fill" style="width: 67%"></div>
                    </div>
                    <p>使用率: 67% (67/100)</p>
                    <span class="status-badge active">正常運行</span>
                </div>
            </div>

            <div class="quick-actions">
                <button class="btn btn-primary" onclick="checkCapacity()">🔍 容量校核</button>
                <button class="btn btn-success" onclick="optimizeAllocation()">⚡ 優化配置</button>
                <button class="btn btn-warning" onclick="generateCapacityReport()">📊 容量報表</button>
            </div>

            <table class="data-table" id="warehouseTable">
                <thead>
                    <tr>
                        <th>倉別</th>
                        <th>溫層</th>
                        <th>總棧板位</th>
                        <th>已使用</th>
                        <th>使用率</th>
                        <th>狀態</th>
                        <th>最後更新</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 動態載入資料 -->
                </tbody>
            </table>
        </div>

        <!-- AI預測 -->
        <div id="forecast" class="tab-content">
            <h2>🤖 AI預測與參數</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>預測模型版本</label>
                    <select id="modelVersion">
                        <option value="v2.1">GAI Model v2.1 (當前)</option>
                        <option value="v2.0">GAI Model v2.0</option>
                        <option value="v1.9">GAI Model v1.9</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>訓練窗口 (天)</label>
                    <input type="number" id="trainingWindow" value="90" min="30" max="365">
                </div>
                                <div class="form-group">
                    <label>置信區間</label>
                    <select id="confidenceInterval">
                        <option value="95">95%</option>
                        <option value="97.5">97.5%</option>
                        <option value="99">99%</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>預測準確度 (MAPE)</label>
                    <input type="text" id="mapeValue" value="2.8%" readonly>
                </div>
            </div>

            <div class="quick-actions">
                <button class="btn btn-primary" onclick="runForecast()">🚀 執行預測</button>
                <button class="btn btn-success" onclick="retrainModel()">🔄 重新訓練</button>
                <button class="btn btn-warning" onclick="validateForecast()">✅ 驗證預測</button>
                <button class="btn btn-primary" onclick="exportForecast()">📄 匯出預測</button>
            </div>

            <table class="data-table" id="forecastTable">
                <thead>
                    <tr>
                        <th>SKU代碼</th>
                        <th>品項名稱</th>
                        <th>歷史平均需求</th>
                        <th>預測需求</th>
                        <th>預測準確度</th>
                        <th>置信區間</th>
                        <th>風險等級</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 動態載入資料 -->
                </tbody>
            </table>
        </div>

        <!-- 安全庫存策略 -->
        <div id="safety" class="tab-content">
            <h2>🛡️ 安全庫存策略</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>庫存策略</label>
                    <select id="stockStrategy">
                        <option value="ROP">ROP (再訂購點)</option>
                        <option value="BaseStock">Base-stock (基準庫存)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>交期均值 (天)</label>
                    <input type="number" id="leadTimeMean" value="7" step="0.1">
                </div>
                <div class="form-group">
                    <label>交期標準差 (天)</label>
                    <input type="number" id="leadTimeStd" value="1.5" step="0.1">
                </div>
                <div class="form-group">
                    <label>檢視週期 (天)</label>
                    <input type="number" id="reviewPeriod" value="7" min="1" max="30">
                </div>
            </div>

            <div class="form-group">
                <label>服務水準對應Z值設定</label>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>服務水準</th>
                            <th>百分比</th>
                            <th>Z值</th>
                            <th>說明</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>P級</td>
                            <td>99.5%</td>
                            <td>2.58</td>
                            <td>高價值客戶</td>
                        </tr>
                        <tr>
                            <td>Q級</td>
                            <td>97.5%</td>
                            <td>1.96</td>
                            <td>一般客戶</td>
                        </tr>
                        <tr>
                            <td>R級</td>
                            <td>95%</td>
                            <td>1.65</td>
                            <td>基本客戶</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="quick-actions">
                <button class="btn btn-primary" onclick="calculateSafetyStock()">🧮 計算安全庫存</button>
                <button class="btn btn-success" onclick="runScenarioAnalysis()">📊 情境分析</button>
                <button class="btn btn-warning" onclick="optimizeParameters()">⚡ 參數優化</button>
            </div>

            <table class="data-table" id="safetyStockTable">
                <thead>
                    <tr>
                        <th>SKU代碼</th>
                        <th>客戶等級</th>
                        <th>平均需求</th>
                        <th>需求標準差</th>
                        <th>Z值</th>
                        <th>安全庫存</th>
                        <th>ROP/目標庫存</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 動態載入資料 -->
                </tbody>
            </table>
        </div>

        <!-- 庫存建議 -->
        <div id="recommendation" class="tab-content">
            <h2>💡 初始庫存建議 & 模擬</h2>
            
            <div class="alert-grid">
                <div class="alert-card success">
                    <h4>✅ 容量校核結果</h4>
                    <p>冷凍庫總容量充足，冷藏庫C-01需注意容量</p>
                    <small>校核時間: 2025-08-13 20:30</small>
                </div>
                <div class="alert-card warning">
                    <h4>⚠️ FEFO風險提醒</h4>
                    <p>5個SKU的初始庫存可能無法滿足效期覆蓋要求</p>
                    <small>建議調整補貨策略</small>
                </div>
            </div>

            <div class="quick-actions">
                <button class="btn btn-primary" onclick="generateRecommendation()">🎯 產生建議</button>
                <button class="btn btn-success" onclick="runCapacityCheck()">🔍 容量校核</button>
                <button class="btn btn-warning" onclick="runSimulation()">🎮 情境模擬</button>
                <button class="btn btn-primary" onclick="sendToCustomer()">📧 送客戶確認</button>
            </div>

            <table class="data-table" id="recommendationTable">
                <thead>
                    <tr>
                        <th>SKU代碼</th>
                        <th>客戶</th>
                        <th>倉別/溫層</th>
                        <th>目前庫存</th>
                        <th>安全庫存</th>
                        <th>目標庫存</th>
                        <th>建議補貨量</th>
                        <th>棧板位占用</th>
                        <th>效期覆蓋天數</th>
                        <th>風險標記</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 動態載入資料 -->
                </tbody>
            </table>
        </div>

        <!-- 補單管理 -->
        <div id="replenishment" class="tab-content">
            <h2>📝 補單與派工</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>補單編號</label>
                    <input type="text" id="replenishmentId" placeholder="系統自動產生" readonly>
                </div>
                <div class="form-group">
                    <label>供應商</label>
                    <select id="supplier">
                        <option value="">請選擇供應商</option>
                        <option value="supplier1">統一企業</option>
                        <option value="supplier2">義美食品</option>
                        <option value="supplier3">愛之味</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>預計交期</label>
                    <input type="date" id="expectedDelivery">
                </div>
                <div class="form-group">
                    <label>溫層車槽需求</label>
                    <select id="vehicleType">
                        <option value="">請選擇車型</option>
                        <option value="frozen">冷凍車</option>
                        <option value="chilled">冷藏車</option>
                        <option value="mixed">混合車</option>
                    </select>
                </div>
            </div>

            <div class="quick-actions">
                <button class="btn btn-primary" onclick="createReplenishmentOrder()">📝 建立補單</button>
                <button class="btn btn-success" onclick="publishOrder()">🚀 發佈補單</button>
                <button class="btn btn-warning" onclick="generateWaveTask()">📋 產生波次</button>
                <button class="btn btn-primary" onclick="notifySupplier()">📧 通知供應商</button>
            </div>

            <table class="data-table" id="replenishmentTable">
                <thead>
                    <tr>
                        <th>補單編號</th>
                        <th>供應商</th>
                        <th>SKU數量</th>
                        <th>總數量</th>
                        <th>預計交期</th>
                        <th>車型需求</th>
                        <th>狀態</th>
                        <th>建立時間</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 動態載入資料 -->
                </tbody>
            </table>
        </div>

        <!-- 監控告警 -->
        <div id="monitoring" class="tab-content">
            <h2>📈 庫存監控與告警</h2>
            
            <div class="alert-grid">
                <div class="alert-card danger">
                    <h4>🌡️ 溫度異常</h4>
                    <p>冷凍庫F-02溫度異常，目前-15°C (標準-18°C)</p>
                    <small>異常時間: 2025-08-13 19:45</small>
                    <button class="btn btn-warning" onclick="handleTemperatureAlert()">處理</button>
                </div>
                <div class="alert-card warning">
                    <h4>📅 效期預警</h4>
                    <p>SKU-A001將於3天後到期，庫存量50箱</p>
                    <small>建議立即執行FEFO出貨</small>
                    <button class="btn btn-success" onclick="createFEFOTask()">建立FEFO任務</button>
                </div>
                <div class="alert-card warning">
                    <h4>🚚 在途延遲</h4>
                    <p>補單RO-20250813-001預計今日到貨但尚未入庫</p>
                    <small>供應商: 統一企業</small>
                    <button class="btn btn-primary" onclick="contactSupplier()">聯絡供應商</button>
                </div>
                <div class="alert-card danger">
                    <h4>📉 缺貨預警</h4>
                    <p>SKU-B002預計2天後缺貨，需緊急補貨</p>
                    <small>目前庫存: 10箱，日均消耗: 5箱</small>
                    <button class="btn btn-warning" onclick="emergencyReplenishment()">緊急補貨</button>
                </div>
            </div>

            <div class="quick-actions">
                <button class="btn btn-primary" onclick="refreshMonitoring()">🔄 重新整理</button>
                <button class="btn btn-success" onclick="generateFEFOList()">📋 產生FEFO清單</button>
                <button class="btn btn-warning" onclick="checkTemperature()">🌡️ 溫度檢查</button>
                <button class="btn btn-primary" onclick="exportAlerts()">📄 匯出告警</button>
            </div>

            <table class="data-table" id="monitoringTable">
                <thead>
                    <tr>
                        <th>告警類型</th>
                        <th>SKU/倉別</th>
                        <th>描述</th>
                        <th>嚴重程度</th>
                        <th>發生時間</th>
                        <th>狀態</th>
                        <th>負責人</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 動態載入資料 -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Google Apps Script Web App URL
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwud6sF2PUrHRf9lE8ccPWnNTAAsVUuF_WG3NdhgtXNcG3nTpfC1AGu15_7WtMssnoD/exec'
                  // 全域變數
        let currentData = {};
        let isLoading = false;

        // 初始化頁面
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            setInterval(refreshDashboard, 300000); // 每5分鐘自動刷新
        });

        // 頁籤切換功能
        function showTab(tabName) {
            // 隱藏所有頁籤內容
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });

            // 移除所有按鈕的active狀態
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.classList.remove('active');
            });

            // 顯示選中的頁籤
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // 載入對應頁籤的資料
            loadTabData(tabName);
        }

        // 載入頁籤資料
        function loadTabData(tabName) {
            switch(tabName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'customer':
                    loadCustomerData();
                    break;
                case 'project':
                    loadProjectData();
                    break;
                case 'sku':
                    loadSKUData();
                    break;
                case 'warehouse':
                    loadWarehouseData();
                    break;
                case 'forecast':
                    loadForecastData();
                    break;
                case 'safety':
                    loadSafetyStockData();
                    break;
                case 'recommendation':
                    loadRecommendationData();
                    break;
                case 'replenishment':
                    loadReplenishmentData();
                    break;
                case 'monitoring':
                    loadMonitoringData();
                    break;
            }
        }

        // API呼叫函數
        async function callGAS(action, data = {}) {
    if (isLoading) return;
    
    isLoading = true;
    showLoading(true);
    
    try {
        console.log('發送API請求:', action, 'URL:', GAS_URL);
        
        const response = await fetch(GAS_URL, {
            method: 'POST',
            mode: 'cors',
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: action,
                data: data
            })
        });
        
        console.log('API回應狀態:', response.status, response.statusText);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('API回應資料:', result);
        
        return result;
    } catch (error) {
        console.error('API呼叫詳細錯誤:', error);
        
        // 詳細錯誤處理
        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
            alert('無法連接到伺服器，請檢查網路連線或聯繫系統管理員');
        } else if (error.message.includes('CORS')) {
            alert('跨域請求被阻擋，請聯繫系統管理員設定CORS政策');
        } else if (error.message.includes('HTTP')) {
            alert(`伺服器錯誤：${error.message}`);
        } else {
            alert(`系統錯誤：${error.message}`);
        }
        
        return {
            success: false,
            message: error.message,
            error: error.name
        };
    } finally {
        isLoading = false;
        showLoading(false);
    }
}

        // 顯示載入狀態
        function showLoading(show) {
            const loadingElements = document.querySelectorAll('.loading');
            loadingElements.forEach(element => {
                if (show) {
                    element.classList.add('show');
                } else {
                    element.classList.remove('show');
                }
            });
        }

        // 主控頁功能
        async function loadDashboardData() {
            const result = await callGAS('getDashboardData');
            if (result && result.success) {
                updateKPICards(result.data.kpi);
                updateAlerts(result.data.alerts);
            }
        }

        function updateKPICards(kpiData) {
            if (!kpiData) return;
            
            document.getElementById('fillRate').textContent = kpiData.fillRate || '98.5%';
            document.getElementById('stockoutRate').textContent = kpiData.stockoutRate || '1.2%';
            document.getElementById('turnoverDays').textContent = kpiData.turnoverDays || '15.3';
            document.getElementById('freezerUtilization').textContent = kpiData.freezerUtilization || '76%';
            document.getElementById('chillerUtilization').textContent = kpiData.chillerUtilization || '82%';
            document.getElementById('expiringRate').textContent = kpiData.expiringRate || '3.1%';
        }

        function refreshDashboard() {
            loadDashboardData();
            showNotification('主控頁已更新', 'success');
        }

        async function runAIForecast() {
            const result = await callGAS('runAIForecast');
            if (result && result.success) {
                showNotification('AI預測執行完成', 'success');
                loadDashboardData();
            }
        }

        async function generateRecommendation() {
            const result = await callGAS('generateRecommendation');
            if (result && result.success) {
                showNotification('庫存建議已產生', 'success');
                showTab('recommendation');
            }
        }

        async function exportReport() {
            const result = await callGAS('exportReport');
            if (result && result.success) {
                // 觸發檔案下載
                const link = document.createElement('a');
                link.href = result.data.downloadUrl;
                link.download = `庫存報表_${new Date().toISOString().split('T')[0]}.xlsx`;
                link.click();
                showNotification('報表匯出完成', 'success');
            }
        }

        // 客戶需求功能
        async function loadCustomerData() {
            const result = await callGAS('getCustomerData');
            if (result && result.success) {
                updateCustomerTable(result.data);
            }
        }

        async function saveCustomerDemand() {
            const customerData = {
                customer: document.getElementById('customerSelect').value,
                serviceLevel: document.getElementById('serviceLevel').value,
                itemList: document.getElementById('itemList').value
            };

            if (!customerData.customer || !customerData.serviceLevel) {
                alert('請填寫必要欄位');
                return;
            }

            const result = await callGAS('saveCustomerDemand', customerData);
            if (result && result.success) {
                showNotification('客戶需求已儲存', 'success');
                loadCustomerData();
                clearCustomerForm();
            }
        }

        async function importDemandFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.xlsx';
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const result = await callGAS('importDemandFile', {
                        fileName: file.name,
                        fileSize: file.size
                    });
                    
                    if (result && result.success) {
                        showNotification('檔案匯入完成', 'success');
                        loadCustomerData();
                    }
                }
            };
            input.click();
        }

        async function calculateSafetyStock() {
            const result = await callGAS('calculateSafetyStock');
            if (result && result.success) {
                showNotification('安全庫存計算完成', 'success');
                showTab('safety');
            }
        }

        function updateCustomerTable(data) {
            const tbody = document.querySelector('#customerDemandTable tbody');
            tbody.innerHTML = '';
            
            if (data && data.length > 0) {
                data.forEach(item => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${item.customer}</td>
                        <td>${item.itemCode}</td>
                        <td>${item.itemName}</td>
                        <td>${item.quantity}</td>
                        <td>${item.serviceLevel}</td>
                        <td><span class="status-badge ${item.status}">${getStatusText(item.status)}</span></td>
                        <td>
                            <button class="btn btn-primary" onclick="editCustomerDemand('${item.id}')">編輯</button>
                            <button class="btn btn-warning" onclick="deleteCustomerDemand('${item.id}')">刪除</button>
                        </td>
                    `;
                });
            }
        }

        function clearCustomerForm() {
            document.getElementById('customerSelect').value = '';
            document.getElementById('serviceLevel').value = '';
            document.getElementById('itemList').value = '';
        }

        // 寄庫專案功能
        async function loadProjectData() {
            const result = await callGAS('getProjectData');
            if (result && result.success) {
                updateProjectTable(result.data);
            }
        }

        async function saveProject() {
            const projectData = {
                name: document.getElementById('projectName').value,
                customer: document.getElementById('projectCustomer').value,
                warehouses: Array.from(document.getElementById('warehouseAssignment').selectedOptions).map(opt => opt.value),
                reviewCycle: document.getElementById('reviewCycle').value
            };

            if (!projectData.name || !projectData.customer) {
                alert('請填寫必要欄位');
                return;
            }

            const result = await callGAS('saveProject', projectData);
            if (result && result.success) {
                showNotification('專案已建立', 'success');
                loadProjectData();
                clearProjectForm();
            }
        }

        async function activateProject() {
            // 實作專案啟用邏輯
            showNotification('專案已啟用', 'success');
        }

        async function copyProject() {
            // 實作專案複製邏輯
            showNotification('專案已複製', 'success');
        }

        function updateProjectTable(data) {
            const tbody = document.querySelector('#projectTable tbody');
            tbody.innerHTML = '';
            
            if (data && data.length > 0) {
                data.forEach(item => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${item.name}</td>
                        <td>${item.customer}</td>
                        <td>${item.warehouses.join(', ')}</td>
                        <td>${item.reviewCycle}</td>
                        <td><span class="status-badge ${item.status}">${getStatusText(item.status)}</span></td>
                        <td>${item.createTime}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editProject('${item.id}')">編輯</button>
                            <button class="btn btn-warning" onclick="deleteProject('${item.id}')">刪除</button>
                        </td>
                    `;
                });
            }
        }

        function clearProjectForm() {
            document.getElementById('projectName').value = '';
            document.getElementById('projectCustomer').value = '';
            document.getElementById('warehouseAssignment').selectedIndex = -1;
            document.getElementById('reviewCycle').value = 'daily';
        }

        // SKU主檔功能
        async function loadSKUData() {
            const result = await callGAS('getSKUData');
            if (result && result.success) {
                updateSKUTable(result.data);
            }
        }

        async function saveSKU() {
            const skuData = {
                code: document.getElementById('skuCode').value,
                name: document.getElementById('skuName').value,
                temperatureZone: document.getElementById('temperatureZone').value,
                volume: parseFloat(document.getElementById('volume').value),
                weight: parseFloat(document.getElementById('weight').value),
                shelfLife: parseInt(document.getElementById('shelfLife').value)
            };

            if (!skuData.code || !skuData.name || !skuData.temperatureZone) {
                alert('請填寫必要欄位');
                return;
            }

            const result = await callGAS('saveSKU', skuData);
            if (result && result.success) {
                showNotification('SKU已儲存', 'success');
                loadSKUData();
                clearSKUForm();
            }
        }

        async function importSKUFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.xlsx';
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    const result = await callGAS('importSKUFile', {
                        fileName: file.name,
                        fileSize: file.size
                    });
                    
                    if (result && result.success) {
                        showNotification('SKU檔案匯入完成', 'success');
                        loadSKUData();
                    }
                }
            };
            input.click();
        }

        async function validateSKUData() {
            const result = await callGAS('validateSKUData');
            if (result && result.success) {
                showNotification(`資料驗證完成，發現 ${result.data.errors} 個錯誤`, 
                    result.data.errors > 0 ? 'warning' : 'success');
            }
        }

        async function exportSKUData() {
            const result = await callGAS('exportSKUData');
            if (result && result.success) {
                const link = document.createElement('a');
                link.href = result.data.downloadUrl;
                link.download = `SKU主檔_${new Date().toISOString().split('T')[0]}.xlsx`;
                link.click();
                showNotification('SKU資料匯出完成', 'success');
            }
        }

        function updateSKUTable(data) {
            const tbody = document.querySelector('#skuTable tbody');
            tbody.innerHTML = '';
            
            if (data && data.length > 0) {
                data.forEach(item => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${item.code}</td>
                        <td>${item.name}</td>
                        <td>${getTemperatureZoneText(item.temperatureZone)}</td>
                        <td>${item.volume}</td>
                        <td>${item.weight}</td>
                        <td>${item.shelfLife}</td>
                        <td><span class="status-badge ${item.status}">${getStatusText(item.status)}</span></td>
                        <td>
                            <button class="btn btn-primary" onclick="editSKU('${item.id}')">編輯</button>
                            <button class="btn btn-warning" onclick="deleteSKU('${item.id}')">刪除</button>
                        </td>
                    `;
                });
            }
        }

        function clearSKUForm() {
            document.getElementById('skuCode').value = '';
            document.getElementById('skuName').value = '';
            document.getElementById('temperatureZone').value = '';
            document.getElementById('volume').value = '';
            document.getElementById('weight').value = '';
            document.getElementById('shelfLife').value = '';
        }

        // 倉容管理功能
        async function loadWarehouseData() {
            const result = await callGAS('getWarehouseData');
            if (result && result.success) {
                updateWarehouseTable(result.data);
                updateWarehouseCards(result.data);
            }
        }

        async function checkCapacity() {
            const result = await callGAS('checkCapacity');
            if (result && result.success) {
                showNotification('容量校核完成', 'success');
                loadWarehouseData();
            }
        }

        async function optimizeAllocation() {
            const result = await callGAS('optimizeAllocation');
            if (result && result.success) {
                showNotification('配置優化完成', 'success');
                loadWarehouseData();
            }
        }

        async function generateCapacityReport() {
            const result = await callGAS('generateCapacityReport');
            if (result && result.success) {
                const link = document.createElement('a');
                link.href = result.data.downloadUrl;
                link.download = `容量報表_${new Date().toISOString().split('T')[0]}.xlsx`;
                link.click();
                showNotification('容量報表已產生', 'success');
            }
        }

        function updateWarehouseTable(data) {
            const tbody = document.querySelector('#warehouseTable tbody');
            tbody.innerHTML = '';
            
            if (data && data.length > 0) {
                data.forEach(item => {
                    const row = tbody.insertRow();
                    const utilizationClass = item.utilization > 85 ? 'danger' : item.utilization > 75 ? 'warning' : 'active';
                    
                    row.innerHTML = `
                        <td>${item.warehouse}</td>
                        <td>${getTemperatureZoneText(item.temperatureZone)}</td>
                        <td>${item.totalPositions}</td>
                        <td>${item.usedPositions}</td>
                        <td><span class="status-badge ${utilizationClass}">${item.utilization}%</span></td>
                        <td><span class="status-badge ${item.status}">${getStatusText(item.status)}</span></td>
                        <td>${item.lastUpdate}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editWarehouse('${item.id}')">編輯</button>
                            <button class="btn btn-warning" onclick="adjustCapacity('${item.id}')">調整</button>
                        </td>
                    `;
                });
            }
        }

        function updateWarehouseCards(data) {
            // 更新倉庫卡片的容量顯示
            if (data && data.length > 0) {
                data.forEach(item => {
                    const card = document.querySelector(`[data-warehouse="${item.warehouse}"]`);
                    if (card) {
                        const capacityFill = card.querySelector('.capacity-fill');
                        const utilizationText = card.querySelector('.utilization-text');
                        
                        if (capacityFill) {
                            capacityFill.style.width = `${item.utilization}%`;
                            capacityFill.className = `capacity-fill ${item.utilization > 85 ? 'danger' : item.utilization > 75 ? 'warning' : ''}`;
                        }
                        
                        if (utilizationText) {
                            utilizationText.textContent = `使用率: ${item.utilization}% (${item.usedPositions}/${item.totalPositions})`;
                        }
                    }
                });
            }
        }

        // AI預測功能
        async function loadForecastData() {
            const result = await callGAS('getForecastData');
            if (result && result.success) {
                updateForecastTable(result.data);
            }
        }

        async function runForecast() {
            const forecastParams = {
                modelVersion: document.getElementById('modelVersion').value,
                trainingWindow: parseInt(document.getElementById('trainingWindow').value),
                confidenceInterval: parseFloat(document.getElementById('confidenceInterval').value)
            };

            const result = await callGAS('runForecast', forecastParams);
            if (result && result.success) {
                showNotification('AI預測執行完成', 'success');
                loadForecastData();
                document.getElementById('mapeValue').value = result.data.mape + '%';
            }
        }

        async function retrainModel() {
            const result = await callGAS('retrainModel');
            if (result && result.success) {
                showNotification('模型重新訓練完成', 'success');
                loadForecastData();
            }
        }

        async function validateForecast() {
            const result = await callGAS('validateForecast');
            if (result && result.success) {
                showNotification('預測驗證完成', 'success');
            }
        }

        async function exportForecast() {
            const result = await callGAS('exportForecast');
            if (result && result.success) {
                const link = document.createElement('a');
                link.href = result.data.downloadUrl;
                link.download = `AI預測結果_${new Date().toISOString().split('T')[0]}.xlsx`;
                link.click();
                showNotification('預測結果匯出完成', 'success');
            }
        }

        function updateForecastTable(data) {
            const tbody = document.querySelector('#forecastTable tbody');
            tbody.innerHTML = '';
            
            if (data && data.length > 0) {
                data.forEach(item => {
                    const row = tbody.insertRow();
                    const accuracyClass = item.accuracy > 95 ? 'active' : item.accuracy > 90 ? 'warning' : 'danger';
                    
                    row.innerHTML = `
                        <td>${item.skuCode}</td>
                        <td>${item.skuName}</td>
                        <td>${item.historicalDemand}</td>
                        <td>${item.forecastDemand}</td>
                        <td><span class="status-badge ${accuracyClass}">${item.accuracy}%</span></td>
                        <td>${item.confidenceInterval}</td>
                        <td><span class="status-badge ${item.riskLevel}">${getRiskLevelText(item.riskLevel)}</span></td>
                        <td>
                            <button class="btn btn-primary" onclick="viewForecastDetail('${item.id}')">詳情</button>
                        </td>
                    `;
                });
            }
        }

        // 安全庫存功能
        async function loadSafetyStockData() {
            const result = await callGAS('getSafetyStockData');
            if (result && result.success) {
                updateSafetyStockTable(result.data);
            }
        }

        async function runScenarioAnalysis() {
            const result = await callGAS('runScenarioAnalysis');
            if (result && result.success) {
                showNotification('情境分析完成', 'success');
                loadSafetyStockData();
            }
        }

        async function optimizeParameters() {
            const result = await callGAS('optimizeParameters');
            if (result && result.success) {
                showNotification('參數優化完成', 'success');
                loadSafetyStockData();
            }
        }

        function updateSafetyStockTable(data) {
            const tbody = document.querySelector('#safetyStockTable tbody');
            tbody.innerHTML = '';
            
            if (data && data.length > 0) {
                data.forEach(item => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${item.skuCode}</td>
                        <td>${item.customerLevel}</td>
                        <td>${item.avgDemand}</td>
                        <td>${item.demandStd}</td>
                        <td>${item.zValue}</td>
                        <td>${item.safetyStock}</td>
                        <td>${item.targetStock}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editSafetyStock('${item.id}')">編輯</button>
                        </td>
                    `;
                });
            }
        }

        // 庫存建議功能
        async function loadRecommendationData() {
            const result = await callGAS('getRecommendationData');
            if (result && result.success) {
                updateRecommendationTable(result.data);
            }
        }

        async function runCapacityCheck() {
            const result = await callGAS('runCapacityCheck');
            if (result && result.success) {
                showNotification('容量校核完成', 'success');
                loadRecommendationData();
            }
        }

        async function runSimulation() {
            const result = await callGAS('runSimulation');
            if (result && result.success) {
                showNotification('情境模擬完成', 'success');
                loadRecommendationData();
            }
        }

        async function sendToCustomer() {
            const result = await callGAS('sendToCustomer');
            if (result && result.success) {
                showNotification('建議已發送給客戶確認', 'success');
            }
        }

        function updateRecommendationTable(data) {
            const tbody = document.querySelector('#recommendationTable tbody');
            tbody.innerHTML = '';
            
            if (data && data.length > 0) {
                data.forEach(item => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${item.skuCode}</td>
                        <td>${item.customer}</td>
                        <td>${item.warehouse}</td>
                        <td>${item.currentStock}</td>
                        <td>${item.safetyStock}</td>
                        <td>${item.targetStock}</td>
                        <td>${item.recommendedQty}</td>
                        <td>${item.palletPositions}</td>
                        <td>${item.shelfLifeDays}</td>
                        <td><span class="status-badge ${item.riskLevel}">${item.riskTags}</span></td>
                        <td>
                            <button class="btn btn-primary" onclick="approveRecommendation('${item.id}')">核准</button>
                            <button class="btn btn-warning" onclick="adjustRecommendation('${item.id}')">調整</button>
                        </td>
                    `;
                });
            }
        }

        // 補單管理功能
        async function loadReplenishmentData() {
            const result = await callGAS('getReplenishmentData');
            if (result && result.success) {
                updateReplenishmentTable(result.data);
            }
        }

        async function createReplenishmentOrder() {
            const orderData = {
                supplier: document.getElementById('supplier').value,
                expectedDelivery: document.getElementById('expectedDelivery').value,
                vehicleType: document.getElementById('vehicleType').value
            };

            if (!orderData.supplier || !orderData.expectedDelivery) {
                alert('請填寫必要欄位');
                return;
            }

            const result = await callGAS('createReplenishmentOrder', orderData);
            if (result && result.success) {
                showNotification('補單已建立', 'success');
                document.getElementById('replenishmentId').value = result.data.orderId;
                loadReplenishmentData();
            }
        }

        async function publishOrder() {
            const result = await callGAS('publishOrder');
            if (result && result.success) {
                showNotification('補單已發佈', 'success');
                loadReplenishmentData();
            }
        }

        async function generateWaveTask() {
            const result = await callGAS('generateWaveTask');
            if (result && result.success) {
                showNotification('入庫波次已產生', 'success');
            }
        }

        async function notifySupplier() {
            const result = await callGAS('notifySupplier');
            if (result && result.success) {
                showNotification('供應商通知已發送', 'success');
            }
        }

        function updateReplenishmentTable(data) {
            const tbody = document.querySelector('#replenishmentTable tbody');
            tbody.innerHTML = '';
            
            if (data && data.length > 0) {
                data.forEach(item => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${item.orderId}</td>
                        <td>${item.supplier}</td>
                        <td>${item.skuCount}</td>
                        <td>${item.totalQty}</td>
                        <td>${item.expectedDelivery}</td>
                        <td>${item.vehicleType}</td>
                        <td><span class="status-badge ${item.status}">${getStatusText(item.status)}</span></td>
                        <td>${item.createTime}</td>
                        <td>
                            <button class="btn btn-primary" onclick="viewOrder('${item.id}')">檢視</button>
                            <button class="btn btn-warning" onclick="editOrder('${item.id}')">編輯</button>
                        </td>
                    `;
                });
            }
        }

        // 監控告警功能
        async function loadMonitoringData() {
            const result = await callGAS('getMonitoringData');
            if (result && result.success) {
                updateMonitoringTable(result.data);
            }
        }

        async function refreshMonitoring() {
            loadMonitoringData();
            showNotification('監控資料已更新', 'success');
        }

        async function generateFEFOList() {
            const result = await callGAS('generateFEFOList');
            if (result && result.success) {
                showNotification('FEFO清單已產生', 'success');
            }
        }

        async function checkTemperature() {
            const result = await callGAS('checkTemperature');
            if (result && result.success) {
                showNotification('溫度檢查完成', 'success');
                loadMonitoringData();
            }
        }

        async function exportAlerts() {
            const result = await callGAS('exportAlerts');
            if (result && result.success) {
                const link = document.createElement('a');
                link.href = result.data.downloadUrl;
                link.download = `告警報表_${new Date().toISOString().split('T')[0]}.xlsx`;
                link.click();
                showNotification('告警報表匯出完成', 'success');
            }
        }

        // 告警處理功能
        async function handleTemperatureAlert() {
            const result = await callGAS('handleTemperatureAlert');
            if (result && result.success) {
                showNotification('溫度異常處理完成', 'success');
                loadMonitoringData();
            }
        }

                async function createFEFOTask() {
            const result = await callGAS('createFEFOTask');
            if (result && result.success) {
                showNotification('FEFO任務已建立', 'success');
                loadMonitoringData();
            }
        }

        async function contactSupplier() {
            const result = await callGAS('contactSupplier');
            if (result && result.success) {
                showNotification('已聯絡供應商', 'success');
            }
        }

        async function emergencyReplenishment() {
            const result = await callGAS('emergencyReplenishment');
            if (result && result.success) {
                showNotification('緊急補貨已啟動', 'success');
                showTab('replenishment');
            }
        }

        function updateMonitoringTable(data) {
            const tbody = document.querySelector('#monitoringTable tbody');
            tbody.innerHTML = '';
            
            if (data && data.length > 0) {
                data.forEach(item => {
                    const row = tbody.insertRow();
                    const severityClass = item.severity === 'high' ? 'danger' : item.severity === 'medium' ? 'warning' : 'active';
                    
                    row.innerHTML = `
                        <td>${getAlertTypeText(item.alertType)}</td>
                        <td>${item.target}</td>
                        <td>${item.description}</td>
                        <td><span class="status-badge ${severityClass}">${getSeverityText(item.severity)}</span></td>
                        <td>${item.occurTime}</td>
                        <td><span class="status-badge ${item.status}">${getStatusText(item.status)}</span></td>
                        <td>${item.assignee}</td>
                        <td>
                            <button class="btn btn-primary" onclick="handleAlert('${item.id}')">處理</button>
                            <button class="btn btn-warning" onclick="assignAlert('${item.id}')">指派</button>
                        </td>
                    `;
                });
            }
        }

        // 通用工具函數
        function getStatusText(status) {
            const statusMap = {
                'active': '正常',
                'warning': '警告',
                'danger': '異常',
                'pending': '待處理',
                'processing': '處理中',
                'completed': '已完成',
                'cancelled': '已取消'
            };
            return statusMap[status] || status;
        }

        function getTemperatureZoneText(zone) {
            const zoneMap = {
                'frozen': '冷凍 (-18°C)',
                'chilled': '冷藏 (0-4°C)',
                'ambient': '常溫'
            };
            return zoneMap[zone] || zone;
        }

        function getRiskLevelText(level) {
            const levelMap = {
                'low': '低風險',
                'medium': '中風險',
                'high': '高風險'
            };
            return levelMap[level] || level;
        }

        function getAlertTypeText(type) {
            const typeMap = {
                'temperature': '溫度異常',
                'expiry': '效期預警',
                'stockout': '缺貨預警',
                'capacity': '容量異常',
                'delay': '延遲告警'
            };
            return typeMap[type] || type;
        }

        function getSeverityText(severity) {
            const severityMap = {
                'low': '低',
                'medium': '中',
                'high': '高'
            };
            return severityMap[severity] || severity;
        }

        // 通知功能
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#d4edda' : type === 'warning' ? '#fff3cd' : type === 'danger' ? '#f8d7da' : '#d1ecf1'};
                color: ${type === 'success' ? '#155724' : type === 'warning' ? '#856404' : type === 'danger' ? '#721c24' : '#0c5460'};
                border: 1px solid ${type === 'success' ? '#c3e6cb' : type === 'warning' ? '#ffeaa7' : type === 'danger' ? '#f5c6cb' : '#bee5eb'};
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                z-index: 10000;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // 編輯功能
        async function editCustomerDemand(id) {
            const result = await callGAS('getCustomerDemandById', {id: id});
            if (result && result.success) {
                const data = result.data;
                document.getElementById('customerSelect').value = data.customer;
                document.getElementById('serviceLevel').value = data.serviceLevel;
                document.getElementById('itemList').value = data.itemList;
                
                // 將儲存按鈕改為更新按鈕
                const saveBtn = document.querySelector('[onclick="saveCustomerDemand()"]');
                saveBtn.textContent = '更新需求';
                saveBtn.setAttribute('onclick', `updateCustomerDemand('${id}')`);
            }
        }

        async function updateCustomerDemand(id) {
            const customerData = {
                id: id,
                customer: document.getElementById('customerSelect').value,
                serviceLevel: document.getElementById('serviceLevel').value,
                itemList: document.getElementById('itemList').value
            };

            const result = await callGAS('updateCustomerDemand', customerData);
            if (result && result.success) {
                showNotification('客戶需求已更新', 'success');
                loadCustomerData();
                clearCustomerForm();
                
                // 恢復儲存按鈕
                const updateBtn = document.querySelector('[onclick^="updateCustomerDemand"]');
                updateBtn.textContent = '儲存需求';
                updateBtn.setAttribute('onclick', 'saveCustomerDemand()');
            }
        }

        async function deleteCustomerDemand(id) {
            if (confirm('確定要刪除此客戶需求嗎？')) {
                const result = await callGAS('deleteCustomerDemand', {id: id});
                if (result && result.success) {
                    showNotification('客戶需求已刪除', 'success');
                    loadCustomerData();
                }
            }
        }

        // 其他編輯功能類似實作
        async function editProject(id) {
            // 實作專案編輯功能
            showNotification('專案編輯功能開發中', 'info');
        }

        async function deleteProject(id) {
            if (confirm('確定要刪除此專案嗎？')) {
                const result = await callGAS('deleteProject', {id: id});
                if (result && result.success) {
                    showNotification('專案已刪除', 'success');
                    loadProjectData();
                }
            }
        }

        async function editSKU(id) {
            // 實作SKU編輯功能
            showNotification('SKU編輯功能開發中', 'info');
        }

        async function deleteSKU(id) {
            if (confirm('確定要刪除此SKU嗎？')) {
                const result = await callGAS('deleteSKU', {id: id});
                if (result && result.success) {
                    showNotification('SKU已刪除', 'success');
                    loadSKUData();
                }
            }
        }

        async function editWarehouse(id) {
            // 實作倉庫編輯功能
            showNotification('倉庫編輯功能開發中', 'info');
        }

        async function adjustCapacity(id) {
            // 實作容量調整功能
            showNotification('容量調整功能開發中', 'info');
        }

        async function viewForecastDetail(id) {
            // 實作預測詳情檢視功能
            showNotification('預測詳情功能開發中', 'info');
        }

        async function editSafetyStock(id) {
            // 實作安全庫存編輯功能
            showNotification('安全庫存編輯功能開發中', 'info');
        }

        async function approveRecommendation(id) {
            const result = await callGAS('approveRecommendation', {id: id});
            if (result && result.success) {
                showNotification('建議已核准', 'success');
                loadRecommendationData();
            }
        }

        async function adjustRecommendation(id) {
            // 實作建議調整功能
            showNotification('建議調整功能開發中', 'info');
        }

        async function viewOrder(id) {
            // 實作訂單檢視功能
            showNotification('訂單檢視功能開發中', 'info');
        }

        async function editOrder(id) {
            // 實作訂單編輯功能
            showNotification('訂單編輯功能開發中', 'info');
        }

        async function handleAlert(id) {
            const result = await callGAS('handleAlert', {id: id});
            if (result && result.success) {
                showNotification('告警已處理', 'success');
                loadMonitoringData();
            }
        }

        async function assignAlert(id) {
            // 實作告警指派功能
            showNotification('告警指派功能開發中', 'info');
        }

        // CSS動畫
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // 鍵盤快捷鍵
        document.addEventListener('keydown', function(e) {
            // Ctrl + R: 重新整理當前頁面
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab) {
                    const tabName = activeTab.id;
                    loadTabData(tabName);
                    showNotification('頁面已重新整理', 'success');
                }
            }
            
            // Ctrl + S: 儲存當前表單
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab) {
                    const tabName = activeTab.id;
                    switch(tabName) {
                        case 'customer':
                            saveCustomerDemand();
                            break;
                        case 'project':
                            saveProject();
                            break;
                        case 'sku':
                            saveSKU();
                            break;
                    }
                }
            }
        });

        // 頁面可見性變化時重新載入資料
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab && activeTab.id === 'dashboard') {
                    loadDashboardData();
                }
            }
        });

        // 響應式設計處理
        function handleResize() {
            const container = document.querySelector('.container');
            if (window.innerWidth < 768) {
                container.classList.add('mobile');
            } else {
                container.classList.remove('mobile');
            }
        }

        window.addEventListener('resize', handleResize);
        handleResize(); // 初始執行

        // 表單驗證
        function validateForm(formData, requiredFields) {
            const errors = [];
            
            requiredFields.forEach(field => {
                if (!formData[field] || formData[field].toString().trim() === '') {
                    errors.push(`${field} 為必填欄位`);
                }
            });
            
            return errors;
        }

        // 資料格式化
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW');
        }

        function formatNumber(number, decimals = 0) {
            if (number === null || number === undefined) return '';
            return Number(number).toFixed(decimals);
        }

        function formatCurrency(amount) {
            if (!amount) return '';
            return new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: 'TWD'
            }).format(amount);
        }

        // 本地儲存功能
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error('儲存到本地儲存失敗:', error);
            }
        }

        function loadFromLocalStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('從本地儲存載入失敗:', error);
                return null;
            }
        }

        // 匯出功能
        function exportTableToCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const rows = table.querySelectorAll('tr');
            const csvContent = [];
            
            rows.forEach(row => {
                const cols = row.querySelectorAll('th, td');
                const rowData = [];
                cols.forEach(col => {
                    rowData.push(col.textContent.trim());
                });
                csvContent.push(rowData.join(','));
            });
            
            const blob = new Blob([csvContent.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename || 'export.csv';
            link.click();
        }

        // 列印功能
        function printTable(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>列印報表</title>
                    <style>
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    <h2>GAI寄庫庫存量水位補單系統 - 報表</h2>
                    ${table.outerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // 搜尋功能
        function searchTable(tableId, searchTerm) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr');
            const term = searchTerm.toLowerCase();
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(term)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // 排序功能
        function sortTable(tableId, columnIndex, ascending = true) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                const aText = a.cells[columnIndex].textContent.trim();
                const bText = b.cells[columnIndex].textContent.trim();
                
                // 嘗試數字比較
                const aNum = parseFloat(aText);
                const bNum = parseFloat(bText);
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return ascending ? aNum - bNum : bNum - aNum;
                }
                
                // 文字比較
                return ascending ? aText.localeCompare(bText) : bText.localeCompare(aText);
            });
            
            // 重新插入排序後的行
            rows.forEach(row => tbody.appendChild(row));
        }

        // 批次操作
        function selectAllRows(tableId, checked) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const checkboxes = table.querySelectorAll('tbody input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = checked;
            });
        }

        function getSelectedRows(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return [];
            
            const selectedRows = [];
            const checkboxes = table.querySelectorAll('tbody input[type="checkbox"]:checked');
            
            checkboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                if (row) {
                    selectedRows.push(row);
                }
            });
            
            return selectedRows;
        }

        // 系統狀態檢查
        async function checkSystemStatus() {
            try {
                const result = await callGAS('checkSystemStatus');
                if (result && result.success) {
                    updateSystemStatus(result.data);
                }
            } catch (error) {
                console.error('系統狀態檢查失敗:', error);
            }
        }

        function updateSystemStatus(statusData) {
            // 更新系統狀態顯示
            const statusIndicator = document.querySelector('.system-status');
            if (statusIndicator && statusData) {
                statusIndicator.className = `system-status ${statusData.status}`;
                statusIndicator.textContent = statusData.message;
            }
        }

        // 定期檢查系統狀態
        setInterval(checkSystemStatus, 60000); // 每分鐘檢查一次

        console.log('GAI寄庫庫存量水位補單系統前端載入完成');
    </script>
</body>
</html>
